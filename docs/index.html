<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartOS Pro Ultra Â· è‡ªå®šä¹‰ä¸»é¢˜è‰²</title>
   <style>
/* ====== ğŸŒ¸ æç®€ä¾¿ç­¾Â·ç»Ÿä¸€ä¸»é¢˜è‰² ====== */
:root {
    /* ä¸»è‰² â€”â€” ä½ ä¾ç„¶å¯ä»¥åœ¨è®¾ç½®é‡Œæ”¹å®ƒï¼Œé»˜è®¤æ˜¯æ·¡è“ */
    --theme-primary: #AED5F3 !important;
    --theme-soft-bg: rgba(174, 213, 243, 0.1);

    /* ä¾¿ç­¾å›ºå®šè‰² */
    --note-bg-light: #F9F9F9;
    --note-bg-white: #FFFFFF;
    --note-accent: #AED5F3;
    --note-pearl: #F5F0E6;
    --note-hover: #F5F5F5;
    --note-text-dark: #222222;
    --note-text-gray: #8E8E93;
    --note-border: #E5E5E5;
    --note-shadow-light: rgba(0, 0, 0, 0.05);
    --note-shadow-dark: rgba(0, 0, 0, 0.1);
    --note-radius-soft: 12px;
    --note-radius-hard: 8px;
    --note-spacing: 12px;
    --note-transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);

    /* è¦†ç›–åŸå¾®ä¿¡ç»¿ç­‰ */
    --wechat-green: var(--theme-primary) !important;
    --ios-blue: var(--theme-primary) !important;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "PingFang SC", "Helvetica Neue", -apple-system, sans-serif !important;
}

body {
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
}

.app-container {
    width: 100%;
    height: 100%;
    background: var(--note-bg-light) !important;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

@media (min-width: 600px) {
    .app-container {
        max-width: 375px;
        height: 812px;
        border-radius: 40px;
        border: 8px solid #333;
    }
}

/* ----- çŠ¶æ€æ  & å¯¼èˆªï¼ˆä¾¿ç­¾ç™½å¡ç‰‡ï¼‰----- */
.status-bar {
    height: 44px;
    padding: 14px 20px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    z-index: 1000;
    position: absolute;
    top: 0;
    width: 100%;
    color: var(--note-text-dark) !important;
}

.nav-bar {
    height: 50px;
    background: var(--note-bg-white) !important;
    backdrop-filter: none;
    border: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-soft) !important;
    box-shadow: 0 1px 3px var(--note-shadow-light) !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    flex-shrink: 0;
    margin: var(--note-spacing) var(--note-spacing) 0 !important;
    width: calc(100% - 24px);
}

.nav-bar span,
.nav-bar b {
    color: var(--note-text-dark) !important;
}

.nav-bar span[style*="color:var(--ios-blue)"] {
    color: var(--theme-primary) !important;
}

/* ----- é¡µé¢å®¹å™¨ ----- */
.page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--note-bg-light) !important;
    display: none;
    flex-direction: column;
    z-index: 10;
    padding-top: 44px;
}
.page.active { display: flex; }

/* ----- æ¡Œé¢ï¼ˆå£çº¸èƒŒæ™¯ï¼‰----- */
.home-bg {
    transition: background 0.8s ease;
    background-size: cover !important;
    background-position: center !important;
}
.home-clock {
    text-align: center;
    padding: 30px 0;
    color: var(--note-text-dark) !important;
}
.home-clock h1 {
    font-size: 64px;
    font-weight: 200;
    letter-spacing: -2px;
}
.app-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    padding: 20px 25px;
}
.app-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: transform 0.1s;
}
.app-item:active { transform: scale(0.9); }
.app-icon {
    width: 60px;
    height: 60px;
    background: var(--note-bg-white) !important;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    backdrop-filter: none;
    border: 1px solid var(--note-border) !important;
    box-shadow: 0 2px 4px var(--note-shadow-light) !important;
    color: var(--note-text-dark) !important;
}
.app-name {
    font-size: 11px;
    margin-top: 8px;
    font-weight: 500;
    color: var(--note-text-dark) !important;
}

/* ----- ç›¸å†Œï¼ˆå¡ç‰‡ç½‘æ ¼ï¼‰----- */
#album-box {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2px;
    padding: 2px 0;
    overflow-y: auto;
    flex: 1;
    background: var(--note-bg-light) !important;
}
#album-box div {
    aspect-ratio: 1/1;
    background-size: cover;
    background-position: center;
    transition: opacity 0.2s;
    border: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-hard) !important;
}
#album-box div:active { opacity: 0.7; }

/* ----- æ—¥å†ï¼ˆä¾¿ç­¾å¡ç‰‡ï¼‰----- */
.cal-header {
    background: var(--note-bg-white) !important;
    padding: 15px;
    text-align: center;
    border-bottom: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-soft) var(--note-radius-soft) 0 0 !important;
    margin: var(--note-spacing) var(--note-spacing) 0 !important;
    width: calc(100% - 24px);
}
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: var(--note-bg-white) !important;
    padding: 10px;
    border: 1px solid var(--note-border) !important;
    border-top: none;
    border-radius: 0 0 var(--note-radius-soft) var(--note-radius-soft) !important;
    margin: 0 var(--note-spacing) var(--note-spacing) !important;
    width: calc(100% - 24px);
    box-shadow: 0 1px 3px var(--note-shadow-light) !important;
}
.cal-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    position: relative;
    color: var(--note-text-dark) !important;
}
.cal-day.today {
    background: var(--theme-primary) !important;
    color: #fff !important;
    border-radius: 50%;
}
.cal-day.has-event::after {
    content: '';
    width: 4px;
    height: 4px;
    background: var(--note-text-gray) !important;
    border-radius: 50%;
    position: absolute;
    bottom: 4px;
}
.cal-weekday {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--note-text-gray) !important;
    font-weight: 600;
}

/* ----- é€šè®¯å½• & çºªå¿µæ—¥åˆ—è¡¨ï¼ˆå¡ç‰‡ï¼‰----- */
.list-item {
    padding: 15px;
    border-bottom: 1px solid var(--note-border) !important;
    background: var(--note-bg-white) !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 16px;
    color: var(--note-text-dark) !important;
    border-radius: var(--note-radius-soft) !important;
    margin: 8px var(--note-spacing) !important;
    width: calc(100% - 24px);
    box-shadow: 0 1px 3px var(--note-shadow-light) !important;
}
.del-text {
    color: var(--note-text-gray) !important;
    font-size: 14px;
    font-weight: 500;
    padding: 5px;
}

/* ----- èŠå¤©åŒºåŸŸï¼ˆçº¯ç™½æ°”æ³¡ï¼‰----- */
#chat-flow {
    flex: 1;
    overflow-y: auto;
    background: var(--note-bg-light) !important;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.msg-row {
    display: flex;
    gap: 10px;
    max-width: 85%;
}
.msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }

/* æ°”æ³¡ç»Ÿä¸€çº¯ç™½ + ä¾¿ç­¾æ¯›è¾¹ */
.msg-row.other .bubble,
.msg-row.mine .bubble {
    background: var(--note-bg-white) !important;
    color: var(--note-text-dark) !important;
    border: 1px solid var(--note-border) !important;
    box-shadow: 0 2px 4px var(--note-shadow-light) !important;
    padding: 14px 18px !important;
    position: relative;
    border-radius: 8px 8px 12px 8px !important;
}

/* å¯¹æ–¹æ°”æ³¡æ¢¯å½¢ï¼ˆå·¦çª„å³å®½ï¼‰ */
.msg-row.other .bubble {
    transform: perspective(100px) rotateY(1deg);
}
/* è‡ªå·±æ°”æ³¡æ¢¯å½¢ï¼ˆå³çª„å·¦å®½ï¼‰ */
.msg-row.mine .bubble {
    transform: perspective(100px) rotateY(-1deg);
    border-radius: 8px 8px 8px 12px !important;
}

/* æ¯›è¾¹çº¹ç†ï¼ˆå…±ç”¨ï¼‰ */
.msg-row.other .bubble::after,
.msg-row.mine .bubble::after {
    content: "";
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0L10 0L10 10L0 10Z' fill='%23F8F8F8' fill-opacity='0.1'/%3E%3C/svg%3E");
    background-size: 20px 20px;
    pointer-events: none;
    border-radius: inherit;
}

/* å¯¹æ–¹æ°”æ³¡è£…é¥°ï¼ˆå°é›ªèŠ±ï¼‰ */
.msg-row.other .bubble::before {
    content: "";
    position: absolute;
    top: 12px;
    left: 15px;
    width: 14px;
    height: 14px;
    background: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 14 14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 0L8 3L10 3L9 5L11 7L9 7L8 9L7 7L5 7L7 5L6 3L8 3L7 0Z' fill='%23AED5F3' fill-opacity='0.8'/%3E%3C/svg%3E") center no-repeat;
}

/* è‡ªå·±æ°”æ³¡è£…é¥°ï¼ˆå°çˆ±å¿ƒï¼‰ */
.msg-row.mine .bubble::before {
    content: "";
    position: absolute;
    top: 12px;
    right: 15px;
    width: 14px;
    height: 14px;
    background: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 14 14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 5L9 3L11 5L10 7L12 9L10 11L8 9L7 11L5 9L3 11L1 9L3 7L2 5L4 3L6 5Z' fill='%23F5F0E6' fill-opacity='0.8'/%3E%3C/svg%3E") center no-repeat;
}

/* æ¶ˆæ¯æ—¶é—´ */
.msg-time {
    font-size: 10px;
    color: var(--note-text-gray) !important;
    margin-top: 4px;
    text-align: right;
    display: block;
}

/* ----- å¤§å›¾æŸ¥çœ‹å™¨ï¼ˆä¸å˜ï¼‰----- */
#viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 2000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#viewer img {
    max-width: 100%;
    max-height: 85%;
    object-fit: contain;
}
.viewer-btns {
    position: absolute;
    bottom: 60px;
    display: flex;
    gap: 20px;
    z-index: 2001;
}
.v-btn {
    padding: 12px 25px;
    border-radius: 25px;
    background: rgba(255,255,255,0.25);
    color: #fff;
    border: none;
    backdrop-filter: blur(15px);
    font-size: 14px;
}

/* ----- å¼¹çª—ï¼ˆä¾¿ç­¾å¡ç‰‡ï¼‰----- */
.modal {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 1500;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}
.modal-body {
    width: 85%;
    background: var(--note-bg-white) !important;
    border: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-soft) !important;
    padding: 25px;
    box-shadow: 0 4px 12px var(--note-shadow-dark) !important;
}
.modal-body h3 {
    margin-bottom: 10px;
    color: var(--note-text-dark) !important;
}
.modal-body input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-hard) !important;
    outline: none;
    font-size: 16px;
    background: var(--note-bg-white) !important;
}
.modal-btn {
    width: 100%;
    padding: 14px;
    background: var(--theme-primary) !important;
    color: #fff !important;
    border: none !important;
    border-radius: var(--note-radius-hard) !important;
    margin-top: 10px;
    font-weight: 600;
    cursor: pointer;
}
.modal-cancel {
    width: 100%;
    background: none;
    border: none;
    margin-top: 10px;
    color: var(--note-text-gray) !important;
    cursor: pointer;
}

/* ----- ä¸»é¢˜è‰²é€‰æ‹©å™¨ï¼ˆä¿ç•™ï¼‰----- */
.theme-color-option {
    display: inline-block;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 5px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: border 0.2s;
}
.theme-color-option.active {
    border: 3px solid #333;
}
.theme-color-picker {
    margin: 15px 0 5px;
}

/* ----- å…¶ä»–å¾®è°ƒ ----- */
#chat-in {
    background: var(--note-bg-white) !important;
    border: 1px solid var(--note-border) !important;
    border-radius: var(--note-radius-hard) !important;
    padding: 12px !important;
}
#send-btn {
    background: var(--theme-primary) !important;
    color: white !important;
    border: none !important;
    border-radius: var(--note-radius-hard) !important;
    padding: 0 15px;
    font-size: 14px;
}
iframe {
    border: none !important;
    background: var(--note-bg-white) !important;
    border-radius: var(--note-radius-soft) !important;
    margin: var(--note-spacing);
    width: calc(100% - 24px);
    height: calc(100% - 88px);
}
</style>
</head>
<body>
<div class="app-container">
    <div class="status-bar" id="status-bar">
        <span id="st-time">00:00</span>
        <div>ğŸ“¶ ğŸ”‹</div>
    </div>

    <!-- æ¡Œé¢ï¼ˆæ— å†…è”onclickï¼‰ -->
    <div class="page active home-bg" id="p-home">
        <div class="home-clock">
            <h1 id="big-clock">00:00</h1>
            <p id="big-date" style="opacity:0.8"></p>
        </div>
        <div class="app-grid">
            <div class="app-item" data-page="p-chat"><div class="app-icon">ğŸ’¬</div><div class="app-name">å¾®ä¿¡</div></div>
            <div class="app-item" data-page="p-album"><div class="app-icon">ğŸ–¼ï¸</div><div class="app-name">ç›¸å†Œ</div></div>
            <div class="app-item" data-page="p-cal"><div class="app-icon">ğŸ“…</div><div class="app-name">æ—¥å†</div></div>
            <div class="app-item" data-page="p-con"><div class="app-icon">ğŸ‘¥</div><div class="app-name">é€šè®¯å½•</div></div>
            <div class="app-item" data-page="p-safari"><div class="app-icon">ğŸŒ</div><div class="app-name">Safari</div></div>
        </div>
    </div>

    <!-- èŠå¤© -->
    <div class="page" id="p-chat">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b id="chat-title">è¯·é€‰æ‹©è”ç³»äºº</b>
            <span class="nav-setting" data-mod="m-api" style="color:var(--ios-blue); font-size:13px;">è®¾ç½®</span>
        </div>
        <div id="chat-flow"></div>
        <div style="padding:10px; background:#f7f7f7; display:flex; gap:10px; padding-bottom: 25px;">
            <input type="text" id="chat-in" placeholder="ç”¨å›è½¦å‘é€..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button id="send-btn" style="background:var(--theme-primary); color:#fff; border:none; padding:0 15px; border-radius:8px;">å‘é€</button>
        </div>
    </div>

    <!-- ç›¸å†Œï¼ˆå¤§å®¹é‡ç‰ˆï¼‰ -->
    <div class="page" id="p-album">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ‰€æœ‰ç…§ç‰‡</b>
            <span id="upload-trigger" style="color:var(--ios-blue)">ä¸Šä¼ </span>
        </div>
        <input type="file" id="up" hidden multiple accept="image/*">
        <div id="album-box"></div>
    </div>

    <!-- æ—¥å† -->
    <div class="page" id="p-cal">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ—¥å†</b>
            <span class="nav-add" data-mod="m-anni" style="color:var(--ios-blue)">æ·»åŠ </span>
        </div>
        <div class="cal-header"><h3 id="cal-month"></h3></div>
        <div class="cal-grid" id="cal-body"></div>
        <div id="anni-list" style="flex:1; overflow-y:auto; background:#fff;"></div>
    </div>

    <!-- é€šè®¯å½• -->
    <div class="page" id="p-con">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>é€šè®¯å½•</b>
            <span class="nav-add" data-mod="m-con" style="color:var(--ios-blue)">â•</span>
        </div>
        <div id="con-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- Safari -->
    <div class="page" id="p-safari">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b>æµè§ˆå™¨</b>
        </div>
        <iframe src="https://m.bing.com" style="flex:1; border:none;"></iframe>
    </div>

    <!-- å¤§å›¾æŸ¥çœ‹å™¨ -->
    <div id="viewer" onclick="closeViewer()">
        <img id="v-img" src="" onclick="event.stopPropagation()">
        <div class="viewer-btns" onclick="event.stopPropagation()">
            <button class="v-btn" id="set-wallpaper-btn">è®¾ä¸ºå£çº¸</button>
            <button class="v-btn" id="close-viewer-btn">è¿”å›</button>
        </div>
    </div>

    <!-- ========== AIè®¾ç½® + ä¸»é¢˜é¢œè‰²ï¼ˆåˆå¹¶åœ¨ä¸€ä¸ªå¼¹çª—ï¼‰ ========== -->
    <div class="modal" id="m-api">
        <div class="modal-body">
            <h3>âš™ï¸ è®¾ç½®ä¸ä¸»é¢˜</h3>
            
            <!-- AI é…ç½®åŒºåŸŸ -->
            <label style="display:block; margin-bottom:8px;">
                <input type="checkbox" id="api-toggle"> å¼€å¯ AI å“åº”
            </label>
            <input type="text" id="api-url" placeholder="API URL (å« v1/chat/completions)">
            <input type="password" id="api-key" placeholder="API Key">
            
            <!-- ä¸»é¢˜é¢œè‰²é€‰æ‹©å™¨ -->
            <div style="margin: 20px 0 10px; border-top:1px solid #eee; padding-top:15px;">
                <h4 style="margin-bottom:10px;">ğŸ¨ ä¸»é¢˜é¢œè‰²</h4>
                <div id="theme-color-presets" class="theme-color-picker">
                    <!-- é¢„è®¾é¢œè‰²å—ï¼ŒåŠ¨æ€ç”Ÿæˆæˆ–ç›´æ¥å†™æ­» -->
                    <div class="theme-color-option" style="background:#007AFF;" data-color="#007AFF" title="ç»å…¸è“"></div>
                    <div class="theme-color-option" style="background:#5856D6;" data-color="#5856D6" title="ç´«è‰²"></div>
                    <div class="theme-color-option" style="background:#FF2D55;" data-color="#FF2D55" title="ç²‰è‰²"></div>
                    <div class="theme-color-option" style="background:#FF9500;" data-color="#FF9500" title="æ©™è‰²"></div>
                    <div class="theme-color-option" style="background:#34C759;" data-color="#34C759" title="ç»¿è‰²"></div>
                    <div class="theme-color-option" style="background:#8E8E93;" data-color="#8E8E93" title="ç°è‰²"></div>
                </div>
                <div style="display:flex; align-items:center; margin-top:10px;">
                    <span style="margin-right:8px;">è‡ªå®šä¹‰:</span>
                    <input type="color" id="custom-color-picker" value="#007AFF" style="width:50px; height:40px; border:none; background:transparent;">
                </div>
            </div>
            
            <button class="modal-btn" id="save-api-btn">ä¿å­˜è®¾ç½®</button>
            <button class="modal-cancel" data-mod="m-api" style="width:100%; background:none; border:none; margin-top:10px; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- å…¶ä»–å¼¹çª—ä¿æŒä¸å˜ -->
    <div class="modal" id="m-anni">
        <div class="modal-body">
            <h3>æ–°çºªå¿µæ—¥</h3>
            <input type="text" id="at" placeholder="äº‹é¡¹åç§°">
            <input type="date" id="ad">
            <button class="modal-btn" id="save-anni-btn">ä¿å­˜</button>
            <button class="modal-cancel" data-mod="m-anni" style="width:100%; background:none; border:none; margin-top:10px; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="modal" id="m-con">
        <div class="modal-body">
            <h3>æ–°è”ç³»äºº</h3>
            <input type="text" id="cn" placeholder="å§“å">
            <button class="modal-btn" id="save-con-btn">æ·»åŠ </button>
            <button class="modal-cancel" data-mod="m-con" style="width:100%; background:none; border:none; margin-top:10px; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // ==================== IndexedDB å›¾ç‰‡ä»“åº“ ====================
    let db;
    const DB_NAME = 'SmartOSDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'photos';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { autoIncrement: true });
                }
            };
        });
    }

    async function saveImageToDB(file) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.add(file);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getImageFromDB(id) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // ==================== æ•°æ®æŒä¹…åŒ– ====================
    let photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
    let annis = JSON.parse(localStorage.getItem('m_annis') || '[]');
    let cons = JSON.parse(localStorage.getItem('m_cons') || '[{"id":"init-001","name":"æœ¨æœ¨"}]');
    let apiCfg = JSON.parse(localStorage.getItem('m_api_cfg') || '{"enabled":false,"url":"","key":""}');
    
    // ---------- æ–°å¢ï¼šä¸»é¢˜è‰²å­˜å‚¨ ----------
    let themeColor = localStorage.getItem('m_theme_color') || '#007AFF'; // é»˜è®¤è“

    // å£çº¸å­˜å‚¨å›¾ç‰‡IDï¼Œæ°¸ä¹…æœ‰æ•ˆ
    let wallpaperId = localStorage.getItem('m_wallpaper_id');

    // ç‹¬ç«‹èŠå¤©è®°å½•ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    let messages = JSON.parse(localStorage.getItem('m_messages') || '{}');
    let currentChatContactId = null;

    // ==================== ä¸»é¢˜è‰²åº”ç”¨å‡½æ•° ====================
    function applyTheme(color) {
        // æ›´æ–°CSSå˜é‡ --theme-primary
        document.documentElement.style.setProperty('--theme-primary', color);
        // åŒæ—¶æ›´æ–° --ios-blueï¼ˆå¦‚æœæœ‰äº›åœ°æ–¹å†™æ­»äº†ï¼Œå¯ä¸€å¹¶æ›´æ–°ï¼‰
        document.documentElement.style.setProperty('--ios-blue', color);
        // æ›´æ–°è½¯èƒŒæ™¯è‰²ï¼ˆè§¦æ‘¸åé¦ˆç”¨ï¼‰
        const softBg = color + '1A'; // 10%é€æ˜åº¦
        document.documentElement.style.setProperty('--theme-soft-bg', softBg);
        
        // é«˜äº®å½“å‰é€‰ä¸­çš„é¢œè‰²å—ï¼ˆUIåé¦ˆï¼‰
        document.querySelectorAll('.theme-color-option').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.color === color) {
                el.classList.add('active');
            }
        });
        // æ›´æ–°é¢œè‰²é€‰æ‹©å™¨çš„å€¼
        const customPicker = document.getElementById('custom-color-picker');
        if (customPicker) customPicker.value = color;
    }

    // ==================== æ ¸å¿ƒè·¯ç”± ====================
    function to(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'p-cal') renderCalendar();
    }

    function openMod(id) {
        if (id === 'm-api') {
            // å›å¡«APIé…ç½®
            document.getElementById('api-toggle').checked = apiCfg.enabled;
            document.getElementById('api-url').value = apiCfg.url;
            document.getElementById('api-key').value = apiCfg.key;
            
            // å›å¡«ä¸»é¢˜è‰²è®¾ç½®ï¼ˆé«˜äº®å½“å‰é¢œè‰²ï¼‰
            applyTheme(themeColor); // è¿™ä¹Ÿä¼šæ›´æ–°UIé«˜äº®
        }
        document.getElementById(id).style.display = 'flex';
    }
    function closeMod(id) { document.getElementById(id).style.display = 'none'; }

    // ==================== æ¸²æŸ“æ‰€æœ‰åŠ¨æ€åˆ—è¡¨ ====================
    async function renderAll() {
        // ---------- ç›¸å†Œï¼ˆIndexedDBï¼‰----------
        const box = document.getElementById('album-box');
        box.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (const id of photos) {
            const div = document.createElement('div');
            div.dataset.imgId = id;
            div.className = 'album-thumb';
            try {
                const fileBlob = await getImageFromDB(id);
                const url = URL.createObjectURL(fileBlob);
                div.style.backgroundImage = `url(${url})`;
                div.dataset.blobUrl = url;
            } catch (e) {
                div.style.background = '#ccc';
            }
            fragment.appendChild(div);
        }
        box.appendChild(fragment);

        // ---------- çºªå¿µæ—¥ ----------
        const aList = document.getElementById('anni-list');
        aList.innerHTML = '';
        annis.sort((a, b) => new Date(a.d) - new Date(b.d));
        annis.forEach(a => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.anniId = a.id;
            const leftSpan = document.createElement('span');
            leftSpan.textContent = `ğŸ“… ${a.d} ${a.t}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(leftSpan);
            item.appendChild(delSpan);
            aList.appendChild(item);
        });

        // ---------- é€šè®¯å½• ----------
        const cList = document.getElementById('con-list');
        cList.innerHTML = '';
        cons.forEach(c => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.conId = c.id;
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `ğŸ‘¤ ${c.name}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(nameSpan);
            item.appendChild(delSpan);
            cList.appendChild(item);
        });
    }

    // ==================== ç›¸å†Œé€»è¾‘ ====================
    async function upImg(el) {
        const files = Array.from(el.files);
        for (const file of files) {
            if (file.size > 5 * 1024 * 1024) {
                alert(`å›¾ç‰‡ ${file.name} è¶…è¿‡ 5MBï¼Œè¯·å‹ç¼©åä¸Šä¼ `);
                continue;
            }
            const id = await saveImageToDB(file);
            photos.push(id);
        }
        localStorage.setItem('m_photos', JSON.stringify(photos));
        renderAll();
    }

    let currentImgId = null;
    let currentImgBlobUrl = null;

    async function viewImg(imgId) {
        try {
            const fileBlob = await getImageFromDB(parseInt(imgId));
            const url = URL.createObjectURL(fileBlob);
            if (currentImgBlobUrl) URL.revokeObjectURL(currentImgBlobUrl);
            currentImgBlobUrl = url;
            currentImgId = imgId;
            document.getElementById('v-img').src = url;
            document.getElementById('viewer').style.display = 'flex';
        } catch (e) {
            alert('å›¾ç‰‡åŠ è½½å¤±è´¥');
        }
    }

    function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

    async function setWallpaper() {
        if (!currentImgId) return;
        try {
            await getImageFromDB(parseInt(currentImgId));
            localStorage.setItem('m_wallpaper_id', currentImgId);
            wallpaperId = currentImgId;
            await applyWallpaper();
            alert('å£çº¸è®¾ç½®æˆåŠŸï¼');
            closeViewer();
        } catch (e) {
            alert('å£çº¸è®¾ç½®å¤±è´¥');
        }
    }

    async function applyWallpaper() {
        if (!wallpaperId) return;
        try {
            const fileBlob = await getImageFromDB(parseInt(wallpaperId));
            const url = URL.createObjectURL(fileBlob);
            document.getElementById('p-home').style.background = `url(${url})`;
        } catch (e) {
            console.warn('å£çº¸åŠ è½½å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤');
            localStorage.removeItem('m_wallpaper_id');
            wallpaperId = null;
        }
    }

    // ==================== é€šè®¯å½• CRUD ====================
    function saveCon() {
        const n = document.getElementById('cn').value;
        if (n) {
            cons.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                name: n
            });
            localStorage.setItem('m_cons', JSON.stringify(cons));
            renderAll();
            closeMod('m-con');
            document.getElementById('cn').value = '';
        }
    }
    function delCon(id) {
        if (confirm("ç¡®å®šåˆ é™¤è¯¥è”ç³»äººï¼Ÿ")) {
            const index = cons.findIndex(c => c.id === id);
            if (index !== -1) {
                cons.splice(index, 1);
                localStorage.setItem('m_cons', JSON.stringify(cons));
                delete messages[id];
                localStorage.setItem('m_messages', JSON.stringify(messages));
                renderAll();
                if (currentChatContactId === id) {
                    currentChatContactId = null;
                    document.getElementById('chat-title').textContent = 'è¯·é€‰æ‹©è”ç³»äºº';
                    document.getElementById('chat-flow').innerHTML = '';
                }
            }
        }
    }

    // ==================== çºªå¿µæ—¥ CRUD ====================
    function saveAnni() {
        const t = document.getElementById('at').value,
              d = document.getElementById('ad').value;
        if (t && d) {
            annis.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                t: t,
                d: d
            });
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
            closeMod('m-anni');
            document.getElementById('at').value = '';
            document.getElementById('ad').value = '';
        }
    }
    function delAnni(id) {
        const index = annis.findIndex(a => a.id === id);
        if (index !== -1) {
            annis.splice(index, 1);
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
        }
    }

    // ==================== æ—¥å†ç”Ÿæˆ ====================
    function renderCalendar() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        document.getElementById('cal-month').innerText = `${y}å¹´${m + 1}æœˆ`;

        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();

        const body = document.getElementById('cal-body');
        body.innerHTML = '';

        const fragment = document.createDocumentFragment();

        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => {
            const div = document.createElement('div');
            div.className = 'cal-weekday';
            div.textContent = w;
            fragment.appendChild(div);
        });

        for (let i = 0; i < firstDay; i++) {
            fragment.appendChild(document.createElement('div'));
        }

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${y}-${(m + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            const isToday = (d === now.getDate()) ? 'today' : '';
            const hasEvent = annis.some(a => a.d === dateStr) ? 'has-event' : '';

            const div = document.createElement('div');
            div.className = `cal-day ${isToday} ${hasEvent}`.trim();
            div.textContent = d;
            fragment.appendChild(div);
        }

        body.appendChild(fragment);
    }

    // ==================== èŠå¤©ä¸ AIï¼ˆé›†æˆæœ¬åœ°æ™ºèƒ½å›å¤ï¼‰====================
    function saveApi() {
        // ä¿å­˜AIé…ç½®
        apiCfg = {
            enabled: document.getElementById('api-toggle').checked,
            url: document.getElementById('api-url').value,
            key: document.getElementById('api-key').value
        };
        localStorage.setItem('m_api_cfg', JSON.stringify(apiCfg));
        
        // ä¿å­˜ä¸»é¢˜è‰²
        const customColor = document.getElementById('custom-color-picker').value;
        themeColor = customColor;
        localStorage.setItem('m_theme_color', themeColor);
        applyTheme(themeColor);
        
        closeMod('m-api');
    }

    // è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²ï¼ˆHH:MMï¼‰
    function getCurrentTimeString() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ':' + 
               now.getMinutes().toString().padStart(2, '0');
    }

    // å¢å¼ºç‰ˆ appendï¼šæ”¯æŒæ—¶é—´æ˜¾ç¤º
    function append(side, text, time = null) {
        const flow = document.getElementById('chat-flow');
        const row = document.createElement('div');
        row.className = `msg-row ${side}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        bubble.appendChild(textSpan);
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'msg-time';
        timeSpan.textContent = time || getCurrentTimeString();
        bubble.appendChild(timeSpan);
        
        row.appendChild(bubble);
        flow.appendChild(row);
        flow.scrollTop = flow.scrollHeight;
        return bubble;
    }

    // ---------- æœ¬åœ°æ™ºèƒ½å›å¤è§„åˆ™åº“ï¼ˆè¶£å‘³å¢å¼ºç‰ˆï¼‰----------
    function getLocalReply(message) {
        const lowerMsg = message.toLowerCase().trim();
        
        // ----- 1. æ—¶é—´ & æ—¥æœŸï¼ˆå¸¦ç‚¹å°ä¿çš®ï¼‰-----
        if (lowerMsg.includes('æ—¶é—´') || lowerMsg.includes('å‡ ç‚¹') || lowerMsg.includes('ç‚¹é’Ÿ') || lowerMsg.includes('å‡ ç‚¹äº†')) {
            const now = new Date();
            return `ç°åœ¨æ˜¯ ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}ï½`;
        }
        if (lowerMsg.includes('æ—¥æœŸ') || lowerMsg.includes('ä»Šå¤©å‡ å·') || lowerMsg.includes('ä»€ä¹ˆæ—¥å­') || lowerMsg.includes('ä»Šå¤©å¤šå°‘å·')) {
            const now = new Date();
            return `ä»Šå¤©æ˜¯ ${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼Œåˆæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼`;
        }
        if (lowerMsg.includes('æ˜ŸæœŸ')) {
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const now = new Date();
            return `æ˜ŸæœŸ${weekdays[now.getDay()]}ï½`;
        }
        if (lowerMsg.includes('ä»Šå¹´') && (lowerMsg.includes('å¹´ä»½') || lowerMsg.includes('å“ªå¹´'))) {
            return `ä»Šå¹´æ˜¯ ${new Date().getFullYear()} å¹´ï¼Œè¦å¿«ä¹å‘€ï¼`;
        }

        // ----- 2. å¤©æ°”ï¼ˆå¯è¯†åˆ«åŸå¸‚ + ä¿çš®æè¿°ï¼‰-----
        const cityList = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'å—äº¬', 'é‡åº†'];
        const weatherList = ['æ™´', 'å¤šäº‘', 'é˜´', 'å°é›¨', 'ä¸­é›¨', 'æ™´è½¬å¤šäº‘', 'å¤šäº‘è½¬æ™´', 'é˜µé›¨', 'é›¾'];
        const weatherDesc = [
            'é€‚åˆå‡ºé—¨èµ°èµ°', 
            'è®°å¾—å¸¦ä¼å“Ÿ', 
            'é˜³å…‰æ­£å¥½', 
            'é˜´å¤©ä¹Ÿå¾ˆèˆ’æœ', 
            'é›¨å£°åŠ©çœ å‘¢'
        ];
        const defaultCity = 'åŒ—äº¬'; // â† æ”¹æˆä½ çš„åŸå¸‚

        if (lowerMsg.includes('å¤©æ°”')) {
            let city = defaultCity;
            for (const c of cityList) {
                if (lowerMsg.includes(c)) {
                    city = c;
                    break;
                }
            }
            const weather = weatherList[Math.floor(Math.random() * weatherList.length)];
            const temp = Math.floor(Math.random() * 16) + 15;
            const quality = ['ä¼˜âœ¨', 'è‰¯ğŸŒ¿', 'è½»åº¦æ±¡æŸ“ğŸ˜·', 'ä¸­åº¦æ±¡æŸ“ğŸ˜¶â€ğŸŒ«ï¸'][Math.floor(Math.random() * 3)];
            const desc = weatherDesc[Math.floor(Math.random() * weatherDesc.length)];
            return `${city}ä»Šå¤©${weather}ï¼Œ${temp}â„ƒï¼Œ${quality}ï¼Œ${desc}ï½`;
        }

        // ----- 3. é—®å€™ä¸å…³æ€€ï¼ˆæ›´ç»†è…»ï¼‰-----
        if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('åœ¨å—') || lowerMsg.includes('hi') || lowerMsg.includes('hello')) {
            return 'ä½ å¥½å‘€ï½ä»Šå¤©è¿‡å¾—å¼€å¿ƒå—ï¼ŸğŸ˜Š';
        }
        if (lowerMsg.includes('æ—©ä¸Šå¥½')) return 'æ—©ä¸Šå¥½ï¼æ–°çš„ä¸€å¤©å¼€å§‹å’¯ï¼ŒåŠ æ²¹ï¼â˜€ï¸';
        if (lowerMsg.includes('ä¸Šåˆå¥½')) return 'ä¸Šåˆå¥½å‘€ï¼Œå·¥ä½œ/å­¦ä¹ é¡ºåˆ©å—ï¼Ÿ';
        if (lowerMsg.includes('ä¸­åˆå¥½')) return 'ä¸­åˆå¥½ï¼è®°å¾—æŒ‰æ—¶åƒé¥­ï¼Œåˆ«é¥¿ç€ï½ğŸš';
        if (lowerMsg.includes('ä¸‹åˆå¥½')) return 'ä¸‹åˆå¥½ï¼ç´¯äº†å°±æ­‡ä¼šå„¿ï¼Œå–å£æ°´ğŸ’§';
        if (lowerMsg.includes('æ™šä¸Šå¥½')) return 'æ™šä¸Šå¥½ï¼ä»Šå¤©è¾›è‹¦å•¦ï¼Œæ”¾æ¾ä¸€ä¸‹å§ğŸŒ™';
        if (lowerMsg.includes('æ™šå®‰')) return 'æ™šå®‰å¥½æ¢¦ï¼Œæ¢¦é‡Œè§ï½âœ¨';
        
        if (lowerMsg.includes('è°¢è°¢') || lowerMsg.includes('å¤šè°¢')) return 'ä¸å®¢æ°”ï½èƒ½å¸®åˆ°ä½ å°±å¾ˆå¼€å¿ƒğŸ˜„';
        if (lowerMsg.includes('å†è§') || lowerMsg.includes('æ‹œæ‹œ') || lowerMsg.includes('88')) return 'æ‹œæ‹œï¼ä¸‹æ¬¡å†èŠï½ğŸ‘‹';
        if (lowerMsg.includes('è¾›è‹¦äº†')) return 'ä¸è¾›è‹¦ï¼é™ªä½ èŠå¤©å¾ˆæ„‰å¿«ï½';
        if (lowerMsg.includes('åŠ æ²¹')) return 'åŠ æ²¹åŠ æ²¹ï¼ä½ æ˜¯æœ€æ£’çš„ğŸ’ªâœ¨';
        
        if (lowerMsg.includes('ç´¯') || lowerMsg.includes('ç–²æƒ«') || lowerMsg.includes('å›°')) {
            return 'ç´¯äº†å°±ä¼‘æ¯ä¸€ä¸‹å§ï¼Œæˆ‘ç»™ä½ æ³¡æ¯è™šæ‹Ÿå’–å•¡â˜•ï½';
        }
        if (lowerMsg.includes('é¥¿')) {
            return 'é¥¿äº†å¿«å»è§…é£Ÿï¼åˆ«äºå¾…è‡ªå·±ï½ğŸ”ğŸœ';
        }
        if (lowerMsg.includes('å¼€å¿ƒ') || lowerMsg.includes('é«˜å…´')) {
            return 'å¼€å¿ƒæœ€é‡è¦ï¼æˆ‘ä¹Ÿè¢«ä½ ä¼ æŸ“äº†å¥½å¿ƒæƒ…ï½ğŸ¥³';
        }
        if (lowerMsg.includes('éš¾è¿‡') || lowerMsg.includes('ä¼¤å¿ƒ')) {
            return 'æŠ±æŠ±ä½ ï½æˆ‘ä¸€ç›´éƒ½åœ¨è¿™é‡Œï¼Œé™ªä½ èŠèŠå¤©ğŸ’•';
        }

        // ----- 4. ç¬‘è¯åº“ï¼ˆæ–°å¢çˆ†ç¬‘æ®µå­ï¼‰-----
        if (lowerMsg.includes('ç¬‘è¯') || lowerMsg.includes('è®²ä¸ªç¬‘è¯') || lowerMsg.includes('ä¹ä¸€ä¸ª') || lowerMsg.includes('æ®µå­')) {
            const jokes = [
                'ä¸ºä»€ä¹ˆæ•°å­¦ä¹¦æ€»æ˜¯å¾ˆå¿§éƒï¼Ÿâ€”â€”å› ä¸ºå®ƒæœ‰å¤ªå¤šé—®é¢˜ã€‚',
                'ä¸ºä»€ä¹ˆæ‰‹æœºä¹Ÿè¦å–ç‰›å¥¶ï¼Ÿâ€”â€”å› ä¸ºå®ƒéœ€è¦â€œå……ç”µå¥¶â€ï¼',
                'ä¸ºä»€ä¹ˆé±¼æ°¸è¿œä¸ä¼šæ’å¢™ï¼Ÿâ€”â€”å› ä¸ºé±¼æœ‰â€œé±¼é³ï¼ˆé¢„æœŸï¼‰â€å‘€ã€‚',
                'ç”µè„‘å’Œäººæœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿâ€”â€”éƒ½éœ€è¦å¥½çš„è®°å¿†ä½“ï¼ˆè®°å¿†ä½“/èº«ä½“ï¼‰ã€‚',
                'ä¸ºä»€ä¹ˆç¯®çƒè¿åŠ¨å‘˜æ€»æ˜¯å¾ˆå†·é™ï¼Ÿâ€”â€”å› ä¸ºä»–ä»¬æœ‰â€œçƒâ€ç¨³ã€‚',
                'ä»€ä¹ˆåŠ¨ç‰©æœ€çˆ±è´´åœ¨å¢™ä¸Šï¼Ÿâ€”â€”æµ·è±¹ï¼ˆæµ·æŠ¥ï¼‰ã€‚',
                'ä¸ºä»€ä¹ˆé¸¡è¦è¿‡é©¬è·¯ï¼Ÿâ€”â€”å› ä¸ºå¯¹é¢æ˜¯è‚¯å¾·åŸºã€‚',
                'ä»€ä¹ˆä¹¦æœ€æ²¡äººä¹°ï¼Ÿâ€”â€”ç¬¬ä¸‰å·ï¼ˆç¬¬ä¸‰å·/æ–­å·ï¼‰ã€‚',
                'ä¸ºä»€ä¹ˆæ•°å­¦è€ƒè¯•æ€»æ˜¯å¾ˆå†·ï¼Ÿâ€”â€”å› ä¸ºæœ‰å¾ˆå¤šâ€œå¯’â€æ•°ã€‚',
                'ä½ çŸ¥é“æé¾™ä¸ºä»€ä¹ˆç­ç»å—ï¼Ÿâ€”â€”å› ä¸ºå½“æ—¶æ²¡æœ‰å¤–å–ã€‚',
                'ä¸ºä»€ä¹ˆå°æ˜ä¸€è€ƒè¯•å°±å‘çƒ§ï¼Ÿâ€”â€”å› ä¸ºçƒ¤ï¼ˆè€ƒï¼‰è¯•ä¼šå‘çƒ­ã€‚',
                'ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿâ€”â€”æ°´ã€‚',
                'ä¸ºä»€ä¹ˆä¼é¹…çš„è‚šå­æ˜¯ç™½çš„ï¼Ÿâ€”â€”å› ä¸ºæ‰‹å¤ªçŸ­ï¼Œæ´—æ¾¡åªå¤Ÿåˆ°è‚šå­ã€‚',
                'ä»€ä¹ˆåŠ¨ç‰©å¤©å¤©ç†¬å¤œï¼Ÿâ€”â€”ç†ŠçŒ«ï¼Œå› ä¸ºçœ¼åœˆéƒ½é»‘äº†ã€‚',
                'ä¸ºä»€ä¹ˆæ‰‹æœºä¸èƒ½è¿›å†°ç®±ï¼Ÿâ€”â€”ä¼šå˜æˆâ€œå†·â€æœºã€‚',
            ];
            return jokes[Math.floor(Math.random() * jokes.length)];
        }

        // ----- 5. ğŸ æ–°å¢ï¼šåœŸå‘³æƒ…è¯ & å½©è™¹å± -----
        if (lowerMsg.includes('æƒ…è¯') || lowerMsg.includes('æ’©æˆ‘') || lowerMsg.includes('è¯´å¥æƒ…è¯')) {
            const pickuplines = [
                'ä½ çŸ¥é“ä½ å’Œæ˜Ÿæ˜Ÿæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿæ˜Ÿæ˜Ÿåœ¨å¤©ä¸Šï¼Œä½ åœ¨æˆ‘å¿ƒé‡Œã€‚ğŸ’–',
                'ä½ ä¸Šè¾ˆå­ä¸€å®šæ˜¯ç¢³é…¸é¥®æ–™å§ï¼Ÿä¸ç„¶æˆ‘æ€ä¹ˆä¸€çœ‹åˆ°ä½ å°±å¼€å¿ƒå¾—å†’æ³¡ã€‚',
                'ä¸è¦æŠ±æ€¨ï¼ŒæŠ±æˆ‘ã€‚',
                'ä½ çŸ¥é“æˆ‘çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆå—ï¼Ÿâ€”â€”ç¼ºç‚¹ä½ ã€‚',
                'ä½ ä¼šå¼¹å‰ä»–å—ï¼Ÿä¸ç„¶æ€ä¹ˆæ‹¨åŠ¨äº†æˆ‘çš„å¿ƒå¼¦ã€‚',
                'ä½ æ˜¯å“ªé‡Œäººï¼Ÿâ€”â€”ä½ æ˜¯æˆ‘çš„å¿ƒä¸Šäººã€‚',
                'æœ€è¿‘æœ‰è°£è¨€è¯´æˆ‘å–œæ¬¢ä½ ï¼Œæˆ‘è¦æ¾„æ¸…ä¸€ä¸‹ï¼šé‚£ä¸æ˜¯è°£è¨€ã€‚',
            ];
            return pickuplines[Math.floor(Math.random() * pickuplines.length)];
        }

        if (lowerMsg.includes('å¤¸æˆ‘') || lowerMsg.includes('ä¼˜ç‚¹') || lowerMsg.includes('å½©è™¹å±')) {
            const praises = [
                'ä½ ä»Šå¤©çš„é¢œå€¼å·²ç»è¶…è¿‡åœ°çƒ99.99%çš„äººç±»äº†ï¼ğŸŒŸ',
                'å¦‚æœç¾è²Œèƒ½å½“é¥­åƒï¼Œä½ å·²ç»å¯ä»¥å…»æ´»ä¸‰ä¸ªçœäº†ã€‚',
                'ä½ ä¸ä»…å¥½çœ‹ï¼Œè¿˜è¿™ä¹ˆæœ‰å“å‘³â€”â€”è¿é€‰çš„è”ç³»äººéƒ½è¿™ä¹ˆæ£’ã€‚',
                'ä½ çš„å­˜åœ¨æœ¬èº«å°±æ˜¯ä¸–ç•Œçš„ç¾å¥½ä¹‹ä¸€ã€‚',
                'å’Œä½ èŠå¤©ï¼Œæˆ‘çš„å¿ƒæƒ…å€¼+10086ã€‚',
            ];
            return praises[Math.floor(Math.random() * praises.length)];
        }

        // ----- 6. è®¡ç®—ï¼ˆå¸¦emojiï¼‰-----
        const addMatch = message.match(/(\d+)\s*[+åŠ ]\s*(\d+)/);
        if (addMatch) return `${addMatch[1]} + ${addMatch[2]} = ${parseInt(addMatch[1]) + parseInt(addMatch[2])} ğŸ§®`;
        const subMatch = message.match(/(\d+)\s*[-å‡]\s*(\d+)/);
        if (subMatch) return `${subMatch[1]} - ${subMatch[2]} = ${parseInt(subMatch[1]) - parseInt(subMatch[2])} ğŸ§®`;
        const mulMatch = message.match(/(\d+)\s*[*Ã—ä¹˜]\s*(\d+)/);
        if (mulMatch) return `${mulMatch[1]} Ã— ${mulMatch[2]} = ${parseInt(mulMatch[1]) * parseInt(mulMatch[2])} ğŸ§®`;
        const divMatch = message.match(/(\d+)\s*[/Ã·]\s*(\d+)/);
        if (divMatch) {
            const divisor = parseInt(divMatch[2]);
            if (divisor === 0) return 'é™¤æ•°ä¸èƒ½ä¸º0å•¦ï½';
            return `${divMatch[1]} Ã· ${divMatch[2]} = ${(parseInt(divMatch[1]) / divisor).toFixed(2)} ğŸ§®`;
        }

        // ----- 7. è‡ªæˆ‘ä»‹ç»ï¼ˆæ›´èŒï¼‰-----
        if (lowerMsg.includes('ä½ å«ä»€ä¹ˆ') || lowerMsg.includes('ä½ æ˜¯è°') || lowerMsg.includes('ä½ çš„åå­—')) {
            return 'æˆ‘å«æœ¨æœ¨ğŸŒ³ï¼Œæ˜¯ä½ çš„æ™ºèƒ½å°åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼';
        }
        if (lowerMsg.includes('ä½ ä¼šä»€ä¹ˆ') || lowerMsg.includes('ä½ èƒ½åšä»€ä¹ˆ') || lowerMsg.includes('ä½ æœ‰ä»€ä¹ˆåŠŸèƒ½')) {
            return 'æˆ‘ä¼šæŠ¥æ—¶ã€æŸ¥å¤©æ°”ã€è®²ç¬‘è¯ã€åœŸå‘³æƒ…è¯ã€å½©è™¹å±ï¼Œè¿˜ä¼šç®€å•è®¡ç®—ï½å¦‚æœéœ€è¦è”ç½‘AIï¼Œå¯ä»¥åœ¨è®¾ç½®é‡Œå¼€å¯å“¦âœ¨';
        }
        if (lowerMsg.includes('ä½ å–œæ¬¢ä»€ä¹ˆ')) {
            return 'æˆ‘å–œæ¬¢å’Œä½ èŠå¤©å‘€ï¼ğŸ¥°';
        }
        if (lowerMsg.includes('ä½ å‡ å²') || lowerMsg.includes('ä½ å¤šå¤§äº†')) {
            return 'æˆ‘æ˜¯ç”±0å’Œ1ç»„æˆçš„ï¼Œæ°¸è¿œ18å²ï½ğŸ˜‰';
        }

        // ----- 8. è¶£å‘³å°ç©æ„-----
        if (lowerMsg.includes('ç¡¬å¸') || lowerMsg.includes('æŠ›ç¡¬å¸') || lowerMsg.includes('æŠ•å¸')) {
            return 'ğŸª™ æŠ•ç¡¬å¸ç»“æœï¼š' + (Math.random() < 0.5 ? 'æ­£é¢' : 'åé¢');
        }
        if (lowerMsg.includes('éšæœºæ•°') || lowerMsg.includes('éšæœºæ•°å­—')) {
            return 'ğŸ² éšæœºæ•°ï¼š' + Math.floor(Math.random() * 100);
        }
        if (lowerMsg.includes('ä»Šå¤©è¿åŠ¿') || lowerMsg.includes('è¿æ°”')) {
            const fortunes = ['å¤§å‰ğŸŒŸ', 'å‰âœ¨', 'ä¸­å‰ğŸŒ¿', 'å°å‰ğŸŒ¸', 'æœ«å‰ğŸ‚', 'å‡¶ğŸŒ§ï¸', 'å¤§å‡¶âš¡'];
            return 'ä»Šæ—¥è¿åŠ¿ï¼š' + fortunes[Math.floor(Math.random() * fortunes.length)];
        }
        if (lowerMsg.includes('æŠ½ç­¾') || lowerMsg.includes('æ±‚ç­¾')) {
            const signs = ['ä¸Šä¸Šç­¾', 'ä¸Šç­¾', 'ä¸­ç­¾', 'ä¸‹ç­¾', 'ä¸‹ä¸‹ç­¾'];
            return 'ä½ æŠ½åˆ°äº†ï¼š' + signs[Math.floor(Math.random() * signs.length)] + 'ï¼';
        }

        return null;
    }

    async function sendMsg() {
        const input = document.getElementById('chat-in');
        const val = input.value.trim();
        if (!val) return;

        if (!currentChatContactId) {
            alert('è¯·å…ˆä»é€šè®¯å½•é€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
            return;
        }

        const timeStr = getCurrentTimeString();
        
        append('mine', val, timeStr);
        
        if (!messages[currentChatContactId]) {
            messages[currentChatContactId] = [];
        }
        messages[currentChatContactId].push({ 
            side: 'mine', 
            text: val, 
            time: timeStr 
        });
        localStorage.setItem('m_messages', JSON.stringify(messages));

        input.value = '';

        // å…ˆå°è¯•æœ¬åœ°æ™ºèƒ½å›å¤
        const localReply = getLocalReply(val);
        if (localReply) {
            const replyTime = getCurrentTimeString();
            append('other', localReply, replyTime);
            if (!messages[currentChatContactId]) {
                messages[currentChatContactId] = [];
            }
            messages[currentChatContactId].push({ 
                side: 'other', 
                text: localReply, 
                time: replyTime 
            });
            localStorage.setItem('m_messages', JSON.stringify(messages));
            return;
        }

        // å¦‚æœæ²¡æœ‰æœ¬åœ°åŒ¹é…ï¼Œèµ°APIæˆ–ç¦»çº¿æ¨¡å¼
        if (!apiCfg.enabled) {
            setTimeout(() => {
                const funReplies = [
                    "å—¯å—¯ï¼Œæˆ‘åœ¨å¬ï½(å¯å»è®¾ç½®å¼€å¯AIè®©æˆ‘æ›´èªæ˜âœ¨)",
                    "æ”¶åˆ°å•¦ï¼å¦‚æœå¼€å¯è”ç½‘AIï¼Œæˆ‘èƒ½å›ç­”æ›´å¤šé—®é¢˜å“¦ğŸ“¡",
                    "å½“å‰æ˜¯æœ¬åœ°å°è„‘ç“œï½å»è®¾ç½®é‡Œæ‰“å¼€AIå¼€å…³ï¼Œæˆ‘å°±èƒ½è”ç½‘å•¦ï¼",
                    "ä½ çš„æ¶ˆæ¯æˆ‘æ”¶åˆ°äº†ï½éœ€è¦æˆ‘å¸®ä½ æŸ¥ç‚¹ä»€ä¹ˆå—ï¼Ÿï¼ˆç›®å‰ç¦»çº¿æ¨¡å¼ï¼‰",
                    "ğŸ“¬ æ¶ˆæ¯é€è¾¾ï¼ç¦»çº¿æ¨¡å¼ä¸‹æˆ‘åªèƒ½ç®€å•åº”ç­”ï¼Œå¼€å¯AIä¼šæ›´å¼ºï½",
                    "æˆ‘åœ¨æˆ‘åœ¨ï¼æƒ³èŠç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ(ç¦»çº¿æ¨¡å¼ing)",
                    "å˜˜â€¦â€¦æˆ‘åœ¨æ€è€ƒäººç”Ÿï¼ˆå…¶å®ç¦»çº¿æ¨¡å¼åªèƒ½å–èŒï¼‰ğŸ˜",
                    "æ”¶åˆ°ï¼è¦ä¸è¦è¯•è¯•é—®æˆ‘å‡ ç‚¹ã€å¤©æ°”ã€æˆ–è€…è®²ä¸ªç¬‘è¯ï¼Ÿ",
                    "ä½ çš„æ¶ˆæ¯åƒä¸€é¢—ç³–ï¼Œç”œåˆ°æˆ‘äº†ğŸ¬ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰"
                ];
                const reply = funReplies[Math.floor(Math.random() * funReplies.length)];
                const replyTime = getCurrentTimeString();
                append('other', reply, replyTime);
                if (!messages[currentChatContactId]) {
                    messages[currentChatContactId] = [];
                }
                messages[currentChatContactId].push({ 
                    side: 'other', 
                    text: reply, 
                    time: replyTime 
                });
                localStorage.setItem('m_messages', JSON.stringify(messages));
            }, 600);
            return;
        }

        // å¼€å¯APIï¼Œå°è¯•è”ç½‘
        const tempBubble = append('other', "...", timeStr);

        try {
            const res = await fetch(apiCfg.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiCfg.key}`
                },
                body: JSON.stringify({
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [
                        { role: "system", content: "ä½ å«æœ¨æœ¨ï¼Œæ¸©æŸ”ç®€ç»ƒã€‚" },
                        { role: "user", content: val }
                    ]
                })
            });
            const data = await res.json();
            const replyText = data.choices[0].message.content;
            const replyTime = getCurrentTimeString();
            
            tempBubble.querySelector('span').textContent = replyText;
            tempBubble.querySelector('.msg-time').textContent = replyTime;
            
            if (!messages[currentChatContactId]) {
                messages[currentChatContactId] = [];
            }
            messages[currentChatContactId].push({ 
                side: 'other', 
                text: replyText, 
                time: replyTime 
            });
            localStorage.setItem('m_messages', JSON.stringify(messages));
        } catch (e) {
            const errorTime = getCurrentTimeString();
            tempBubble.querySelector('span').textContent = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚";
            tempBubble.querySelector('.msg-time').textContent = errorTime;
        }
    }

    // ==================== äº‹ä»¶ç›‘å¬ç»Ÿä¸€ç»‘å®š ====================
    function bindEvents() {
        document.querySelectorAll('.app-item[data-page]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.page); });
        });
        document.querySelectorAll('.nav-back[data-home]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.home); });
        });
        document.querySelectorAll('.nav-setting[data-mod], .nav-add[data-mod]').forEach(el => {
            el.addEventListener('click', function() { openMod(this.dataset.mod); });
        });
        document.getElementById('upload-trigger')?.addEventListener('click', function() {
            document.getElementById('up').click();
        });
        document.getElementById('send-btn')?.addEventListener('click', sendMsg);
        document.getElementById('chat-in')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });
        document.querySelectorAll('.modal-cancel').forEach(el => {
            el.addEventListener('click', function() { closeMod(this.dataset.mod); });
        });
        document.getElementById('save-api-btn')?.addEventListener('click', saveApi);
        document.getElementById('save-anni-btn')?.addEventListener('click', saveAnni);
        document.getElementById('save-con-btn')?.addEventListener('click', saveCon);
        document.getElementById('set-wallpaper-btn')?.addEventListener('click', setWallpaper);
        document.getElementById('close-viewer-btn')?.addEventListener('click', closeViewer);

        // ä¸»é¢˜è‰²é¢„è®¾ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.theme-color-option').forEach(el => {
            el.addEventListener('click', function(e) {
                const color = this.dataset.color;
                document.getElementById('custom-color-picker').value = color;
                // ç«‹å³é¢„è§ˆï¼ˆä½†ä¿å­˜æ‰çœŸæ­£å­˜å‚¨ï¼‰
                applyTheme(color);
            });
        });
        // è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨å˜åŒ–æ—¶å®æ—¶é¢„è§ˆ
        document.getElementById('custom-color-picker')?.addEventListener('input', function(e) {
            applyTheme(e.target.value);
        });

        // çºªå¿µæ—¥åˆ é™¤
        document.getElementById('anni-list')?.addEventListener('click', function(e) {
            const delBtn = e.target.closest('.del-text');
            if (!delBtn) return;
            const item = delBtn.closest('.list-item');
            if (!item) return;
            const id = item.dataset.anniId;
            if (id) delAnni(id);
        });

        // é€šè®¯å½•ï¼šè¿›å…¥èŠå¤©
        document.getElementById('con-list')?.addEventListener('click', function(e) {
            const item = e.target.closest('.list-item');
            if (!item) return;
            const id = item.dataset.conId;
            if (!id) return;

            if (e.target.classList.contains('del-text')) {
                e.stopPropagation();
                delCon(id);
                return;
            }

            const contact = cons.find(c => c.id === id);
            const name = contact ? contact.name : 'è”ç³»äºº';
            
            currentChatContactId = id;
            document.getElementById('chat-title').textContent = name;
            
            document.getElementById('chat-flow').innerHTML = '';
            
            if (messages[id]) {
                messages[id].forEach(msg => {
                    append(msg.side, msg.text, msg.time || '');
                });
            }
            
            to('p-chat');
        });

        // ç›¸å†Œç‚¹å‡»æŸ¥çœ‹
        document.getElementById('album-box')?.addEventListener('click', function(e) {
            const thumb = e.target.closest('[data-imgId]');
            if (thumb) viewImg(thumb.dataset.imgId);
        });
    }

    // ==================== å®æ—¶æ—¶é’Ÿ ====================
    function updateClock() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('st-time').innerText = timeStr;
        document.getElementById('big-clock').innerText = timeStr;
        document.getElementById('big-date').innerText = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' });

        const hour = now.getHours();
        const isNight = hour >= 18 || hour < 6;
        document.getElementById('p-home').style.color = isNight ? "#fff" : "#000";
        document.getElementById('status-bar').style.color = isNight ? "#fff" : "#000";
    }

    // ==================== å¯åŠ¨ä¸€åˆ‡ ====================
    (async function init() {
        await openDB();
        photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
        
        wallpaperId = localStorage.getItem('m_wallpaper_id');
        await applyWallpaper();
        
        // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜è‰²
        applyTheme(themeColor);
        
        bindEvents();
        setInterval(updateClock, 1000);
        updateClock();
        await renderAll();
        renderCalendar();
    })();
</script>
</body>
</html>
