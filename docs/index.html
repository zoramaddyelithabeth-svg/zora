<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartOS Pro Ultra Â· å¤§å®¹é‡ç›¸å†Œ</title>
    <style>
        /* ----- å®Œå…¨ä¿ç•™ä½ åŸæœ‰çš„æ ·å¼ï¼Œä¸€ä¸ªå­—éƒ½æ²¡æ”¹ ----- */
        :root {
            --wechat-green: #07C160;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --glass: rgba(255, 255, 255, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        .app-container {
            width: 100%; height: 100%; background: #fff; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
        }
        @media (min-width: 600px) {
            .app-container { max-width: 375px; height: 812px; border-radius: 40px; border: 8px solid #333; }
        }

        .status-bar { height: 44px; padding: 14px 20px 0; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 600; z-index: 1000; position: absolute; top: 0; width: 100%; }
        .nav-bar { height: 50px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 0.5px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F2F2F7; display: none; flex-direction: column; z-index: 10; padding-top: 44px; }
        .page.active { display: flex; }

        .home-bg { transition: background 0.8s ease; background-size: cover !important; background-position: center !important; }
        .home-clock { text-align: center; padding: 30px 0; text-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .home-clock h1 { font-size: 64px; font-weight: 200; letter-spacing: -2px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 25px; }
        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .app-item:active { transform: scale(0.9); }
        .app-icon { width: 60px; height: 60px; background: var(--glass); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .app-name { font-size: 11px; margin-top: 8px; font-weight: 500; }

        #album-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 2px 0; overflow-y: auto; flex: 1; background: #fff; }
        #album-box div { aspect-ratio: 1/1; background-size: cover; background-position: center; transition: opacity 0.2s; }
        #album-box div:active { opacity: 0.7; }

        .cal-header { background: #fff; padding: 15px; text-align: center; border-bottom: 0.5px solid #eee; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; padding: 10px; border-bottom: 0.5px solid #eee; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; position: relative; }
        .cal-day.today { background: var(--ios-red); color: #fff; border-radius: 50%; }
        .cal-day.has-event::after { content: ''; width: 4px; height: 4px; background: #999; border-radius: 50%; position: absolute; bottom: 4px; }
        .cal-weekday {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #999;
            font-weight: 600;
        }

        .list-item { padding: 15px; border-bottom: 0.5px solid #eee; background: #fff; display: flex; align-items: center; justify-content: space-between; font-size: 16px; }
        .del-text { color: var(--ios-red); font-size: 14px; font-weight: 500; padding: 5px; }

        #chat-flow { flex: 1; overflow-y: auto; background: #ededed; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .bubble { padding: 10px 14px; border-radius: 10px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .mine .bubble { background: var(--wechat-green); color: #fff; }
        .other .bubble { background: #fff; color: #000; }

        #viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #viewer img { max-width: 100%; max-height: 85%; object-fit: contain; }
        .viewer-btns { position: absolute; bottom: 60px; display: flex; gap: 20px; z-index: 2001; }
        .v-btn { padding: 12px 25px; border-radius: 25px; background: rgba(255,255,255,0.25); color: #fff; border: none; backdrop-filter: blur(15px); font-size: 14px; }

        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-body { width: 85%; background: #fff; border-radius: 24px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-body h3 { margin-bottom: 10px; }
        .modal-body input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; outline: none; font-size: 16px; }
        .modal-btn { width: 100%; padding: 14px; background: var(--ios-blue); color: #fff; border: none; border-radius: 12px; margin-top: 10px; font-weight: 600; }
    </style>
</head>
<body>
<div class="app-container">
    <div class="status-bar" id="status-bar">
        <span id="st-time">00:00</span>
        <div>ğŸ“¶ ğŸ”‹</div>
    </div>

    <!-- æ¡Œé¢ï¼ˆæ— å†…è”onclickï¼‰ -->
    <div class="page active home-bg" id="p-home">
        <div class="home-clock">
            <h1 id="big-clock">00:00</h1>
            <p id="big-date" style="opacity:0.8"></p>
        </div>
        <div class="app-grid">
            <div class="app-item" data-page="p-chat"><div class="app-icon">ğŸ’¬</div><div class="app-name">å¾®ä¿¡</div></div>
            <div class="app-item" data-page="p-album"><div class="app-icon">ğŸ–¼ï¸</div><div class="app-name">ç›¸å†Œ</div></div>
            <div class="app-item" data-page="p-cal"><div class="app-icon">ğŸ“…</div><div class="app-name">æ—¥å†</div></div>
            <div class="app-item" data-page="p-con"><div class="app-icon">ğŸ‘¥</div><div class="app-name">é€šè®¯å½•</div></div>
            <div class="app-item" data-page="p-safari"><div class="app-icon">ğŸŒ</div><div class="app-name">Safari</div></div>
        </div>
    </div>

    <!-- èŠå¤© -->
    <div class="page" id="p-chat">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b id="chat-title">æœ¨æœ¨</b>
            <span class="nav-setting" data-mod="m-api" style="color:var(--ios-blue); font-size:13px;">è®¾ç½®</span>
        </div>
        <div id="chat-flow"></div>
        <div style="padding:10px; background:#f7f7f7; display:flex; gap:10px; padding-bottom: 25px;">
            <input type="text" id="chat-in" placeholder="ç”¨å›è½¦å‘é€..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button id="send-btn" style="background:var(--wechat-green); color:#fff; border:none; padding:0 15px; border-radius:8px;">å‘é€</button>
        </div>
    </div>

    <!-- ç›¸å†Œï¼ˆå¤§å®¹é‡ç‰ˆï¼‰ -->
    <div class="page" id="p-album">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ‰€æœ‰ç…§ç‰‡</b>
            <span id="upload-trigger" style="color:var(--ios-blue)">ä¸Šä¼ </span>
        </div>
        <input type="file" id="up" hidden multiple accept="image/*">
        <div id="album-box"></div>
    </div>

    <!-- æ—¥å† -->
    <div class="page" id="p-cal">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ—¥å†</b>
            <span class="nav-add" data-mod="m-anni" style="color:var(--ios-blue)">æ·»åŠ </span>
        </div>
        <div class="cal-header"><h3 id="cal-month"></h3></div>
        <div class="cal-grid" id="cal-body"></div>
        <div id="anni-list" style="flex:1; overflow-y:auto; background:#fff;"></div>
    </div>

    <!-- é€šè®¯å½• -->
    <div class="page" id="p-con">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>é€šè®¯å½•</b>
            <span class="nav-add" data-mod="m-con" style="color:var(--ios-blue)">â•</span>
        </div>
        <div id="con-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- Safari -->
    <div class="page" id="p-safari">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b>æµè§ˆå™¨</b>
        </div>
        <iframe src="https://m.bing.com" style="flex:1; border:none;"></iframe>
    </div>

    <!-- å¤§å›¾æŸ¥çœ‹å™¨ -->
    <div id="viewer" onclick="closeViewer()">
        <img id="v-img" src="" onclick="event.stopPropagation()">
        <div class="viewer-btns" onclick="event.stopPropagation()">
            <button class="v-btn" id="set-wallpaper-btn">è®¾ä¸ºå£çº¸</button>
            <button class="v-btn" id="close-viewer-btn">è¿”å›</button>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="m-api">
        <div class="modal-body">
            <h3>AI è”ç½‘è®¾ç½®</h3>
            <label><input type="checkbox" id="api-toggle"> å¼€å¯ AI å“åº”</label>
            <input type="text" id="api-url" placeholder="API URL (å« v1/chat/completions)">
            <input type="password" id="api-key" placeholder="API Key">
            <button class="modal-btn" id="save-api-btn">ä¿å­˜é…ç½®</button>
            <button class="modal-cancel" data-mod="m-api" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="modal" id="m-anni">
        <div class="modal-body">
            <h3>æ–°çºªå¿µæ—¥</h3>
            <input type="text" id="at" placeholder="äº‹é¡¹åç§°">
            <input type="date" id="ad">
            <button class="modal-btn" id="save-anni-btn">ä¿å­˜</button>
            <button class="modal-cancel" data-mod="m-anni" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="modal" id="m-con">
        <div class="modal-body">
            <h3>æ–°è”ç³»äºº</h3>
            <input type="text" id="cn" placeholder="å§“å">
            <button class="modal-btn" id="save-con-btn">æ·»åŠ </button>
            <button class="modal-cancel" data-mod="m-con" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // ==================== IndexedDB å›¾ç‰‡ä»“åº“ï¼ˆå¤§å®¹é‡ï¼‰ ====================
    let db;
    const DB_NAME = 'SmartOSDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'photos';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { autoIncrement: true });
                }
            };
        });
    }

    async function saveImageToDB(file) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.add(file);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getImageFromDB(id) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getAllImageIds() {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAllKeys();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // ==================== æ•°æ®æŒä¹…åŒ–ï¼ˆIDåˆ—è¡¨ï¼‰ ====================
    let photos = [];          // åªå­˜å›¾ç‰‡IDï¼Œä¸å­˜base64
    let annis = JSON.parse(localStorage.getItem('m_annis') || '[]');
    let cons = JSON.parse(localStorage.getItem('m_cons') || '[{"id":"init-001","name":"æœ¨æœ¨"}]');
    let apiCfg = JSON.parse(localStorage.getItem('m_api_cfg') || '{"enabled":false,"url":"","key":""}');
    let wall = localStorage.getItem('m_wall') || '';  // å£çº¸å­˜çš„æ˜¯blob URLï¼Œåˆ·æ–°ä¼šå¤±æ•ˆï¼Œåç»­å¯æ”¹è¿›

    // ==================== æ ¸å¿ƒè·¯ç”± ====================
    function to(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'p-cal') renderCalendar();
    }

    function openMod(id) {
        if (id === 'm-api') {
            document.getElementById('api-toggle').checked = apiCfg.enabled;
            document.getElementById('api-url').value = apiCfg.url;
            document.getElementById('api-key').value = apiCfg.key;
        }
        document.getElementById(id).style.display = 'flex';
    }
    function closeMod(id) { document.getElementById(id).style.display = 'none'; }

    // ==================== æ¸²æŸ“æ‰€æœ‰åŠ¨æ€åˆ—è¡¨ ====================
    async function renderAll() {
        // ---------- ç›¸å†Œï¼ˆIndexedDB ç‰ˆï¼‰----------
        const box = document.getElementById('album-box');
        box.innerHTML = '';
        const fragment = document.createDocumentFragment();

        // photos æ•°ç»„é‡Œå­˜çš„æ˜¯å›¾ç‰‡ ID
        for (const id of photos) {
            const div = document.createElement('div');
            div.dataset.imgId = id;
            div.className = 'album-thumb';
            
            try {
                const fileBlob = await getImageFromDB(id);
                const url = URL.createObjectURL(fileBlob);
                div.style.backgroundImage = `url(${url})`;
                div.dataset.blobUrl = url; // ä¾¿äºé‡Šæ”¾
            } catch (e) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥', e);
                div.style.background = '#ccc';
            }
            
            fragment.appendChild(div);
        }
        box.appendChild(fragment);

        // ---------- çºªå¿µæ—¥ï¼ˆå®‰å…¨æ¸²æŸ“ + å”¯ä¸€IDï¼‰----------
        const aList = document.getElementById('anni-list');
        aList.innerHTML = '';
        annis.sort((a, b) => new Date(a.d) - new Date(b.d));
        annis.forEach(a => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.anniId = a.id;

            const leftSpan = document.createElement('span');
            leftSpan.textContent = `ğŸ“… ${a.d} ${a.t}`;

            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';

            item.appendChild(leftSpan);
            item.appendChild(delSpan);
            aList.appendChild(item);
        });

        // ---------- é€šè®¯å½•ï¼ˆå®‰å…¨æ¸²æŸ“ + å”¯ä¸€IDï¼‰----------
        const cList = document.getElementById('con-list');
        cList.innerHTML = '';
        cons.forEach(c => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.conId = c.id;

            const nameSpan = document.createElement('span');
            nameSpan.textContent = `ğŸ‘¤ ${c.name}`;

            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';

            item.appendChild(nameSpan);
            item.appendChild(delSpan);
            cList.appendChild(item);
        });
    }

    // ==================== ç›¸å†Œé€»è¾‘ï¼ˆIndexedDBç‰ˆï¼‰ ====================
    async function upImg(el) {
        const files = Array.from(el.files);
        for (const file of files) {
            if (file.size > 5 * 1024 * 1024) {
                alert(`å›¾ç‰‡ ${file.name} è¶…è¿‡ 5MBï¼Œè¯·å‹ç¼©åä¸Šä¼ `);
                continue;
            }
            const id = await saveImageToDB(file);
            photos.push(id);
        }
        localStorage.setItem('m_photos', JSON.stringify(photos));
        renderAll();
    }

    let currentImgId = null;   // å½“å‰æŸ¥çœ‹çš„å›¾ç‰‡ID
    let currentImgBlobUrl = null; // å½“å‰æŸ¥çœ‹çš„blob URLï¼Œç”¨äºé‡Šæ”¾

    async function viewImg(imgId) {
        try {
            const fileBlob = await getImageFromDB(parseInt(imgId));
            const url = URL.createObjectURL(fileBlob);
            // é‡Šæ”¾ä¹‹å‰çš„blob URLï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
            if (currentImgBlobUrl) URL.revokeObjectURL(currentImgBlobUrl);
            currentImgBlobUrl = url;
            currentImgId = imgId;
            document.getElementById('v-img').src = url;
            document.getElementById('viewer').style.display = 'flex';
        } catch (e) {
            alert('å›¾ç‰‡åŠ è½½å¤±è´¥');
        }
    }

    function closeViewer() {
        document.getElementById('viewer').style.display = 'none';
        // ä¸ç«‹å³é‡Šæ”¾blob URLï¼Œå› ä¸ºå¯èƒ½è®¾ä¸ºå£çº¸ï¼Œç­‰ä¸‹æ¬¡æŸ¥çœ‹æ—¶å†é‡Šæ”¾
    }

    async function setWallpaper() {
        if (!currentImgId) return;
        try {
            const fileBlob = await getImageFromDB(parseInt(currentImgId));
            const url = URL.createObjectURL(fileBlob);
            localStorage.setItem('m_wall', url);
            document.getElementById('p-home').style.background = `url(${url})`;
            alert('å£çº¸è®¾ç½®æˆåŠŸï¼');
            closeViewer();
        } catch (e) {
            alert('å£çº¸è®¾ç½®å¤±è´¥');
        }
    }

    // ==================== é€šè®¯å½• CRUDï¼ˆå”¯ä¸€IDï¼‰ ====================
    function saveCon() {
        const n = document.getElementById('cn').value;
        if (n) {
            cons.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                name: n
            });
            localStorage.setItem('m_cons', JSON.stringify(cons));
            renderAll();
            closeMod('m-con');
            document.getElementById('cn').value = '';
        }
    }
    function delCon(id) {
        if (confirm("ç¡®å®šåˆ é™¤è¯¥è”ç³»äººï¼Ÿ")) {
            const index = cons.findIndex(c => c.id === id);
            if (index !== -1) {
                cons.splice(index, 1);
                localStorage.setItem('m_cons', JSON.stringify(cons));
                renderAll();
            }
        }
    }

    // ==================== çºªå¿µæ—¥ CRUDï¼ˆå”¯ä¸€IDï¼‰ ====================
    function saveAnni() {
        const t = document.getElementById('at').value,
              d = document.getElementById('ad').value;
        if (t && d) {
            annis.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                t: t,
                d: d
            });
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
            closeMod('m-anni');
            document.getElementById('at').value = '';
            document.getElementById('ad').value = '';
        }
    }
    function delAnni(id) {
        const index = annis.findIndex(a => a.id === id);
        if (index !== -1) {
            annis.splice(index, 1);
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
        }
    }

    // ==================== æ—¥å†ç”Ÿæˆ ====================
    function renderCalendar() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        document.getElementById('cal-month').innerText = `${y}å¹´${m + 1}æœˆ`;

        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();

        const body = document.getElementById('cal-body');
        body.innerHTML = '';

        const fragment = document.createDocumentFragment();

        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => {
            const div = document.createElement('div');
            div.className = 'cal-weekday';
            div.textContent = w;
            fragment.appendChild(div);
        });

        for (let i = 0; i < firstDay; i++) {
            fragment.appendChild(document.createElement('div'));
        }

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${y}-${(m + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            const isToday = (d === now.getDate()) ? 'today' : '';
            const hasEvent = annis.some(a => a.d === dateStr) ? 'has-event' : '';

            const div = document.createElement('div');
            div.className = `cal-day ${isToday} ${hasEvent}`.trim();
            div.textContent = d;
            fragment.appendChild(div);
        }

        body.appendChild(fragment);
    }

    // ==================== èŠå¤©ä¸ AI ====================
    function saveApi() {
        apiCfg = {
            enabled: document.getElementById('api-toggle').checked,
            url: document.getElementById('api-url').value,
            key: document.getElementById('api-key').value
        };
        localStorage.setItem('m_api_cfg', JSON.stringify(apiCfg));
        closeMod('m-api');
    }

    async function sendMsg() {
        const input = document.getElementById('chat-in');
        const val = input.value.trim();
        if (!val) return;
        append('mine', val);
        input.value = '';

        if (!apiCfg.enabled) {
            setTimeout(() => append('other', "å·²æ”¶åˆ°æ¶ˆæ¯ï¼ˆå½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œå¯åœ¨è®¾ç½®ä¸­å¼€å¯AIï¼‰"), 600);
            return;
        }

        const tempBubble = append('other', "...");

        try {
            const res = await fetch(apiCfg.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiCfg.key}`
                },
                body: JSON.stringify({
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [
                        { role: "system", content: "ä½ å«æœ¨æœ¨ï¼Œæ¸©æŸ”ç®€ç»ƒã€‚" },
                        { role: "user", content: val }
                    ]
                })
            });
            const data = await res.json();
            tempBubble.textContent = data.choices[0].message.content;
        } catch (e) {
            tempBubble.textContent = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚";
        }
    }

    function append(side, text) {
        const flow = document.getElementById('chat-flow');
        const row = document.createElement('div');
        row.className = `msg-row ${side}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        row.appendChild(bubble);
        flow.appendChild(row);
        flow.scrollTop = flow.scrollHeight;
        return bubble;
    }

    // ==================== äº‹ä»¶ç›‘å¬ç»Ÿä¸€ç»‘å®š ====================
    function bindEvents() {
        // æ¡Œé¢å›¾æ ‡å¯¼èˆª
        document.querySelectorAll('.app-item[data-page]').forEach(el => {
            el.addEventListener('click', function() {
                to(this.dataset.page);
            });
        });

        // è¿”å›æŒ‰é’®
        document.querySelectorAll('.nav-back[data-home]').forEach(el => {
            el.addEventListener('click', function() {
                to(this.dataset.home);
            });
        });

        // æ‰“å¼€å¼¹çª—
        document.querySelectorAll('.nav-setting[data-mod], .nav-add[data-mod]').forEach(el => {
            el.addEventListener('click', function() {
                openMod(this.dataset.mod);
            });
        });

        // ä¸Šä¼ è§¦å‘
        document.getElementById('upload-trigger')?.addEventListener('click', function() {
            document.getElementById('up').click();
        });

        // å‘é€æŒ‰é’®
        document.getElementById('send-btn')?.addEventListener('click', sendMsg);
        document.getElementById('chat-in')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        // å¼¹çª—å–æ¶ˆæŒ‰é’®
        document.querySelectorAll('.modal-cancel').forEach(el => {
            el.addEventListener('click', function() {
                closeMod(this.dataset.mod);
            });
        });

        // ä¿å­˜é…ç½®æŒ‰é’®
        document.getElementById('save-api-btn')?.addEventListener('click', saveApi);
        document.getElementById('save-anni-btn')?.addEventListener('click', saveAnni);
        document.getElementById('save-con-btn')?.addEventListener('click', saveCon);

        // å£çº¸è®¾ç½®ã€å…³é—­æŸ¥çœ‹å™¨
        document.getElementById('set-wallpaper-btn')?.addEventListener('click', setWallpaper);
        document.getElementById('close-viewer-btn')?.addEventListener('click', closeViewer);

        // çºªå¿µæ—¥åˆ é™¤ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        document.getElementById('anni-list')?.addEventListener('click', function(e) {
            const delBtn = e.target.closest('.del-text');
            if (!delBtn) return;
            const item = delBtn.closest('.list-item');
            if (!item) return;
            const id = item.dataset.anniId;
            if (id) delAnni(id);
        });

        // é€šè®¯å½•åˆ é™¤ + è¿›å…¥èŠå¤©ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        document.getElementById('con-list')?.addEventListener('click', function(e) {
            const item = e.target.closest('.list-item');
            if (!item) return;
            const id = item.dataset.conId;
            if (!id) return;

            if (e.target.classList.contains('del-text')) {
                e.stopPropagation();
                delCon(id);
                return;
            }

            const contact = cons.find(c => c.id === id);
            const name = contact ? contact.name : 'è”ç³»äºº';
            to('p-chat');
            document.getElementById('chat-title').textContent = name;
        });

        // ç›¸å†Œç‚¹å‡»æŸ¥çœ‹ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        document.getElementById('album-box')?.addEventListener('click', function(e) {
            const thumb = e.target.closest('[data-imgId]');
            if (thumb) viewImg(thumb.dataset.imgId);
        });
    }

    // ==================== å®æ—¶æ—¶é’Ÿ ====================
    function updateClock() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('st-time').innerText = timeStr;
        document.getElementById('big-clock').innerText = timeStr;
        document.getElementById('big-date').innerText = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' });

        const hour = now.getHours();
        const isNight = hour >= 18 || hour < 6;
        document.getElementById('p-home').style.color = isNight ? "#fff" : "#000";
        document.getElementById('status-bar').style.color = isNight ? "#fff" : "#000";
    }

    // ==================== å¯åŠ¨ä¸€åˆ‡ ====================
    (async function init() {
        await openDB();
        // ä» localStorage è¯»å–å›¾ç‰‡ ID åˆ—è¡¨
        photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
        // å…¶ä»–æ•°æ®å·²å®šä¹‰
        if (wall) {
            // æ³¨æ„ï¼šwall å­˜çš„æ˜¯ blob URLï¼Œåˆ·æ–°åå¯èƒ½å¤±æ•ˆï¼Œå¯æ”¹è¿›ä¸ºå­˜IDï¼Œæ­¤å¤„æš‚æ—¶ä¿ç•™åŸé€»è¾‘
            document.getElementById('p-home').style.background = `url(${wall})`;
        }
        
        bindEvents();
        setInterval(updateClock, 1000);
        updateClock();
        await renderAll();
        renderCalendar();
    })();
</script>
</body>
</html>
