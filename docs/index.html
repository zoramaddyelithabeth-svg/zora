<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartOS Â· æ–°æ¡Œé¢Â·å…¨åŠŸèƒ½</title>
    <style>
/* æ¡Œé¢å›¾ç‰‡å°ç»„ä»¶ - ä»¿æˆªå›¾é£æ ¼ */
.photo-widget {
    background: var(--note-bg-white);
    border: 1px solid var(--note-border);
    border-radius: var(--note-radius-soft);
    box-shadow: 0 1px 3px var(--note-shadow-light);
    margin: 0 var(--note-spacing) 12px;
    width: calc(100% - 24px);
    height: 80px;  /* æˆªå›¾é‡Œçš„é«˜åº¦ï¼Œå¯è°ƒæ•´ */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    overflow: hidden;
    transition: var(--note-transition);
}
.photo-widget:hover {
    background: var(--note-hover);
}
.photo-widget-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--note-text-gray);
    font-size: 12px;
}
.photo-widget-placeholder span:first-child {
    font-size: 24px;
    margin-bottom: 4px;
}
.photo-widget-image {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
}
        /* ====== ğŸŒ¸ æç®€ä¾¿ç­¾Â·ç»Ÿä¸€ä¸»é¢˜ ====== */
        :root {
            --theme-primary: #AED5F3 !important;
            --theme-soft-bg: rgba(174, 213, 243, 0.1);
            --note-bg-light: #F9F9F9;
            --note-bg-white: #FFFFFF;
            --note-accent: #AED5F3;
            --note-pearl: #F5F0E6;
            --note-hover: #F5F5F5;
            --note-text-dark: #222222;
            --note-text-gray: #8E8E93;
            --note-border: #E5E5E5;
            --note-shadow-light: rgba(0, 0, 0, 0.05);
            --note-shadow-dark: rgba(0, 0, 0, 0.1);
            --note-radius-soft: 12px;
            --note-radius-hard: 8px;
            --note-spacing: 12px;
            --note-transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            --wechat-green: var(--theme-primary);
            --ios-blue: var(--theme-primary);
            --ios-red: #FF3B30;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Helvetica Neue", -apple-system, sans-serif !important; }
        body { background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .app-container {
            width: 100%; height: 100%; background: var(--note-bg-light); position: relative;
            overflow: hidden; display: flex; flex-direction: column;
        }
        @media (min-width: 600px) {
            .app-container { max-width: 375px; height: 812px; border-radius: 40px; border: 8px solid #333; }
        }

        /* ----- çŠ¶æ€æ  ----- */
        .status-bar {
            height: 44px; padding: 14px 20px 0; display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; font-weight: 600; z-index: 1000; position: absolute; top: 0; width: 100%;
            color: var(--note-text-dark) !important;
        }

        /* ----- å¯¼èˆªæ ï¼ˆç»Ÿä¸€å¡ç‰‡ï¼‰----- */
        .nav-bar {
            height: 50px; background: var(--note-bg-white) !important;
            border: 1px solid var(--note-border) !important; border-radius: var(--note-radius-soft) !important;
            box-shadow: 0 1px 3px var(--note-shadow-light) !important;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            flex-shrink: 0; margin: var(--note-spacing) var(--note-spacing) 0 !important; width: calc(100% - 24px);
        }
        .nav-bar span, .nav-bar b { color: var(--note-text-dark) !important; }
        .nav-bar span[style*="color:var(--ios-blue)"] { color: var(--theme-primary) !important; }

        /* ----- é¡µé¢å®¹å™¨ ----- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--note-bg-light) !important; display: none; flex-direction: column;
            z-index: 10; padding-top: 44px;
        }
        .page.active { display: flex; }

        /* ====== ğŸ  æ–°æ¡Œé¢ï¼ˆä»¿æˆªå›¾ï¼‰====== */
        .home-bg {
            transition: background 0.8s ease;
            background-size: cover !important;
            background-position: center !important;
            display: flex;
            flex-direction: column;
            padding-top: 44px;
            height: 100%;
        }
        .home-clock {
            text-align: center;
            padding: 20px 0 10px;
            color: var(--note-text-dark) !important;
        }
        .home-clock h1 {
            font-size: 82px;
            font-weight: 300;
            letter-spacing: 2px;
            line-height: 1;
            margin-bottom: 5px;
        }
        .home-clock p {
            font-size: 20px;
            font-weight: 400;
            color: var(--note-text-gray);
            margin-top: 0;
        }
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px 25px;
            flex: 1;
        }

<!-- å›¾ç‰‡å°ç»„ä»¶ï¼šç‚¹å‡»æ·»åŠ å›¾ç‰‡ï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾ -->
<div class="photo-widget" id="desktop-photo-widget">
    <div class="photo-widget-placeholder" id="photo-widget-placeholder">
        <span>ğŸ“·</span>
        <span>ç‚¹å‡»æ·»åŠ å›¾ç‰‡</span>
    </div>
    <div class="photo-widget-image" id="photo-widget-image" style="display: none;"></div>
</div>
        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .app-item:active { transform: scale(0.9); }
        .app-icon {
            width: 60px;
            height: 60px;
            background: var(--note-bg-white) !important;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 1px solid var(--note-border) !important;
            box-shadow: 0 2px 4px var(--note-shadow-light) !important;
            color: var(--note-text-dark) !important;
            margin-bottom: 8px;
        }
        .app-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--note-text-dark) !important;
        }
        /* åº•éƒ¨å¯¼èˆªæ ï¼ˆçŸ­ä¿¡Â·è®¾ç½®Â·è®°å¿†ï¼‰ */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--note-bg-white) !important;
            border-top: 1px solid var(--note-border) !important;
            border-radius: 0 0 var(--note-radius-soft) var(--note-radius-soft) !important;
            padding: 8px 16px;
            margin: 0 var(--note-spacing) var(--note-spacing) !important;
            width: calc(100% - 24px);
            box-shadow: 0 -1px 3px var(--note-shadow-light) !important;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--note-text-gray);
            font-size: 11px;
        }
        .bottom-nav-item i {
            font-size: 22px;
            margin-bottom: 2px;
            color: var(--note-text-gray);
        }
        .bottom-nav-item.active i,
        .bottom-nav-item.active span {
            color: var(--theme-primary) !important;
        }

        /* ----- ç›¸å†Œå¡ç‰‡ç½‘æ ¼ï¼ˆå…¨åŠŸèƒ½ï¼‰----- */
        #album-box {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 2px 0;
            overflow-y: auto; flex: 1; background: var(--note-bg-light) !important;
        }
        #album-box div {
            aspect-ratio: 1/1; background-size: cover; background-position: center; transition: opacity 0.2s;
            border: 1px solid var(--note-border) !important; border-radius: var(--note-radius-hard) !important;
        }
        #album-box div:active { opacity: 0.7; }

        /* ----- æ—¥å†å¡ç‰‡ï¼ˆå…¨åŠŸèƒ½ï¼‰----- */
        .cal-header {
            background: var(--note-bg-white) !important; padding: 15px; text-align: center;
            border-bottom: 1px solid var(--note-border) !important;
            border-radius: var(--note-radius-soft) var(--note-radius-soft) 0 0 !important;
            margin: var(--note-spacing) var(--note-spacing) 0 !important; width: calc(100% - 24px);
        }
        .cal-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); background: var(--note-bg-white) !important;
            padding: 10px; border: 1px solid var(--note-border) !important; border-top: none;
            border-radius: 0 0 var(--note-radius-soft) var(--note-radius-soft) !important;
            margin: 0 var(--note-spacing) var(--note-spacing) !important; width: calc(100% - 24px);
            box-shadow: 0 1px 3px var(--note-shadow-light) !important;
        }
        .cal-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px;
            position: relative; color: var(--note-text-dark) !important;
        }
        .cal-day.today { background: var(--theme-primary) !important; color: #fff !important; border-radius: 50%; }
        .cal-day.has-event::after {
            content: ''; width: 4px; height: 4px; background: var(--note-text-gray) !important;
            border-radius: 50%; position: absolute; bottom: 4px;
        }
        .cal-weekday {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px;
            color: var(--note-text-gray) !important; font-weight: 600;
        }

        /* ----- é€šè®¯å½•/çºªå¿µæ—¥å¡ç‰‡åˆ—è¡¨ï¼ˆå…¨åŠŸèƒ½ï¼‰----- */
        .list-item {
            padding: 15px; border-bottom: 1px solid var(--note-border) !important;
            background: var(--note-bg-white) !important; display: flex; align-items: center;
            justify-content: space-between; font-size: 16px; color: var(--note-text-dark) !important;
            border-radius: var(--note-radius-soft) !important; margin: 8px var(--note-spacing) !important;
            width: calc(100% - 24px); box-shadow: 0 1px 3px var(--note-shadow-light) !important;
        }
        .del-text { color: var(--note-text-gray) !important; font-size: 14px; font-weight: 500; padding: 5px; }

        /* ----- èŠå¤©åŒºåŸŸï¼ˆçº¯ç™½ä¾¿ç­¾æ°”æ³¡ï¼‰----- */
        #chat-flow {
            flex: 1; overflow-y: auto; background: var(--note-bg-light) !important;
            padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }
        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.other .bubble, .msg-row.mine .bubble {
            background: var(--note-bg-white) !important; color: var(--note-text-dark) !important;
            border: 1px solid var(--note-border) !important; box-shadow: 0 2px 4px var(--note-shadow-light) !important;
            padding: 14px 18px !important; position: relative; border-radius: 8px 8px 12px 8px !important;
        }
        .msg-row.other .bubble { transform: perspective(100px) rotateY(1deg); }
        .msg-row.mine .bubble { transform: perspective(100px) rotateY(-1deg); border-radius: 8px 8px 8px 12px !important; }
        .msg-row.other .bubble::after, .msg-row.mine .bubble::after {
            content: ""; position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0L10 0L10 10L0 10Z' fill='%23F8F8F8' fill-opacity='0.1'/%3E%3C/svg%3E");
            background-size: 20px 20px; pointer-events: none; border-radius: inherit;
        }
        .msg-row.other .bubble::before {
            content: ""; position: absolute; top: 12px; left: 15px; width: 14px; height: 14px;
            background: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 14 14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 0L8 3L10 3L9 5L11 7L9 7L8 9L7 7L5 7L7 5L6 3L8 3L7 0Z' fill='%23AED5F3' fill-opacity='0.8'/%3E%3C/svg%3E") center no-repeat;
        }
        .msg-row.mine .bubble::before {
            content: ""; position: absolute; top: 12px; right: 15px; width: 14px; height: 14px;
            background: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 14 14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 5L9 3L11 5L10 7L12 9L10 11L8 9L7 11L5 9L3 11L1 9L3 7L2 5L4 3L6 5Z' fill='%23F5F0E6' fill-opacity='0.8'/%3E%3C/svg%3E") center no-repeat;
        }
        .msg-time { font-size: 10px; color: var(--note-text-gray) !important; margin-top: 4px; text-align: right; display: block; }

        /* ----- å¤§å›¾æŸ¥çœ‹å™¨ ----- */
        #viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #viewer img { max-width: 100%; max-height: 85%; object-fit: contain; }
        .viewer-btns { position: absolute; bottom: 60px; display: flex; gap: 20px; z-index: 2001; }
        .v-btn { padding: 12px 25px; border-radius: 25px; background: rgba(255,255,255,0.25); color: #fff; border: none; backdrop-filter: blur(15px); font-size: 14px; }

        /* ----- å¼¹çª—ï¼ˆä¾¿ç­¾å¡ç‰‡ï¼‰----- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            z-index: 1500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-body {
            width: 85%; max-height: 80%; overflow-y: auto;
            background: var(--note-bg-white) !important; border: 1px solid var(--note-border) !important;
            border-radius: var(--note-radius-soft) !important; padding: 25px;
            box-shadow: 0 4px 12px var(--note-shadow-dark) !important;
        }
        .modal-body h3 { margin-bottom: 10px; color: var(--note-text-dark) !important; }
        .modal-body input, .modal-body select, .modal-body textarea {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--note-border) !important;
            border-radius: var(--note-radius-hard) !important; outline: none; font-size: 16px;
            background: var(--note-bg-white) !important; color: var(--note-text-dark) !important;
        }
        .modal-btn {
            width: 100%; padding: 14px; background: var(--theme-primary) !important; color: #fff !important;
            border: none !important; border-radius: var(--note-radius-hard) !important; margin-top: 10px;
            font-weight: 600; cursor: pointer;
        }
        .modal-cancel {
            width: 100%; background: none; border: none; margin-top: 10px; color: var(--note-text-gray) !important;
            cursor: pointer;
        }

        /* ----- ä¸»é¢˜è‰²é€‰æ‹©å™¨ ----- */
        .theme-color-option {
            display: inline-block; width: 40px; height: 40px; border-radius: 50%; margin: 5px;
            cursor: pointer; border: 3px solid transparent; transition: border 0.2s;
        }
        .theme-color-option.active { border: 3px solid #333; }
        .theme-color-picker { margin: 15px 0 5px; }

        /* ----- ä¸ªäººèµ„æ–™å¡ç‰‡ï¼ˆå…¨åŠŸèƒ½ï¼‰----- */
        .profile-card {
            background: var(--note-bg-white) !important;
            border: 1px solid var(--note-border) !important;
            border-radius: var(--note-radius-soft) !important;
            box-shadow: 0 2px 8px var(--note-shadow-light) !important;
            margin: var(--note-spacing);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            background: var(--note-bg-light); border: 2px solid var(--note-border) !important;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--note-text-gray); cursor: pointer; margin-bottom: 10px;
            overflow: hidden;
        }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 20px; font-weight: 600; color: var(--note-text-dark); margin-bottom: 4px; }
        .profile-signature { font-size: 14px; color: var(--note-text-gray); margin-bottom: 20px; }
        .profile-info-item {
            width: 100%; display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--note-border); cursor: pointer;
        }
        .profile-info-item:last-child { border-bottom: none; }
        .profile-info-label { color: var(--note-text-gray); font-size: 15px; }
        .profile-info-value {
            color: var(--note-text-dark); font-size: 15px; font-weight: 500;
            max-width: 60%; text-align: right; word-break: break-word;
        }
        .profile-link-item {
            width: 100%; display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid var(--note-border); color: var(--note-text-dark); cursor: pointer;
        }
        .profile-link-item i { margin-right: 12px; color: var(--theme-primary); width: 20px; text-align: center; }
        .profile-section-title {
            width: 100%; font-size: 16px; font-weight: 600; color: var(--note-text-dark);
            margin-top: 20px; margin-bottom: 10px;
        }

        /* ----- å¤–è§‚è®¾ç½®é¢æ¿ ----- */
        .appearance-section {
            background: var(--note-bg-white); border-radius: var(--note-radius-soft);
            border: 1px solid var(--note-border); padding: 16px; margin-top: 12px; width: 100%;
        }
        .appearance-item {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
        }
        .appearance-label { color: var(--note-text-dark); font-size: 15px; }
        .font-size-slider { width: 120px; }

        /* ----- è¡¨æƒ…åŒ…åº“ç½‘æ ¼ ----- */
        .emoticon-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;
        }
        .emoticon-item {
            border: 1px solid var(--note-border); border-radius: var(--note-radius-hard);
            padding: 8px; cursor: pointer; transition: var(--note-transition);
        }
        .emoticon-item:hover { background: var(--note-hover); transform: scale(0.98); }
        .emoticon-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; }
        .emoticon-name {
            font-size: 12px; color: var(--note-text-gray); margin-top: 5px; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ----- éŸ³ä¹æ’­æ”¾å™¨ï¼ˆæ”¯æŒæ·»åŠ è‡ªå®šä¹‰ï¼‰----- */
        .music-add-section {
            display: flex; flex-direction: column; gap: 8px; margin: 15px 0;
        }
        .music-add-row {
            display: flex; gap: 6px; align-items: center;
        }
        .music-add-row input {
            flex: 1; margin: 0;
        }
        .music-list {
            list-style: none; padding: 0; margin: 15px 0; max-height: 300px; overflow-y: auto;
        }
        .music-item {
            display: flex; align-items: center; padding: 10px;
            border-bottom: 1px solid var(--note-border); cursor: pointer;
        }
        .music-item:hover { background: var(--note-hover); }
        .music-item .play-icon { margin-right: 10px; color: var(--theme-primary); }
        .music-item .title { flex: 1; color: var(--note-text-dark); font-weight: 500; }
        .music-item .artist { color: var(--note-text-gray); font-size: 12px; margin-right: 10px; }
        .music-delete-btn {
            color: var(--note-text-gray); font-size: 16px; padding: 0 5px;
        }
        .music-delete-btn:hover { color: var(--ios-red); }

        /* ----- æ—¥è®°æ¡ç›®æ ·å¼ ----- */
        .diary-entry {
            background: var(--note-bg-white);
            border-radius: var(--note-radius-soft);
            border: 1px solid var(--note-border);
            padding: 16px;
            margin: var(--note-spacing);
            width: calc(100% - 24px);
        }
        /* ----- çŸ­ä¿¡åˆ—è¡¨æ ·å¼ ----- */
        .sms-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--note-spacing);
        }
        .sms-item {
            background: var(--note-bg-white);
            border-radius: var(--note-radius-soft);
            border: 1px solid var(--note-border);
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        /* ----- è¾“å…¥æ¡†ç­‰ ----- */
        #chat-in {
            background: var(--note-bg-white) !important;
            border: 1px solid var(--note-border) !important;
            border-radius: var(--note-radius-hard) !important;
            padding: 12px !important;
        }
        #send-btn {
            background: var(--theme-primary) !important;
            color: white !important;
            border: none !important;
            border-radius: var(--note-radius-hard) !important;
            padding: 0 15px;
            font-size: 14px;
        }
        iframe {
            border: none !important;
            background: var(--note-bg-white) !important;
            border-radius: var(--note-radius-soft) !important;
            margin: var(--note-spacing);
            width: calc(100% - 24px);
            height: calc(100% - 88px);
        }
/* ----- è®ºå›ä¸–ç•Œè§‚é£æ ¼ï¼ˆæ‰“å·¥æ‘¸é±¼ï¼‰----- */
.forum-header {
    background: var(--note-bg-white);
    border-bottom: 1px solid var(--note-border);
    padding: 16px var(--note-spacing);
    margin: 0 var(--note-spacing) var(--note-spacing);
    border-radius: var(--note-radius-soft);
    box-shadow: 0 1px 3px var(--note-shadow-light);
}
.forum-slogan {
    color: var(--note-text-dark);
    font-size: 14px;
    font-style: italic;
    margin-bottom: 8px;
}
.forum-tags {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: var(--note-text-gray);
}
.forum-sections {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 var(--note-spacing);
    margin-bottom: 20px;
}
.section-card {
    background: var(--note-bg-white);
    border: 1px solid var(--note-border);
    border-radius: var(--note-radius-soft);
    padding: 16px 12px;
    cursor: pointer;
    transition: var(--note-transition);
}
.section-card:hover {
    background: var(--note-hover);
    transform: translateY(-2px);
}
.section-card .icon {
    font-size: 28px;
    margin-bottom: 6px;
}
.section-card .name {
    font-weight: 600;
    color: var(--note-text-dark);
    margin-bottom: 4px;
}
.section-card .desc {
    font-size: 12px;
    color: var(--note-text-gray);
}
.section-card.locked {
    opacity: 0.6;
    filter: grayscale(0.5);
}
.forum-current-section {
    flex: 1;
    overflow-y: auto;
    padding: 0 var(--note-spacing);
}
.section-header {
    font-size: 18px;
    font-weight: 600;
    color: var(--note-text-dark);
    padding: 8px 0;
    border-bottom: 1px solid var(--note-border);
    margin-bottom: 12px;
}
.forum-posts {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.post-card {
    background: var(--note-bg-white);
    border: 1px solid var(--note-border);
    border-radius: var(--note-radius-soft);
    padding: 14px;
    box-shadow: 0 1px 2px var(--note-shadow-light);
}
.post-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--note-text-gray);
}
.post-author {
    font-weight: 500;
    color: var(--note-accent);
}
.post-content {
    color: var(--note-text-dark);
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 8px;
    word-wrap: break-word;
}
.post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--note-text-gray);
}
.post-stats span {
    margin-right: 12px;
}
.forum-post-btn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: var(--theme-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: var(--note-transition);
    z-index: 100;
}
.forum-post-btn:hover {
    transform: scale(1.1);
}
/* åŒ¿åæ ‡ç­¾ */
.anonymous-badge {
    background: var(--note-hover);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    color: var(--note-text-gray);
    margin-left: 6px;
}
    </style>
</head>
<body>
<div class="app-container">
    <div class="status-bar" id="status-bar">
        <span id="st-time">00:00</span>
        <div>ğŸ“¶ ğŸ”‹</div>
    </div>

    <!-- ========== ğŸ  æ–°æ¡Œé¢ï¼ˆè¶…å¤§æ—¶é’Ÿ + 8ä¸ªåº”ç”¨ + åº•éƒ¨å¯¼èˆªï¼‰ ========== -->
    <div class="page active home-bg" id="p-home">
        <div class="home-clock">
            <h1 id="big-clock">00:00</h1>
            <p id="big-date"></p>
        </div>
        <div class="app-grid">
            <!-- åŸæœ‰6ä¸ªåº”ç”¨ -->
            <div class="app-item" data-page="p-chat"><div class="app-icon">ğŸ’¬</div><div class="app-name">å¾®ä¿¡</div></div>
            <div class="app-item" data-page="p-album"><div class="app-icon">ğŸ–¼ï¸</div><div class="app-name">ç›¸å†Œ</div></div>
            <div class="app-item" data-page="p-cal"><div class="app-icon">ğŸ“…</div><div class="app-name">æ—¥å†</div></div>
            <div class="app-item" data-page="p-con"><div class="app-icon">ğŸ‘¥</div><div class="app-name">é€šè®¯å½•</div></div>
            <div class="app-item" data-page="p-safari"><div class="app-icon">ğŸŒ</div><div class="app-name">Safari</div></div>
            <div class="app-item" data-page="p-profile"><div class="app-icon">ğŸ‘¤</div><div class="app-name">ä¸ªäºº</div></div>
            <!-- ğŸ†• æ–°å¢2ä¸ªåº”ç”¨ -->
            <div class="app-item" data-page="p-forum"><div class="app-icon">ğŸ—£ï¸</div><div class="app-name">è®ºå›</div></div>
            <div class="app-item" data-page="p-diary"><div class="app-icon">ğŸµ</div><div class="app-name">éŸ³ä¹</div></div>
        </div>
        <!-- åº•éƒ¨å¯¼èˆªæ ï¼ˆçŸ­ä¿¡Â·è®¾ç½®Â·è®°å¿†ï¼‰ -->
        <div class="bottom-nav">
            <div class="bottom-nav-item" id="bottom-sms">
                <i>ğŸ’¬</i>
                <span>çŸ­ä¿¡</span>
            </div>
            <div class="bottom-nav-item" id="bottom-settings">
                <i>âš™ï¸</i>
                <span>è®¾ç½®</span>
            </div>
            <div class="bottom-nav-item" id="bottom-memory">
                <i>ğŸ““</i>
                <span>éŸ³ä¹</span>
            </div>
        </div>
    </div>

    <!-- ========== èŠå¤©é¡µé¢ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ========== -->
    <div class="page" id="p-chat">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b id="chat-title">è¯·é€‰æ‹©è”ç³»äºº</b>
            <span class="nav-setting" data-mod="m-api" style="color:var(--ios-blue); font-size:13px;">è®¾ç½®</span>
        </div>
        <div id="chat-flow"></div>
        <div style="padding:10px; background:#f7f7f7; display:flex; gap:10px; padding-bottom: 25px;">
            <input type="text" id="chat-in" placeholder="ç”¨å›è½¦å‘é€..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button id="send-btn" style="background:var(--theme-primary); color:#fff; border:none; padding:0 15px; border-radius:8px;">å‘é€</button>
        </div>
    </div>

    <!-- ========== ç›¸å†Œé¡µé¢ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ========== -->
    <div class="page" id="p-album">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ‰€æœ‰ç…§ç‰‡</b>
            <span id="upload-trigger" style="color:var(--ios-blue)">ä¸Šä¼ </span>
        </div>
        <input type="file" id="up" hidden multiple accept="image/*">
        <div id="album-box"></div>
    </div>

    <!-- ========== æ—¥å†é¡µé¢ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ========== -->
    <div class="page" id="p-cal">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ—¥å†</b>
            <span class="nav-add" data-mod="m-anni" style="color:var(--ios-blue)">æ·»åŠ </span>
        </div>
        <div class="cal-header"><h3 id="cal-month"></h3></div>
        <div class="cal-grid" id="cal-body"></div>
        <div id="anni-list" style="flex:1; overflow-y:auto; background:#fff;"></div>
    </div>

    <!-- ========== é€šè®¯å½•é¡µé¢ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ========== -->
    <div class="page" id="p-con">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>é€šè®¯å½•</b>
            <span class="nav-add" data-mod="m-con" style="color:var(--ios-blue)">â•</span>
        </div>
        <div id="con-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- ========== Safarié¡µé¢ ========== -->
    <div class="page" id="p-safari">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b>æµè§ˆå™¨</b>
        </div>
        <iframe src="https://m.bing.com" style="flex:1; border:none;"></iframe>
    </div>

    <!-- ========== ä¸ªäººèµ„æ–™é¡µé¢ï¼ˆå®Œæ•´ä¿ç•™ï¼šå¤´åƒ/æ˜µç§°/ç­¾å/åœ°åŒº/ç”Ÿæ—¥/è¡¨æƒ…åŒ…åº“/Music/å¤–è§‚ï¼‰ ========== -->
    <div class="page" id="p-profile">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>ä¸ªäººèµ„æ–™</b>
            <span style="width:40px;"></span>
        </div>
        <div style="flex:1; overflow-y: auto; padding: 0 var(--note-spacing);">
            <div class="profile-card">
                <div class="profile-avatar" id="profile-avatar">ğŸ‘¤</div>
                <div class="profile-name" id="profile-nickname">éŸ©é—»ç†™</div>
                <div class="profile-signature" id="profile-signature">PrettyWhenuCry</div>
                <div class="profile-info-item" onclick="openMod('m-profile-nickname')"><span class="profile-info-label">æ˜µç§°</span><span class="profile-info-value" id="profile-nickname-value">éŸ©é—»ç†™</span></div>
                <div class="profile-info-item" onclick="openMod('m-profile-signature')"><span class="profile-info-label">ä¸ªæ€§ç­¾å</span><span class="profile-info-value" id="profile-signature-value">PrettyWhenuCry</span></div>
                <div class="profile-info-item" onclick="openMod('m-profile-region')"><span class="profile-info-label">åœ°åŒº</span><span class="profile-info-value" id="profile-region-value">å†°å²›</span></div>
                <div class="profile-info-item" onclick="openMod('m-profile-birthday')"><span class="profile-info-label">ç”Ÿæ—¥</span><span class="profile-info-value" id="profile-birthday-value">03-14</span></div>
                <div class="profile-section-title">æ›´å¤šæœåŠ¡</div>
                <div class="profile-link-item" id="emoticon-library-link"><i>ğŸ˜Š</i> è¡¨æƒ…åŒ…åº“</div>
                <div class="profile-link-item" id="music-link"><i>ğŸµ</i> Music</div>
                <div class="profile-section-title">å¤–è§‚è®¾ç½®</div>
                <div class="appearance-section">
                    <div class="appearance-item"><span class="appearance-label">ä¸»é¢˜é¢œè‰²</span><span onclick="openMod('m-api')" style="color:var(--theme-primary); cursor:pointer;">è‡ªå®šä¹‰</span></div>
                    <div class="appearance-item"><span class="appearance-label">èŠå¤©èƒŒæ™¯</span><span onclick="document.getElementById('up-wallpaper').click()" style="color:var(--theme-primary); cursor:pointer;">æ›´æ¢</span><input type="file" id="up-wallpaper" hidden accept="image/*"></div>
                    <div class="appearance-item"><span class="appearance-label">æ°”æ³¡æ ·å¼</span><span onclick="openMod('m-bubble-style')" style="color:var(--theme-primary); cursor:pointer;">ä¾¿ç­¾</span></div>
                    <div class="appearance-item"><span class="appearance-label">å­—ä½“å¤§å°</span><input type="range" min="12" max="20" value="15" class="font-size-slider" id="font-size-slider"></div>
                </div>
            </div>
        </div>
    </div>

  <!-- ========== æ‰“å·¥äººæ‘¸é±¼è®ºå› ========== -->
<div class="page" id="p-forum">
    <div class="nav-bar">
        <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
        <b>æ‰“å·¥äººæ‘¸é±¼è®ºå›</b>
        <span onclick="openMod('m-forum-world')" style="color:var(--ios-blue); font-size:13px;">ğŸŒ ä¸–ç•Œè§‚</span>
    </div>
    <!-- è®ºå›å¤´éƒ¨ï¼šå£å·ã€æ–‡åŒ–ç¬¦å· -->
    <div class="forum-header">
        <div class="forum-slogan">â€œåœ¨è¿™é‡Œï¼Œæ¯ä¸€æ®µæ¼‚æµéƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„é å²¸â€</div>
        <div class="forum-tags">
            <span>ğŸ£ é’“é±¼</span>
            <span>ğŸ¤¿ æ½œæ°´</span>
            <span>ğŸŠ æ¼‚æµ</span>
            <span>â›µ ä¸Šå²¸</span>
        </div>
    </div>
    <!-- åˆ†åŒºå¯¼èˆªå¡ç‰‡ -->
    <div class="forum-sections" id="forum-sections"></div>
    <!-- å½“å‰åˆ†åŒºå¸–å­åˆ—è¡¨ -->
    <div class="forum-current-section">
        <div class="section-header" id="forum-section-header"></div>
        <div class="forum-posts" id="forum-posts"></div>
    </div>
    <!-- å‘å¸–æŒ‰é’®ï¼ˆæ‚¬æµ®ï¼‰ -->
    <div class="forum-post-btn" onclick="openForumPostModal()">
        <span>âœï¸</span>
    </div>
</div>

    <!-- ========== ğŸ†• æ—¥è®°æœ¬é¡µé¢ï¼ˆå…¨åŠŸèƒ½ï¼‰ ========== -->
    <div class="page" id="p-diary">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ—¥è®°æœ¬</b>
            <span onclick="openMod('m-diary-add')" style="color:var(--ios-blue); cursor:pointer;">â•</span>
        </div>
        <div id="diary-list" style="flex:1; overflow-y: auto; padding: var(--note-spacing);"></div>
    </div>

    <!-- ========== ğŸ†• çŸ­ä¿¡é¡µé¢ï¼ˆå…¨åŠŸèƒ½ï¼‰ ========== -->
    <div class="page" id="p-sms">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>çŸ­ä¿¡</b>
            <span onclick="openMod('m-sms-compose')" style="color:var(--ios-blue); cursor:pointer;">âœï¸</span>
        </div>
        <div id="sms-list" class="sms-list"></div>
    </div>

    <!-- ========== è¡¨æƒ…åŒ…åº“å¼¹çª— ========== -->
    <div class="modal" id="m-emoticon-library">
        <div class="modal-body">
            <h3>ğŸ˜Š è¡¨æƒ…åŒ…åº“</h3>
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <input type="text" id="emoticon-url" placeholder="å›¾ç‰‡URL">
                <input type="text" id="emoticon-name" placeholder="è¡¨æƒ…åç§°" style="flex:0.8;">
                <button class="modal-btn" id="add-emoticon-btn" style="width:auto; padding:12px 16px; margin-top:0;">æ·»åŠ </button>
            </div>
            <div id="emoticon-grid" class="emoticon-grid"></div>
            <button class="modal-cancel" data-mod="m-emoticon-library" style="margin-top:20px;">å…³é—­</button>
        </div>
    </div>

    <!-- ========== Music å¼¹çª— ========== -->
    <div class="modal" id="m-music-player">
        <div class="modal-body">
            <h3>ğŸµ æˆ‘çš„éŸ³ä¹</h3>
            <div style="margin:15px 0;">
                <audio id="music-audio" controls style="width:100%;"></audio>
            </div>
            <div class="music-add-section">
                <div class="music-add-row">
                    <input type="text" id="music-title" placeholder="æ­Œæ›²å">
                    <input type="text" id="music-artist" placeholder="æ­Œæ‰‹">
                </div>
                <div class="music-add-row">
                    <input type="text" id="music-url" placeholder="éŸ³é¢‘URLï¼ˆhttp://...ï¼‰">
                    <button class="modal-btn" id="add-music-btn" style="width:auto; padding:12px 16px; margin-top:0;">æ·»åŠ </button>
                </div>
            </div>
            <ul class="music-list" id="music-list"></ul>
            <button class="modal-cancel" data-mod="m-music-player">å…³é—­</button>
        </div>
    </div>

    <!-- æ—¥è®°æ·»åŠ å¼¹çª— -->
    <div class="modal" id="m-diary-add">
        <div class="modal-body">
            <h3>å†™æ—¥è®°</h3>
            <textarea id="diary-content" rows="5" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ" style="resize: vertical;"></textarea>
            <button class="modal-btn" id="save-diary-btn">ä¿å­˜</button>
            <button class="modal-cancel" data-mod="m-diary-add" style="margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- çŸ­ä¿¡ç¼–å†™å¼¹çª— -->
    <div class="modal" id="m-sms-compose">
        <div class="modal-body">
            <h3>æ–°çŸ­ä¿¡</h3>
            <input type="text" id="sms-contact" placeholder="è”ç³»äºº">
            <textarea id="sms-content" rows="3" placeholder="çŸ­ä¿¡å†…å®¹"></textarea>
            <button class="modal-btn" id="send-sms-btn">å‘é€</button>
            <button class="modal-cancel" data-mod="m-sms-compose">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä¸ªäººèµ„æ–™ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="m-profile-nickname"><div class="modal-body"><h3>ä¿®æ”¹æ˜µç§°</h3><input type="text" id="profile-nickname-input" placeholder="è¾“å…¥æ–°æ˜µç§°" value="éŸ©é—»ç†™"><button class="modal-btn" id="save-profile-nickname-btn">ä¿å­˜</button><button class="modal-cancel" data-mod="m-profile-nickname" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>
    <div class="modal" id="m-profile-signature"><div class="modal-body"><h3>ä¿®æ”¹ä¸ªæ€§ç­¾å</h3><input type="text" id="profile-signature-input" placeholder="è¾“å…¥æ–°ç­¾å" value="PrettyWhenuCry"><button class="modal-btn" id="save-profile-signature-btn">ä¿å­˜</button><button class="modal-cancel" data-mod="m-profile-signature" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>
    <div class="modal" id="m-profile-region"><div class="modal-body"><h3>ä¿®æ”¹åœ°åŒº</h3><input type="text" id="profile-region-input" placeholder="çœ/å¸‚" value="å†°å²›"><button class="modal-btn" id="save-profile-region-btn">ä¿å­˜</button><button class="modal-cancel" data-mod="m-profile-region" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>
    <div class="modal" id="m-profile-birthday"><div class="modal-body"><h3>ä¿®æ”¹ç”Ÿæ—¥</h3><input type="date" id="profile-birthday-input" value="2000-03-14"><button class="modal-btn" id="save-profile-birthday-btn">ä¿å­˜</button><button class="modal-cancel" data-mod="m-profile-birthday" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>
    <div class="modal" id="m-bubble-style"><div class="modal-body"><h3>æ°”æ³¡æ ·å¼</h3><select id="bubble-style-select"><option value="note">ä¾¿ç­¾æ¢¯å½¢ï¼ˆå½“å‰ï¼‰</option><option value="round">åœ†è§’æ ‡å‡†</option><option value="simple">æç®€è¾¹æ¡†</option></select><button class="modal-btn" id="save-bubble-style-btn">åº”ç”¨</button><button class="modal-cancel" data-mod="m-bubble-style" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>

    <!-- AIè®¾ç½®å¼¹çª—ï¼ˆä¸»é¢˜è‰²ï¼‰ -->
    <div class="modal" id="m-api">
        <div class="modal-body">
            <h3>âš™ï¸ è®¾ç½®ä¸ä¸»é¢˜</h3>
            <label style="display:block; margin-bottom:8px;"><input type="checkbox" id="api-toggle"> å¼€å¯ AI å“åº”</label>
            <input type="text" id="api-url" placeholder="API URL (å« v1/chat/completions)">
            <input type="password" id="api-key" placeholder="API Key">
            <div style="margin: 20px 0 10px; border-top:1px solid #eee; padding-top:15px;">
                <h4 style="margin-bottom:10px;">ğŸ¨ ä¸»é¢˜é¢œè‰²</h4>
                <div id="theme-color-presets" class="theme-color-picker">
                    <div class="theme-color-option" style="background:#AED5F3;" data-color="#AED5F3" title="ä¾¿ç­¾è“"></div>
                    <div class="theme-color-option" style="background:#5856D6;" data-color="#5856D6" title="ç´«è‰²"></div>
                    <div class="theme-color-option" style="background:#FF2D55;" data-color="#FF2D55" title="ç²‰è‰²"></div>
                    <div class="theme-color-option" style="background:#FF9500;" data-color="#FF9500" title="æ©™è‰²"></div>
                    <div class="theme-color-option" style="background:#34C759;" data-color="#34C759" title="ç»¿è‰²"></div>
                    <div class="theme-color-option" style="background:#8E8E93;" data-color="#8E8E93" title="ç°è‰²"></div>
                </div>
                <div style="display:flex; align-items:center; margin-top:10px;">
                    <span style="margin-right:8px;">è‡ªå®šä¹‰:</span>
                    <input type="color" id="custom-color-picker" value="#AED5F3" style="width:50px; height:40px; border:none; background:transparent;">
                </div>
            </div>
            <button class="modal-btn" id="save-api-btn">ä¿å­˜è®¾ç½®</button>
            <button class="modal-cancel" data-mod="m-api" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- çºªå¿µæ—¥ã€è”ç³»äººå¼¹çª— -->
    <div class="modal" id="m-anni"><div class="modal-body"><h3>æ–°çºªå¿µæ—¥</h3><input type="text" id="at" placeholder="äº‹é¡¹åç§°"><input type="date" id="ad"><button class="modal-btn" id="save-anni-btn">ä¿å­˜</button><button class="modal-cancel" data-mod="m-anni" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>
    <div class="modal" id="m-con"><div class="modal-body"><h3>æ–°è”ç³»äºº</h3><input type="text" id="cn" placeholder="å§“å"><button class="modal-btn" id="save-con-btn">æ·»åŠ </button><button class="modal-cancel" data-mod="m-con" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button></div></div>

    <!-- å¤§å›¾æŸ¥çœ‹å™¨ -->
    <div id="viewer" onclick="closeViewer()">
        <img id="v-img" src="" onclick="event.stopPropagation()">
        <div class="viewer-btns" onclick="event.stopPropagation()">
            <button class="v-btn" id="set-wallpaper-btn">è®¾ä¸ºå£çº¸</button>
            <button class="v-btn" id="close-viewer-btn">è¿”å›</button>
        </div>
    </div>
</div>

<script>
    // ==================== IndexedDB å›¾ç‰‡ä»“åº“ï¼ˆå®Œæ•´ä¿ç•™ï¼‰====================
    let db;
    const DB_NAME = 'SmartOSDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'photos';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { autoIncrement: true });
                }
            };
        });
    }

    async function saveImageToDB(file) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.add(file);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getImageFromDB(id) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

// ========== è®ºå›ä¸–ç•Œè§‚è®¾å®š ==========
const FORUM_WORLD = {
    name: "æ‰“å·¥äººæ‘¸é±¼è®ºå›",
    slogan: "åœ¨è¿™é‡Œï¼Œæ¯ä¸€æ®µæ¼‚æµéƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„é å²¸",
    users: ["æ¼‚æµè€…", "é’“é±¼äºº", "æ½œæ°´å‘˜"],
    sections: [
        { id: "tools", name: "å·¥å…·è¡¥ç»™ç«™", desc: "æ¼‚æµæŠ€å·§äº¤æµåŒº", icon: "ğŸ› ï¸" },
        { id: "energy", name: "èƒ½é‡è¡¥ç»™ç«™", desc: "é¤é¥®æ±‚ç”ŸæŒ‡å—åŒº", icon: "ğŸ±" },
        { id: "wind", name: "é£å‘è§‚æµ‹å¡”", desc: "è¡Œä¸šå…«å¦æƒ…æŠ¥åŒº", icon: "ğŸ—¼" },
        { id: "valve", name: "æƒ…ç»ªæ³„å‹é˜€", desc: "èŒåœºåæ§½æ ‘æ´åŒº", icon: "ğŸŒŠ" },
        { id: "side", name: "å‰¯ä¸šå°è‰‡", desc: "éœ€å®¡æ ¸è¿›å…¥", icon: "ğŸš¤", requireAuth: true },
        { id: "log", name: "èˆªæµ·æ—¥å¿—åº“", desc: "æ ¸å¿ƒè´¡çŒ®è€…ä¸“å±", icon: "ğŸ“š", requireContribution: true }
    ],
    rules: [
        "ç¦æ­¢ä¼ æ’­æç«¯ç§¯æçš„å·¥ä½œæ€åº¦",
        "ç¦æ­¢æ³„éœ²å…¬å¸æœºå¯†æˆ–ä»–äººéšç§",
        "ç¦æ­¢äººèº«æ”»å‡»å’ŒèŒåœºæ­§è§†",
        "ç¦æ­¢éæ³•å…¼èŒã€ä¼ é”€ç­‰è¿æ³•å†…å®¹",
        "ç¦æ­¢è¿‡åº¦è´Ÿèƒ½é‡",
        "ç¦æ­¢å®£ä¼ ä¸æ‘¸é±¼ä¸ºè€æ¿å¥½ç­‰ææ€–è¨€è®º"
    ],
    anonymous: true // é»˜è®¤åŒ¿åå‘å¸–
};

// ========== è®ºå›æ•°æ® ==========
let forumSections = FORUM_WORLD.sections;
let currentSectionId = 'tools'; // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†åŒº
let forumPosts = JSON.parse(localStorage.getItem('m_forum_posts') || '[]');

// é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ’å…¥å‡ æ¡ç¤ºä¾‹å¸–å­ï¼ˆç¬¦åˆæ‰“å·¥äººæ‘¸é±¼ä¸»é¢˜ï¼‰
if (forumPosts.length === 0) {
    forumPosts = [
        { id: 'p1', sectionId: 'tools', author: 'åŒ¿åæ¼‚æµè€…', time: '10:23', content: 'åˆ†äº«ä¸€ä¸‹æˆ‘çš„â€œèµ°åŠ¨å¼æ‘¸é±¼â€ï¼šæ¯åŠå°æ—¶æ¥æ°´ä¸€æ¬¡ï¼Œè·¯è¿‡è€æ¿ä½æ—¶æ‹¿ä¸ªæ–‡ä»¶ï¼Œå®Œç¾ï½', anonymous: true, likes: 15, replies: 3 },
        { id: 'p2', sectionId: 'energy', author: 'å¤–å–çŒäºº', time: '12:05', content: 'ä»Šå¤©æµ‹è¯„å…¬å¸æ¥¼ä¸‹æ–°å¼€çš„è½»é£Ÿï¼Œä¸‰æ˜æ²»é…ç¾½è¡£ç”˜è“ï¼Œ28å…ƒï¼Œé€åˆ¸å23ï¼Œå‘³é“3.5æ˜Ÿï¼Œé¥±è…¹æ„Ÿä¸€èˆ¬ã€‚', anonymous: false, likes: 7, replies: 2 },
        { id: 'p3', sectionId: 'valve', author: 'æ ‘æ´ç”¨æˆ·9527', time: '15:47', content: 'è€æ¿ä»Šå¤©åˆåœ¨æˆ‘èº«åç«™äº†10åˆ†é’Ÿï¼Œä»€ä¹ˆè¯éƒ½æ²¡è¯´ï¼Œæˆ‘å‡è£…åœ¨æ”¹PPTï¼Œå…¶å®åœ¨é€›è®ºå›â€¦â€¦', anonymous: true, likes: 42, replies: 8 }
    ];
    localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
}
function renderForumSections() {
    const container = document.getElementById('forum-sections');
    if (!container) return;
    container.innerHTML = '';
    forumSections.forEach(section => {
        const card = document.createElement('div');
        card.className = `section-card ${section.requireAuth || section.requireContribution ? 'locked' : ''}`;
        card.onclick = () => {
            // ç‰¹æ®Šåˆ†åŒºå¤„ç†ï¼ˆå¯åŠ å®¡æ ¸å¼¹çª—ï¼‰
            if (section.requireAuth) {
                alert('å‰¯ä¸šå°è‰‡éœ€è¦äººå·¥å®¡æ ¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                return;
            }
            if (section.requireContribution) {
                alert('èˆªæµ·æ—¥å¿—åº“ä»…å¯¹æ ¸å¿ƒè´¡çŒ®è€…å¼€æ”¾');
                return;
            }
            currentSectionId = section.id;
            renderSectionHeader(section.name);
            renderPosts(section.id);
        };
        card.innerHTML = `
            <div class="icon">${section.icon}</div>
            <div class="name">${section.name}</div>
            <div class="desc">${section.desc}</div>
        `;
        container.appendChild(card);
    });
}
function renderSectionHeader(name) {
    const header = document.getElementById('forum-section-header');
    if (header) header.innerText = name;
}

function renderPosts(sectionId) {
    const postsContainer = document.getElementById('forum-posts');
    if (!postsContainer) return;
    postsContainer.innerHTML = '';
    const filtered = forumPosts.filter(p => p.sectionId === sectionId).reverse(); // æœ€æ–°åœ¨ä¸Š
    filtered.forEach(post => {
        const postEl = document.createElement('div');
        postEl.className = 'post-card';
        postEl.innerHTML = `
            <div class="post-header">
                <span class="post-author">${post.author}${post.anonymous ? '<span class="anonymous-badge">åŒ¿å</span>' : ''}</span>
                <span>${post.time}</span>
            </div>
            <div class="post-content">${post.content}</div>
            <div class="post-footer">
                <div class="post-stats">
                    <span>ğŸ‘ ${post.likes}</span>
                    <span>ğŸ’¬ ${post.replies}</span>
                </div>
                <div onclick="likePost('${post.id}')" style="cursor:pointer;">ç‚¹èµ</div>
            </div>
        `;
        postsContainer.appendChild(postEl);
    });
}

// ç‚¹èµåŠŸèƒ½ï¼ˆæ¼”ç¤ºï¼‰
function likePost(postId) {
    const post = forumPosts.find(p => p.id === postId);
    if (post) {
        post.likes += 1;
        localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
        renderPosts(currentSectionId);
    }
}
function openForumPostModal() {
    // åŠ¨æ€åˆ›å»ºå¼¹çª—ï¼ˆæˆ–ä½¿ç”¨å·²å­˜åœ¨çš„æ¨¡æ€æ¡†ï¼‰
    const modalHtml = `
        <div class="modal" id="m-forum-post" style="display:flex;">
            <div class="modal-body">
                <h3>æ¼‚æµæ—¥è®° Â· å‘å¸ƒæ–°å¸–</h3>
                <select id="post-section" style="margin-bottom:12px;">
                    ${forumSections.filter(s => !s.requireAuth && !s.requireContribution).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                </select>
                <textarea id="post-content" rows="5" placeholder="åˆ†äº«ä½ çš„æ¼‚æµå¿ƒå¾—..." style="width:100%;"></textarea>
                <label style="display:flex; align-items:center; margin:12px 0;">
                    <input type="checkbox" id="post-anonymous" checked> åŒ¿åå‘å¸ƒ
                </label>
                <button class="modal-btn" id="submit-post-btn">å‘å¸ƒ</button>
                <button class="modal-cancel" onclick="closeMod('m-forum-post')">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    // æ’å…¥åˆ° body æœ«å°¾
    const div = document.createElement('div');
    div.innerHTML = modalHtml;
    document.body.appendChild(div);
    document.getElementById('submit-post-btn').onclick = submitForumPost;
}

function submitForumPost() {
    const sectionId = document.getElementById('post-section').value;
    const content = document.getElementById('post-content').value.trim();
    if (!content) { alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    const anonymous = document.getElementById('post-anonymous').checked;
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    const newPost = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 4),
        sectionId,
        author: anonymous ? 'åŒ¿åæ¼‚æµè€…' : `æ¼‚æµè€…${Math.floor(Math.random()*1000)}`,
        time: timeStr,
        content,
        anonymous,
        likes: 0,
        replies: 0
    };
    forumPosts.push(newPost);
    localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
    closeMod('m-forum-post');
    // ç§»é™¤åŠ¨æ€æ·»åŠ çš„å¼¹çª—
    setTimeout(() => {
        const el = document.getElementById('m-forum-post');
        if (el) el.remove();
    }, 100);
    renderPosts(currentSectionId);
}
function openMod(id) {
    // ... ä¿ç•™åŸæœ‰ openMod é€»è¾‘ï¼Œé¢å¤–å¤„ç† 'm-forum-world'
    if (id === 'm-forum-world') {
        const modalHtml = `
            <div class="modal" id="m-forum-world" style="display:flex;">
                <div class="modal-body">
                    <h3>ğŸŒ æ‰“å·¥äººæ‘¸é±¼è®ºå› Â· ä¸–ç•Œè§‚</h3>
                    <p style="margin-bottom:12px;"><strong>å£å·ï¼š</strong>â€œåœ¨è¿™é‡Œï¼Œæ¯ä¸€æ®µæ¼‚æµéƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„é å²¸â€</p>
                    <p style="margin-bottom:12px;"><strong>æ–‡åŒ–ç¬¦å·ï¼š</strong>å¸¦è–ªæ‹‰å± Â· é’“é±¼ Â· æ½œæ°´ Â· ä¸Šå²¸</p>
                    <p style="margin-bottom:12px;"><strong>ç»å¯¹ç¦å¿Œï¼š</strong></p>
                    <ul style="padding-left:20px; color:var(--note-text-gray);">
                        ${FORUM_WORLD.rules.map(r => `<li style="margin-bottom:4px;">${r}</li>`).join('')}
                    </ul>
                    <button class="modal-cancel" onclick="closeMod('m-forum-world')">å…³é—­</button>
                </div>
            </div>
        `;
        const div = document.createElement('div');
        div.innerHTML = modalHtml;
        document.body.appendChild(div);
        return;
    }
    // å…¶ä»–åŸæœ‰å¼¹çª—é€»è¾‘...
}
function to(id) {
    // ... ä¿ç•™åŸæœ‰è·¯ç”±ä»£ç ï¼Œåœ¨æœ€åæ·»åŠ ï¼š
    if (id === 'p-forum') {
        renderForumSections();
        renderSectionHeader(forumSections.find(s => s.id === currentSectionId)?.name || 'å·¥å…·è¡¥ç»™ç«™');
        renderPosts(currentSectionId);
    }
}

    // ==================== æ•°æ®æŒä¹…åŒ–ï¼ˆå…¨åŠŸèƒ½ï¼‰====================
    let photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
    let annis = JSON.parse(localStorage.getItem('m_annis') || '[]');
    let cons = JSON.parse(localStorage.getItem('m_cons') || '[{"id":"init-001","name":"æœ¨æœ¨"}]');
    let apiCfg = JSON.parse(localStorage.getItem('m_api_cfg') || '{"enabled":false,"url":"","key":""}');
    let wallpaperId = localStorage.getItem('m_wallpaper_id');
    let messages = JSON.parse(localStorage.getItem('m_messages') || '{}');
    let currentChatContactId = null;
    let themeColor = localStorage.getItem('m_theme_color') || '#AED5F3';

    // ä¸ªäººèµ„æ–™
    let profile = JSON.parse(localStorage.getItem('m_profile') || '{"nickname":"éŸ©é—»ç†™","signature":"PrettyWhenuCry","region":"å†°å²›","birthday":"2000-03-14","avatarId":null}');

    // è¡¨æƒ…åŒ…åº“ï¼ˆå®Œæ•´20ä¸ªï¼‰
    const DEFAULT_EMOTICONS = [
        { url: "https://i.imgs.ovh/2026/01/21/yRkuGr.gif", name: "æ½¦è‰é»„ç‹—-è·³èˆ" },
        { url: "https://i.imgs.ovh/2026/01/21/yRkBjh.gif", name: "æ½¦è‰é»„ç‹—-æ¯”å¿ƒ" },
        { url: "https://i.imgs.ovh/2026/01/21/yRkX6e.gif", name: "æ½¦è‰é»„ç‹—-ç¬‘å“­" },
        { url: "https://i.imgs.ovh/2026/01/21/yRkwla.gif", name: "æ½¦è‰é»„ç‹—-æ‘‡å°¾å·´" },
        { url: "https://i.imgs.ovh/2026/01/21/yRk37t.gif", name: "æ½¦è‰é»„ç‹—-è‰è£™èˆ" },
        { url: "https://i.imgs.ovh/2026/01/21/yRkNAq.gif", name: "æ½¦è‰é»„ç‹—-ä½›å…‰" },
        { url: "https://i.imgs.ovh/2026/01/21/yRkiJC.gif", name: "æ½¦è‰é»„ç‹—-ç”Ÿç—…" },
        { url: "https://i.imgs.ovh/2026/01/21/yRq0w4.gif", name: "æ½¦è‰é»„ç‹—-è¯·" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqCLA.gif", name: "æ½¦è‰é»„ç‹—-æ‹¿å¤–å–" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqyMN.gif", name: "æ½¦è‰é»„ç‹—-æ‹–å»¶ç—‡" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqOGH.gif", name: "æ½¦è‰é»„ç‹—-è¢«å¯çˆ±æš´å‡»" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqacU.gif", name: "æ½¦è‰é»„ç‹—-å•ƒè„‘è¢‹" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqj6X.gif", name: "æ½¦è‰é»„ç‹—-è¢«æ‰“é¸¡è¡€" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqclQ.gif", name: "æ½¦è‰é»„ç‹—-å¢¨é•œä¸‹æ— å£°ç—›è‹¦" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqrCF.gif", name: "æ½¦è‰é»„ç‹—-æ‰“å—" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqvAm.gif", name: "æ½¦è‰é»„ç‹—-å‰è…°" },
        { url: "https://i.imgs.ovh/2026/01/21/yRqFJ9.gif", name: "æ½¦è‰é»„ç‹—-ç›¯ï¼ˆä¸¥è‚ƒï¼‰" }
    ];
    let emoticons = JSON.parse(localStorage.getItem('m_emoticons') || '[]');
    if (emoticons.length === 0) {
        emoticons = DEFAULT_EMOTICONS.map((e, index) => ({ ...e, id: Date.now() + index + '-' + Math.random().toString(36).substr(2, 4) }));
        localStorage.setItem('m_emoticons', JSON.stringify(emoticons));
    }

    // éŸ³ä¹åº“
    const DEFAULT_MUSIC = [
        { id: 'default-1', title: "èµ·é£äº†", artist: "ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸", src: "" },
        { id: 'default-2', title: "Lemon", artist: "ç±³æ´¥ç„å¸«", src: "" },
        { id: 'default-3', title: "å¤œæ›²", artist: "å‘¨æ°ä¼¦", src: "" },
        { id: 'default-4', title: "å¹³å‡¡ä¹‹è·¯", artist: "æœ´æ ‘", src: "" }
    ];
    let musicList = JSON.parse(localStorage.getItem('m_music_list') || '[]');
    if (musicList.length === 0) {
        musicList = DEFAULT_MUSIC.map((m, index) => ({ ...m, id: m.id || Date.now() + index + '-' + Math.random().toString(36).substr(2, 4) }));
        localStorage.setItem('m_music_list', JSON.stringify(musicList));
    }

    // ğŸ†• æ—¥è®°æ•°æ®
    let diaries = JSON.parse(localStorage.getItem('m_diaries') || '[]');

    // ğŸ†• çŸ­ä¿¡æ•°æ®
    let smsMessages = JSON.parse(localStorage.getItem('m_sms') || '[]');

    // ==================== ä¸»é¢˜è‰²åº”ç”¨ ====================
    function applyTheme(color) {
        document.documentElement.style.setProperty('--theme-primary', color);
        document.documentElement.style.setProperty('--ios-blue', color);
        const softBg = color + '1A';
        document.documentElement.style.setProperty('--theme-soft-bg', softBg);
        document.querySelectorAll('.theme-color-option').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.color === color) el.classList.add('active');
        });
        const customPicker = document.getElementById('custom-color-picker');
        if (customPicker) customPicker.value = color;
    }

    // ==================== æ ¸å¿ƒè·¯ç”± ====================
    function to(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'p-cal') renderCalendar();
        if (id === 'p-profile') renderProfile();
        if (id === 'p-diary') renderDiaries();
        if (id === 'p-sms') renderSmsList();
    }

    function openMod(id) {
        if (id === 'm-api') {
            document.getElementById('api-toggle').checked = apiCfg.enabled;
            document.getElementById('api-url').value = apiCfg.url;
            document.getElementById('api-key').value = apiCfg.key;
            applyTheme(themeColor);
        }
        if (id === 'm-profile-nickname') document.getElementById('profile-nickname-input').value = profile.nickname;
        if (id === 'm-profile-signature') document.getElementById('profile-signature-input').value = profile.signature;
        if (id === 'm-profile-region') document.getElementById('profile-region-input').value = profile.region;
        if (id === 'm-profile-birthday') document.getElementById('profile-birthday-input').value = profile.birthday;
        if (id === 'm-emoticon-library') renderEmoticons();
        if (id === 'm-music-player') renderMusicList();
        document.getElementById(id).style.display = 'flex';
    }
    function closeMod(id) { document.getElementById(id).style.display = 'none'; }

    // ==================== è¡¨æƒ…åŒ…åº“æ¸²æŸ“ ====================
    function renderEmoticons() {
        const grid = document.getElementById('emoticon-grid');
        if (!grid) return;
        grid.innerHTML = '';
        emoticons.forEach(em => {
            const item = document.createElement('div');
            item.className = 'emoticon-item';
            item.onclick = () => {
                const chatInput = document.getElementById('chat-in');
                if (chatInput) {
                    chatInput.value += ` ![${em.name}](${em.url}) `;
                    chatInput.focus();
                }
                closeMod('m-emoticon-library');
            };
            const img = document.createElement('img');
            img.src = em.url;
            img.onerror = () => { img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23eee"/><text x="10" y="55" font-size="14" fill="%23999">åŠ è½½å¤±è´¥</text></svg>'; };
            const name = document.createElement('div');
            name.className = 'emoticon-name';
            name.textContent = em.name;
            item.appendChild(img);
            item.appendChild(name);
            grid.appendChild(item);
        });
    }
    function addEmoticon() {
        const url = document.getElementById('emoticon-url').value.trim();
        const name = document.getElementById('emoticon-name').value.trim();
        if (!url || !name) { alert('è¯·å¡«å†™URLå’Œåç§°'); return; }
        const newEm = { id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), url, name };
        emoticons.push(newEm);
        localStorage.setItem('m_emoticons', JSON.stringify(emoticons));
        document.getElementById('emoticon-url').value = ''; document.getElementById('emoticon-name').value = '';
        renderEmoticons();
    }

    // ==================== éŸ³ä¹åº“æ¸²æŸ“ ====================
    function renderMusicList() {
        const list = document.getElementById('music-list');
        if (!list) return;
        list.innerHTML = '';
        musicList.forEach(music => {
            const li = document.createElement('li');
            li.className = 'music-item';
            li.onclick = (e) => {
                if (e.target.classList.contains('music-delete-btn') || e.target.parentElement.classList.contains('music-delete-btn')) return;
                const audio = document.getElementById('music-audio');
                if (music.src && music.src.trim() !== '') {
                    audio.src = music.src;
                    audio.play().catch(err => alert('æ’­æ”¾å¤±è´¥ï¼š' + (err.message || 'å¯èƒ½æ˜¯è·¨åŸŸæˆ–æ— æ•ˆé“¾æ¥')));
                } else alert('æ­¤æ­Œæ›²æ— éŸ³é¢‘é“¾æ¥ï¼Œä»…ä½œå±•ç¤º');
            };
            li.innerHTML = `<span class="play-icon">â–¶ï¸</span><span class="title">${music.title}</span><span class="artist">${music.artist}</span><span class="music-delete-btn" data-id="${music.id}">ğŸ—‘ï¸</span>`;
            list.appendChild(li);
        });
        document.querySelectorAll('.music-delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) { e.stopPropagation(); deleteMusic(this.dataset.id); });
        });
    }
    function addMusic() {
        const title = document.getElementById('music-title').value.trim();
        const artist = document.getElementById('music-artist').value.trim();
        const url = document.getElementById('music-url').value.trim();
        if (!title || !artist) { alert('è¯·å¡«å†™æ­Œæ›²åå’Œæ­Œæ‰‹'); return; }
        const newMusic = { id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), title, artist, src: url || '' };
        musicList.push(newMusic);
        localStorage.setItem('m_music_list', JSON.stringify(musicList));
        document.getElementById('music-title').value = ''; document.getElementById('music-artist').value = ''; document.getElementById('music-url').value = '';
        renderMusicList();
    }
    function deleteMusic(id) {
        if (confirm('ç¡®å®šä»åˆ—è¡¨ä¸­ç§»é™¤è¿™é¦–æ­Œå—ï¼Ÿ')) {
            musicList = musicList.filter(m => m.id !== id);
            localStorage.setItem('m_music_list', JSON.stringify(musicList));
            renderMusicList();
        }
    }

    // ==================== ä¸ªäººèµ„æ–™æ¸²æŸ“ ====================
    async function renderProfile() {
        document.getElementById('profile-nickname').innerText = profile.nickname;
        document.getElementById('profile-signature').innerText = profile.signature;
        document.getElementById('profile-nickname-value').innerText = profile.nickname;
        document.getElementById('profile-signature-value').innerText = profile.signature;
        document.getElementById('profile-region-value').innerText = profile.region;
        if (profile.birthday) {
            const date = new Date(profile.birthday);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            document.getElementById('profile-birthday-value').innerText = `${month}-${day}`;
        }
        const avatarDiv = document.getElementById('profile-avatar');
        avatarDiv.innerHTML = '';
        if (profile.avatarId) {
            try {
                const blob = await getImageFromDB(parseInt(profile.avatarId));
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img'); img.src = url; avatarDiv.appendChild(img);
            } catch(e) { avatarDiv.innerHTML = 'ğŸ‘¤'; }
        } else { avatarDiv.innerHTML = 'ğŸ‘¤'; }
    }
    function saveProfileNickname() { const val = document.getElementById('profile-nickname-input').value.trim(); if (val) { profile.nickname = val; localStorage.setItem('m_profile', JSON.stringify(profile)); renderProfile(); closeMod('m-profile-nickname'); } }
    function saveProfileSignature() { const val = document.getElementById('profile-signature-input').value.trim(); if (val !== undefined) { profile.signature = val; localStorage.setItem('m_profile', JSON.stringify(profile)); renderProfile(); closeMod('m-profile-signature'); } }
    function saveProfileRegion() { const val = document.getElementById('profile-region-input').value.trim(); if (val) { profile.region = val; localStorage.setItem('m_profile', JSON.stringify(profile)); renderProfile(); closeMod('m-profile-region'); } }
    function saveProfileBirthday() { const val = document.getElementById('profile-birthday-input').value; if (val) { profile.birthday = val; localStorage.setItem('m_profile', JSON.stringify(profile)); renderProfile(); closeMod('m-profile-birthday'); } }
    async function uploadAvatar(file) { if (file.size > 2 * 1024 * 1024) { alert('å¤´åƒå›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB'); return; } const id = await saveImageToDB(file); profile.avatarId = id; localStorage.setItem('m_profile', JSON.stringify(profile)); renderProfile(); }

    // ==================== æ—¥è®°åŠŸèƒ½ ====================
    function renderDiaries() {
        const container = document.getElementById('diary-list');
        if (!container) return;
        container.innerHTML = '';
        if (diaries.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:var(--note-text-gray); padding:40px;">ğŸ““ æš‚æ— æ—¥è®°ï¼Œç‚¹å‡»å³ä¸Šè§’â•æ·»åŠ </div>';
            return;
        }
        diaries.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(d => {
            const div = document.createElement('div');
            div.className = 'diary-entry';
            div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="font-weight:600;">${d.date}</span>
                                <span style="color:var(--note-text-gray); cursor:pointer;" onclick="deleteDiary('${d.id}')">ğŸ—‘ï¸</span>
                            </div>
                            <div style="white-space:pre-wrap;">${d.content}</div>`;
            container.appendChild(div);
        });
    }
    function addDiary() {
        const content = document.getElementById('diary-content').value.trim();
        if (!content) { alert('æ—¥è®°å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
        const newDiary = { id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), date: dateStr, content };
        diaries.push(newDiary);
        localStorage.setItem('m_diaries', JSON.stringify(diaries));
        document.getElementById('diary-content').value = '';
        closeMod('m-diary-add');
        renderDiaries();
    }
    function deleteDiary(id) {
        if (confirm('åˆ é™¤è¿™ç¯‡æ—¥è®°ï¼Ÿ')) {
            diaries = diaries.filter(d => d.id !== id);
            localStorage.setItem('m_diaries', JSON.stringify(diaries));
            renderDiaries();
        }
    }

    // ==================== çŸ­ä¿¡åŠŸèƒ½ ====================
    function renderSmsList() {
        const container = document.getElementById('sms-list');
        if (!container) return;
        container.innerHTML = '';
        if (smsMessages.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:var(--note-text-gray); padding:40px;">ğŸ’¬ æš‚æ— çŸ­ä¿¡ï¼Œç‚¹å‡»å³ä¸Šè§’âœï¸å‘é€</div>';
            return;
        }
        smsMessages.sort((a,b) => new Date(b.time) - new Date(a.time)).forEach(s => {
            const div = document.createElement('div');
            div.className = 'sms-item';
            div.innerHTML = `<div style="display:flex; flex-direction:column; width:100%;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                    <span style="font-weight:600;">${s.contact || 'é™Œç”Ÿäºº'}</span>
                                    <span style="color:var(--note-text-gray); font-size:12px;">${s.time}</span>
                                </div>
                                <div style="color:var(--note-text-dark);">${s.content}</div>
                                <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                                    <span style="color:var(--note-text-gray); font-size:12px; cursor:pointer;" onclick="deleteSms('${s.id}')">åˆ é™¤</span>
                                </div>
                            </div>`;
            container.appendChild(div);
        });
    }
    function sendSms() {
        const contact = document.getElementById('sms-contact').value.trim() || 'æœªçŸ¥å·ç ';
        const content = document.getElementById('sms-content').value.trim();
        if (!content) { alert('çŸ­ä¿¡å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        const newSms = { id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), contact, content, time: timeStr };
        smsMessages.push(newSms);
        localStorage.setItem('m_sms', JSON.stringify(smsMessages));
        document.getElementById('sms-contact').value = '';
        document.getElementById('sms-content').value = '';
        closeMod('m-sms-compose');
        renderSmsList();
    }
    function deleteSms(id) {
        smsMessages = smsMessages.filter(s => s.id !== id);
        localStorage.setItem('m_sms', JSON.stringify(smsMessages));
        renderSmsList();
    }

// ==================== æ¡Œé¢å›¾ç‰‡å°ç»„ä»¶ ====================
let desktopPhotoId = localStorage.getItem('m_desktop_photo_id');

// åˆå§‹åŒ–å°ç»„ä»¶æ˜¾ç¤º
function renderDesktopPhoto() {
    const placeholder = document.getElementById('photo-widget-placeholder');
    const imageDiv = document.getElementById('photo-widget-image');
    if (!placeholder || !imageDiv) return;
    if (desktopPhotoId) {
        // æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼Œéšè—å ä½ç¬¦
        placeholder.style.display = 'none';
        imageDiv.style.display = 'block';
        getImageFromDB(parseInt(desktopPhotoId)).then(blob => {
            const url = URL.createObjectURL(blob);
            imageDiv.style.backgroundImage = `url(${url})`;
        }).catch(() => {
            // åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦å¹¶æ¸…é™¤æ— æ•ˆ ID
            placeholder.style.display = 'flex';
            imageDiv.style.display = 'none';
            localStorage.removeItem('m_desktop_photo_id');
            desktopPhotoId = null;
        });
    } else {
        // æ— å›¾ç‰‡ï¼Œæ˜¾ç¤ºå ä½ç¬¦
        placeholder.style.display = 'flex';
        imageDiv.style.display = 'none';
    }
}

// ç‚¹å‡»å°ç»„ä»¶ä¸Šä¼ å›¾ç‰‡
function setupDesktopPhotoWidget() {
    const widget = document.getElementById('desktop-photo-widget');
    if (!widget) return;
    widget.addEventListener('click', async function(e) {
        // åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (ev) => {
            const file = ev.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            const id = await saveImageToDB(file);
            desktopPhotoId = id;
            localStorage.setItem('m_desktop_photo_id', id);
            renderDesktopPhoto();
        };
        input.click();
    });
}

// åœ¨å¯åŠ¨æ—¶è°ƒç”¨æ¸²æŸ“å’Œç»‘å®š
// è¯·åœ¨ init å‡½æ•°é‡Œåˆé€‚ä½ç½®ï¼ˆå¦‚ await renderAll() ä¹‹åï¼‰æ·»åŠ ï¼š
// renderDesktopPhoto();
// setupDesktopPhotoWidget();

    // ==================== ç›¸å†Œé€»è¾‘ ====================
    async function renderAll() {
        // ç›¸å†Œ
        const box = document.getElementById('album-box');
        box.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (const id of photos) {
            const div = document.createElement('div');
            div.dataset.imgId = id;
            div.className = 'album-thumb';
            try {
                const fileBlob = await getImageFromDB(id);
                const url = URL.createObjectURL(fileBlob);
                div.style.backgroundImage = `url(${url})`;
                div.dataset.blobUrl = url;
            } catch (e) {
                div.style.background = '#ccc';
            }
            fragment.appendChild(div);
        }
        box.appendChild(fragment);

        // çºªå¿µæ—¥
        const aList = document.getElementById('anni-list');
        aList.innerHTML = '';
        annis.sort((a, b) => new Date(a.d) - new Date(b.d));
        annis.forEach(a => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.anniId = a.id;
            const leftSpan = document.createElement('span');
            leftSpan.textContent = `ğŸ“… ${a.d} ${a.t}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(leftSpan);
            item.appendChild(delSpan);
            aList.appendChild(item);
        });

        // é€šè®¯å½•
        const cList = document.getElementById('con-list');
        cList.innerHTML = '';
        cons.forEach(c => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.conId = c.id;
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `ğŸ‘¤ ${c.name}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(nameSpan);
            item.appendChild(delSpan);
            cList.appendChild(item);
        });
    }

    // ==================== ç›¸å†Œä¸Šä¼ ã€æŸ¥çœ‹ã€å£çº¸ ====================
    async function upImg(el) {
        const files = Array.from(el.files);
        for (const file of files) {
            if (file.size > 5 * 1024 * 1024) {
                alert(`å›¾ç‰‡ ${file.name} è¶…è¿‡ 5MBï¼Œè¯·å‹ç¼©åä¸Šä¼ `);
                continue;
            }
            const id = await saveImageToDB(file);
            photos.push(id);
        }
        localStorage.setItem('m_photos', JSON.stringify(photos));
        renderAll();
    }

    let currentImgId = null;
    let currentImgBlobUrl = null;

    async function viewImg(imgId) {
        try {
            const fileBlob = await getImageFromDB(parseInt(imgId));
            const url = URL.createObjectURL(fileBlob);
            if (currentImgBlobUrl) URL.revokeObjectURL(currentImgBlobUrl);
            currentImgBlobUrl = url;
            currentImgId = imgId;
            document.getElementById('v-img').src = url;
            document.getElementById('viewer').style.display = 'flex';
        } catch (e) {
            alert('å›¾ç‰‡åŠ è½½å¤±è´¥');
        }
    }

    function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

    async function setWallpaper() {
        if (!currentImgId) return;
        try {
            await getImageFromDB(parseInt(currentImgId));
            localStorage.setItem('m_wallpaper_id', currentImgId);
            wallpaperId = currentImgId;
            await applyWallpaper();
            alert('å£çº¸è®¾ç½®æˆåŠŸï¼');
            closeViewer();
        } catch (e) {
            alert('å£çº¸è®¾ç½®å¤±è´¥');
        }
    }

    async function applyWallpaper() {
        if (!wallpaperId) return;
        try {
            const fileBlob = await getImageFromDB(parseInt(wallpaperId));
            const url = URL.createObjectURL(fileBlob);
            document.getElementById('p-home').style.background = `url(${url})`;
        } catch (e) {
            console.warn('å£çº¸åŠ è½½å¤±è´¥');
            localStorage.removeItem('m_wallpaper_id');
            wallpaperId = null;
        }
    }

    // ==================== é€šè®¯å½• CRUD ====================
    function saveCon() {
        const n = document.getElementById('cn').value;
        if (n) {
            cons.push({ id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), name: n });
            localStorage.setItem('m_cons', JSON.stringify(cons));
            renderAll();
            closeMod('m-con');
            document.getElementById('cn').value = '';
        }
    }
    function delCon(id) {
        if (confirm("ç¡®å®šåˆ é™¤è¯¥è”ç³»äººï¼Ÿ")) {
            const index = cons.findIndex(c => c.id === id);
            if (index !== -1) {
                cons.splice(index, 1);
                localStorage.setItem('m_cons', JSON.stringify(cons));
                delete messages[id];
                localStorage.setItem('m_messages', JSON.stringify(messages));
                renderAll();
                if (currentChatContactId === id) {
                    currentChatContactId = null;
                    document.getElementById('chat-title').textContent = 'è¯·é€‰æ‹©è”ç³»äºº';
                    document.getElementById('chat-flow').innerHTML = '';
                }
            }
        }
    }

    // ==================== çºªå¿µæ—¥ CRUD ====================
    function saveAnni() {
        const t = document.getElementById('at').value,
              d = document.getElementById('ad').value;
        if (t && d) {
            annis.push({ id: Date.now() + '-' + Math.random().toString(36).substr(2, 6), t, d });
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
            closeMod('m-anni');
            document.getElementById('at').value = '';
            document.getElementById('ad').value = '';
        }
    }
    function delAnni(id) {
        const index = annis.findIndex(a => a.id === id);
        if (index !== -1) {
            annis.splice(index, 1);
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
        }
    }

    // ==================== æ—¥å†ç”Ÿæˆ ====================
    function renderCalendar() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        document.getElementById('cal-month').innerText = `${y}å¹´${m + 1}æœˆ`;
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        const body = document.getElementById('cal-body');
        body.innerHTML = '';
        const fragment = document.createDocumentFragment();
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => {
            const div = document.createElement('div');
            div.className = 'cal-weekday';
            div.textContent = w;
            fragment.appendChild(div);
        });
        for (let i = 0; i < firstDay; i++) fragment.appendChild(document.createElement('div'));
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${y}-${(m + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            const isToday = (d === now.getDate()) ? 'today' : '';
            const hasEvent = annis.some(a => a.d === dateStr) ? 'has-event' : '';
            const div = document.createElement('div');
            div.className = `cal-day ${isToday} ${hasEvent}`.trim();
            div.textContent = d;
            fragment.appendChild(div);
        }
        body.appendChild(fragment);
    }

    // ==================== èŠå¤©ä¸ AI ====================
    function saveApi() {
        apiCfg = {
            enabled: document.getElementById('api-toggle').checked,
            url: document.getElementById('api-url').value,
            key: document.getElementById('api-key').value
        };
        localStorage.setItem('m_api_cfg', JSON.stringify(apiCfg));
        const customColor = document.getElementById('custom-color-picker').value;
        themeColor = customColor;
        localStorage.setItem('m_theme_color', themeColor);
        applyTheme(themeColor);
        closeMod('m-api');
    }

    function getCurrentTimeString() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    }

    function append(side, text, time = null) {
        const flow = document.getElementById('chat-flow');
        const row = document.createElement('div');
        row.className = `msg-row ${side}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        bubble.appendChild(textSpan);
        const timeSpan = document.createElement('span');
        timeSpan.className = 'msg-time';
        timeSpan.textContent = time || getCurrentTimeString();
        bubble.appendChild(timeSpan);
        row.appendChild(bubble);
        flow.appendChild(row);
        flow.scrollTop = flow.scrollHeight;
        return bubble;
    }

    // æœ¬åœ°æ™ºèƒ½å›å¤ï¼ˆå®Œæ•´ç‰ˆï¼‰
    function getLocalReply(message) {
        const lowerMsg = message.toLowerCase().trim();
        if (lowerMsg.includes('æ—¶é—´') || lowerMsg.includes('å‡ ç‚¹')) {
            const now = new Date();
            return `ç°åœ¨æ˜¯ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }
        if (lowerMsg.includes('æ—¥æœŸ') || lowerMsg.includes('å‡ å·')) {
            const now = new Date();
            return `ä»Šå¤©æ˜¯ ${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
        }
        if (lowerMsg.includes('æ˜ŸæœŸ')) {
            const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return `æ˜ŸæœŸ${week[new Date().getDay()]}`;
        }
        if (lowerMsg.includes('å¤©æ°”')) return 'åŒ—äº¬ä»Šå¤©æ™´ï¼Œ18ï½26â„ƒï¼Œç©ºæ°”è´¨é‡ä¼˜ã€‚';
        if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('åœ¨å—')) return 'ä½ å¥½å‘€ï½ä»Šå¤©è¿‡å¾—å¼€å¿ƒå—ï¼Ÿ';
        if (lowerMsg.includes('è°¢è°¢')) return 'ä¸å®¢æ°”ï½';
        if (lowerMsg.includes('ç¬‘è¯')) {
            const jokes = ['ä¸ºä»€ä¹ˆæ•°å­¦ä¹¦æ€»æ˜¯å¾ˆå¿§éƒï¼Ÿâ€”â€”å› ä¸ºå®ƒæœ‰å¤ªå¤šé—®é¢˜ã€‚', 'ä¸ºä»€ä¹ˆæ‰‹æœºè¦å–ç‰›å¥¶ï¼Ÿâ€”â€”å› ä¸ºè¦â€œå……ç”µå¥¶â€ï¼'];
            return jokes[Math.floor(Math.random() * jokes.length)];
        }
        if (lowerMsg.includes('æƒ…è¯')) return 'ä½ çŸ¥é“ä½ å’Œæ˜Ÿæ˜Ÿçš„åŒºåˆ«å—ï¼Ÿæ˜Ÿæ˜Ÿåœ¨å¤©ä¸Šï¼Œä½ åœ¨æˆ‘å¿ƒé‡Œã€‚';
        if (lowerMsg.includes('å¤¸æˆ‘')) return 'ä½ ä»Šå¤©çš„é¢œå€¼å·²ç»è¶…è¿‡åœ°çƒ99.99%çš„äººç±»äº†ï¼';
        if (lowerMsg.includes('ç¡¬å¸')) return 'ğŸª™ æŠ•ç¡¬å¸ç»“æœï¼š' + (Math.random() < 0.5 ? 'æ­£é¢' : 'åé¢');
        if (lowerMsg.includes('è¿åŠ¿')) {
            const fortunes = ['å¤§å‰ğŸŒŸ', 'å‰âœ¨', 'ä¸­å‰ğŸŒ¿', 'å°å‰ğŸŒ¸', 'æœ«å‰ğŸ‚', 'å‡¶ğŸŒ§ï¸', 'å¤§å‡¶âš¡'];
            return 'ä»Šæ—¥è¿åŠ¿ï¼š' + fortunes[Math.floor(Math.random() * fortunes.length)];
        }
        if (lowerMsg.includes('æŠ½ç­¾')) {
            const signs = ['ä¸Šä¸Šç­¾', 'ä¸Šç­¾', 'ä¸­ç­¾', 'ä¸‹ç­¾', 'ä¸‹ä¸‹ç­¾'];
            return 'ä½ æŠ½åˆ°äº†ï¼š' + signs[Math.floor(Math.random() * signs.length)] + 'ï¼';
        }
        return null;
    }

    async function sendMsg() {
        const input = document.getElementById('chat-in');
        const val = input.value.trim();
        if (!val) return;
        if (!currentChatContactId) {
            alert('è¯·å…ˆä»é€šè®¯å½•é€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
            return;
        }
        const timeStr = getCurrentTimeString();
        append('mine', val, timeStr);
        if (!messages[currentChatContactId]) messages[currentChatContactId] = [];
        messages[currentChatContactId].push({ side: 'mine', text: val, time: timeStr });
        localStorage.setItem('m_messages', JSON.stringify(messages));
        input.value = '';

        const localReply = getLocalReply(val);
        if (localReply) {
            const replyTime = getCurrentTimeString();
            append('other', localReply, replyTime);
            if (!messages[currentChatContactId]) messages[currentChatContactId] = [];
            messages[currentChatContactId].push({ side: 'other', text: localReply, time: replyTime });
            localStorage.setItem('m_messages', JSON.stringify(messages));
            return;
        }

        if (!apiCfg.enabled) {
            setTimeout(() => {
                const reply = "å·²æ”¶åˆ°æ¶ˆæ¯ï¼ˆå½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼‰";
                const replyTime = getCurrentTimeString();
                append('other', reply, replyTime);
                if (!messages[currentChatContactId]) messages[currentChatContactId] = [];
                messages[currentChatContactId].push({ side: 'other', text: reply, time: replyTime });
                localStorage.setItem('m_messages', JSON.stringify(messages));
            }, 600);
            return;
        }

        const tempBubble = append('other', "...", timeStr);
        try {
            const res = await fetch(apiCfg.url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiCfg.key}` },
                body: JSON.stringify({
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [
                        { role: "system", content: "ä½ å«æœ¨æœ¨ï¼Œæ¸©æŸ”ç®€ç»ƒã€‚" },
                        { role: "user", content: val }
                    ]
                })
            });
            const data = await res.json();
            const replyText = data.choices[0].message.content;
            const replyTime = getCurrentTimeString();
            tempBubble.querySelector('span').textContent = replyText;
            tempBubble.querySelector('.msg-time').textContent = replyTime;
            if (!messages[currentChatContactId]) messages[currentChatContactId] = [];
            messages[currentChatContactId].push({ side: 'other', text: replyText, time: replyTime });
            localStorage.setItem('m_messages', JSON.stringify(messages));
        } catch (e) {
            tempBubble.querySelector('span').textContent = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚";
            tempBubble.querySelector('.msg-time').textContent = getCurrentTimeString();
        }
    }

    // ==================== äº‹ä»¶ç›‘å¬ç»Ÿä¸€ç»‘å®š ====================
    function bindEvents() {
        // æ¡Œé¢å›¾æ ‡
        document.querySelectorAll('.app-item[data-page]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.page); });
        });
        // è¿”å›æŒ‰é’®
        document.querySelectorAll('.nav-back[data-home]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.home); });
        });
        // æ‰“å¼€å¼¹çª—ï¼ˆåŸæœ‰ï¼‰
        document.querySelectorAll('.nav-setting[data-mod], .nav-add[data-mod]').forEach(el => {
            el.addEventListener('click', function() { openMod(this.dataset.mod); });
        });
        // ç›¸å†Œä¸Šä¼ 
        document.getElementById('upload-trigger')?.addEventListener('click', function() { document.getElementById('up').click(); });
        document.getElementById('up')?.addEventListener('change', function(e) { upImg(e.target); });
        // èŠå¤©å‘é€
        document.getElementById('send-btn')?.addEventListener('click', sendMsg);
        document.getElementById('chat-in')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMsg(); });
        // å¼¹çª—å–æ¶ˆ
        document.querySelectorAll('.modal-cancel').forEach(el => {
            el.addEventListener('click', function() { closeMod(this.dataset.mod); });
        });
        // ä¿å­˜è®¾ç½®
        document.getElementById('save-api-btn')?.addEventListener('click', saveApi);
        document.getElementById('save-anni-btn')?.addEventListener('click', saveAnni);
        document.getElementById('save-con-btn')?.addEventListener('click', saveCon);
        document.getElementById('set-wallpaper-btn')?.addEventListener('click', setWallpaper);
        document.getElementById('close-viewer-btn')?.addEventListener('click', closeViewer);
        // ä¸»é¢˜è‰²
        document.querySelectorAll('.theme-color-option').forEach(el => {
            el.addEventListener('click', function() { const color = this.dataset.color; document.getElementById('custom-color-picker').value = color; applyTheme(color); });
        });
        document.getElementById('custom-color-picker')?.addEventListener('input', function(e) { applyTheme(e.target.value); });
        // çºªå¿µæ—¥åˆ é™¤
        document.getElementById('anni-list')?.addEventListener('click', function(e) {
            const delBtn = e.target.closest('.del-text'); if (!delBtn) return;
            const item = delBtn.closest('.list-item'); if (!item) return;
            const id = item.dataset.anniId; if (id) delAnni(id);
        });
        // é€šè®¯å½•ç‚¹å‡»
        document.getElementById('con-list')?.addEventListener('click', function(e) {
            const item = e.target.closest('.list-item'); if (!item) return;
            const id = item.dataset.conId; if (!id) return;
            if (e.target.classList.contains('del-text')) { e.stopPropagation(); delCon(id); return; }
            const contact = cons.find(c => c.id === id); const name = contact ? contact.name : 'è”ç³»äºº';
            currentChatContactId = id; document.getElementById('chat-title').textContent = name;
            document.getElementById('chat-flow').innerHTML = '';
            if (messages[id]) messages[id].forEach(msg => append(msg.side, msg.text, msg.time || ''));
            to('p-chat');
        });
        // ç›¸å†Œç‚¹å‡»æŸ¥çœ‹
        document.getElementById('album-box')?.addEventListener('click', function(e) {
            const thumb = e.target.closest('[data-imgId]'); if (thumb) viewImg(thumb.dataset.imgId);
        });

        // ä¸ªäººèµ„æ–™äº‹ä»¶
        document.getElementById('profile-avatar')?.addEventListener('click', function() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = async (e) => { if (e.target.files[0]) await uploadAvatar(e.target.files[0]); };
            input.click();
        });
        document.getElementById('save-profile-nickname-btn')?.addEventListener('click', saveProfileNickname);
        document.getElementById('save-profile-signature-btn')?.addEventListener('click', saveProfileSignature);
        document.getElementById('save-profile-region-btn')?.addEventListener('click', saveProfileRegion);
        document.getElementById('save-profile-birthday-btn')?.addEventListener('click', saveProfileBirthday);
        document.getElementById('up-wallpaper')?.addEventListener('change', async function(e) {
            if (e.target.files[0]) {
                const file = e.target.files[0]; if (file.size > 5*1024*1024) { alert('å›¾ç‰‡è¶…è¿‡5MB'); return; }
                const id = await saveImageToDB(file); localStorage.setItem('m_wallpaper_id', id); wallpaperId = id;
                await applyWallpaper(); alert('èŠå¤©èƒŒæ™¯å·²æ›´æ¢');
            }
        });
        document.getElementById('font-size-slider')?.addEventListener('input', function(e) {
            const size = e.target.value + 'px'; document.documentElement.style.setProperty('--note-text-size', size);
            document.querySelectorAll('.bubble').forEach(el => el.style.fontSize = size);
        });
        document.getElementById('save-bubble-style-btn')?.addEventListener('click', function() {
            alert('æ°”æ³¡æ ·å¼å·²åˆ‡æ¢ä¸ºï¼š' + document.getElementById('bubble-style-select').value + 'ï¼ˆæ¼”ç¤ºåŠŸèƒ½ï¼‰');
            closeMod('m-bubble-style');
        });

        // è¡¨æƒ…åŒ… & Music
        document.getElementById('emoticon-library-link')?.addEventListener('click', function() { openMod('m-emoticon-library'); });
        document.getElementById('music-link')?.addEventListener('click', function() { openMod('m-music-player'); });
        document.getElementById('add-emoticon-btn')?.addEventListener('click', addEmoticon);
        document.getElementById('add-music-btn')?.addEventListener('click', addMusic);

        // ğŸ†• æ—¥è®°æœ¬
        document.getElementById('save-diary-btn')?.addEventListener('click', addDiary);
        // ğŸ†• çŸ­ä¿¡
        document.getElementById('send-sms-btn')?.addEventListener('click', sendSms);
        // ğŸ†• åº•éƒ¨å¯¼èˆª
        document.getElementById('bottom-sms')?.addEventListener('click', function() { to('p-sms'); });
        document.getElementById('bottom-settings')?.addEventListener('click', function() { openMod('m-api'); });
        document.getElementById('bottom-memory')?.addEventListener('click', function() { openMod('m-music-player'); });
    }

    // ==================== æ—¶é’Ÿ ====================
    function updateClock() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('st-time').innerText = timeStr;
        document.getElementById('big-clock').innerText = timeStr;
        document.getElementById('big-date').innerText = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' });
        const isNight = now.getHours() >= 18 || now.getHours() < 6;
        document.getElementById('p-home').style.color = isNight ? "#fff" : "#000";
        document.getElementById('status-bar').style.color = isNight ? "#fff" : "#000";
    }

    // ==================== å¯åŠ¨ ====================
    (async function init() {
        await openDB();
        photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
        wallpaperId = localStorage.getItem('m_wallpaper_id');
        await applyWallpaper();
        applyTheme(themeColor);
        bindEvents();
        setInterval(updateClock, 1000);
        updateClock();
        await renderAll();
        renderDesktopPhoto();
        setupDesktopPhotoWidget();
        renderCalendar();
        await renderProfile();
    })();
    // ========== ğŸ†• è®ºå›æ•°æ®åˆå§‹åŒ– ==========
let forumSections = FORUM_WORLD.sections;
let currentSectionId = 'tools'; // é»˜è®¤æ˜¾ç¤ºå·¥å…·è¡¥ç»™ç«™
let forumPosts = JSON.parse(localStorage.getItem('m_forum_posts') || '[]');

// é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ’å…¥å‡ æ¡ç¤ºä¾‹å¸–å­ï¼ˆç¬¦åˆæ‰“å·¥äººæ‘¸é±¼ä¸»é¢˜ï¼‰
if (forumPosts.length === 0) {
    forumPosts = [
        { id: 'p1', sectionId: 'tools', author: 'åŒ¿åæ¼‚æµè€…', time: '10:23', content: 'åˆ†äº«ä¸€ä¸‹æˆ‘çš„â€œèµ°åŠ¨å¼æ‘¸é±¼â€ï¼šæ¯åŠå°æ—¶æ¥æ°´ä¸€æ¬¡ï¼Œè·¯è¿‡è€æ¿ä½æ—¶æ‹¿ä¸ªæ–‡ä»¶ï¼Œå®Œç¾ï½', anonymous: true, likes: 15, replies: 3 },
        { id: 'p2', sectionId: 'energy', author: 'å¤–å–çŒäºº', time: '12:05', content: 'ä»Šå¤©æµ‹è¯„å…¬å¸æ¥¼ä¸‹æ–°å¼€çš„è½»é£Ÿï¼Œä¸‰æ˜æ²»é…ç¾½è¡£ç”˜è“ï¼Œ28å…ƒï¼Œé€åˆ¸å23ï¼Œå‘³é“3.5æ˜Ÿï¼Œé¥±è…¹æ„Ÿä¸€èˆ¬ã€‚', anonymous: false, likes: 7, replies: 2 },
        { id: 'p3', sectionId: 'valve', author: 'æ ‘æ´ç”¨æˆ·9527', time: '15:47', content: 'è€æ¿ä»Šå¤©åˆåœ¨æˆ‘èº«åç«™äº†10åˆ†é’Ÿï¼Œä»€ä¹ˆè¯éƒ½æ²¡è¯´ï¼Œæˆ‘å‡è£…åœ¨æ”¹PPTï¼Œå…¶å®åœ¨é€›è®ºå›â€¦â€¦', anonymous: true, likes: 42, replies: 8 }
    ];
    localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
}

// ========== æ¸²æŸ“åˆ†åŒºå¡ç‰‡ ==========
function renderForumSections() {
    const container = document.getElementById('forum-sections');
    if (!container) return;
    container.innerHTML = '';
    forumSections.forEach(section => {
        const card = document.createElement('div');
        card.className = `section-card ${section.requireAuth || section.requireContribution ? 'locked' : ''}`;
        card.onclick = () => {
            if (section.requireAuth) { alert('å‰¯ä¸šå°è‰‡éœ€è¦äººå·¥å®¡æ ¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'); return; }
            if (section.requireContribution) { alert('èˆªæµ·æ—¥å¿—åº“ä»…å¯¹æ ¸å¿ƒè´¡çŒ®è€…å¼€æ”¾'); return; }
            currentSectionId = section.id;
            document.getElementById('forum-section-header').innerText = section.name;
            renderPosts(section.id);
        };
        card.innerHTML = `
            <div class="icon">${section.icon}</div>
            <div class="name">${section.name}</div>
            <div class="desc">${section.desc}</div>
        `;
        container.appendChild(card);
    });
}

// ========== æ¸²æŸ“å¸–å­åˆ—è¡¨ ==========
function renderPosts(sectionId) {
    const postsContainer = document.getElementById('forum-posts');
    if (!postsContainer) return;
    postsContainer.innerHTML = '';
    const filtered = forumPosts.filter(p => p.sectionId === sectionId).reverse();
    if (filtered.length === 0) {
        postsContainer.innerHTML = '<div style="text-align:center; color:var(--note-text-gray); padding:30px;">ğŸŒŠ è¿˜æ²¡æœ‰æ¼‚æµå¸–ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡ï½</div>';
        return;
    }
    filtered.forEach(post => {
        const postEl = document.createElement('div');
        postEl.className = 'post-card';
        postEl.innerHTML = `
            <div class="post-header">
                <span class="post-author">${post.author}${post.anonymous ? '<span class="anonymous-badge">åŒ¿å</span>' : ''}</span>
                <span>${post.time}</span>
            </div>
            <div class="post-content">${post.content}</div>
            <div class="post-footer">
                <div class="post-stats">
                    <span>ğŸ‘ ${post.likes}</span>
                    <span>ğŸ’¬ ${post.replies}</span>
                </div>
                <span onclick="likePost('${post.id}')" style="cursor:pointer; color:var(--theme-primary);">ç‚¹èµ</span>
            </div>
        `;
        postsContainer.appendChild(postEl);
    });
}

// ========== ç‚¹èµåŠŸèƒ½ ==========
function likePost(postId) {
    const post = forumPosts.find(p => p.id === postId);
    if (post) {
        post.likes += 1;
        localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
        renderPosts(currentSectionId);
    }
}

// ========== æ‰“å¼€å‘å¸–å¼¹çª— ==========
function openForumPostModal() {
    const availableSections = forumSections.filter(s => !s.requireAuth && !s.requireContribution);
    const optionsHtml = availableSections.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    const modalHtml = `
        <div class="modal" id="m-forum-post" style="display:flex;">
            <div class="modal-body">
                <h3>æ¼‚æµæ—¥è®° Â· å‘å¸ƒæ–°å¸–</h3>
                <select id="post-section" style="margin-bottom:12px; width:100%; padding:12px; border:1px solid var(--note-border); border-radius:var(--note-radius-hard);">
                    ${optionsHtml}
                </select>
                <textarea id="post-content" rows="5" placeholder="åˆ†äº«ä½ çš„æ¼‚æµå¿ƒå¾—..." style="width:100%; resize:vertical;"></textarea>
                <label style="display:flex; align-items:center; margin:12px 0;">
                    <input type="checkbox" id="post-anonymous" checked> åŒ¿åå‘å¸ƒ
                </label>
                <button class="modal-btn" id="submit-post-btn">å‘å¸ƒ</button>
                <button class="modal-cancel" onclick="closeMod('m-forum-post')">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHtml;
    document.body.appendChild(div);
    document.getElementById('submit-post-btn').onclick = submitForumPost;
}

// ========== æäº¤å¸–å­ ==========
function submitForumPost() {
    const sectionId = document.getElementById('post-section').value;
    const content = document.getElementById('post-content').value.trim();
    if (!content) { alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
    const anonymous = document.getElementById('post-anonymous').checked;
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    const newPost = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 4),
        sectionId,
        author: anonymous ? 'åŒ¿åæ¼‚æµè€…' : `æ¼‚æµè€…${Math.floor(Math.random()*1000)}`,
        time: timeStr,
        content,
        anonymous,
        likes: 0,
        replies: 0
    };
    forumPosts.push(newPost);
    localStorage.setItem('m_forum_posts', JSON.stringify(forumPosts));
    closeMod('m-forum-post');
    setTimeout(() => {
        const el = document.getElementById('m-forum-post');
        if (el) el.remove();
    }, 100);
    renderPosts(currentSectionId);
}

// ========== ä¸–ç•Œè§‚å¼¹çª— ==========
// åœ¨åŸæœ‰çš„ openMod å‡½æ•°ä¸­å¢åŠ  m-forum-world å¤„ç†
// å¦‚æœä½ ä¹‹å‰å·²ç»æ”¹è¿‡ openModï¼Œè¯·ç¡®ä¿åŒ…å«ä»¥ä¸‹é€»è¾‘ï¼›è‹¥æ²¡æ”¹ï¼Œç›´æ¥å¤åˆ¶ä¸‹é¢æ•´ä¸ªå‡½æ•°ä¼šè¦†ç›–åŸå‡½æ•°ï¼
// å®‰å…¨åšæ³•ï¼šåœ¨ openMod å‡½æ•°å†…éƒ¨æ·»åŠ ä»¥ä¸‹åˆ†æ”¯
const originalOpenMod = openMod;
openMod = function(id) {
    if (id === 'm-forum-world') {
        const modalHtml = `
            <div class="modal" id="m-forum-world" style="display:flex;">
                <div class="modal-body">
                    <h3>ğŸŒ æ‰“å·¥äººæ‘¸é±¼è®ºå› Â· ä¸–ç•Œè§‚</h3>
                    <p style="margin-bottom:12px;"><strong>å£å·ï¼š</strong>â€œ${FORUM_WORLD.slogan}â€</p>
                    <p style="margin-bottom:12px;"><strong>æ–‡åŒ–ç¬¦å·ï¼š</strong>å¸¦è–ªæ‹‰å± Â· é’“é±¼ Â· æ½œæ°´ Â· ä¸Šå²¸</p>
                    <p style="margin-bottom:12px;"><strong>ç»å¯¹ç¦å¿Œï¼š</strong></p>
                    <ul style="padding-left:20px; color:var(--note-text-gray);">
                        ${FORUM_WORLD.rules.map(r => `<li style="margin-bottom:4px;">${r}</li>`).join('')}
                    </ul>
                    <button class="modal-cancel" onclick="closeMod('m-forum-world')">å…³é—­</button>
                </div>
            </div>
        `;
        const div = document.createElement('div');
        div.innerHTML = modalHtml;
        document.body.appendChild(div);
        return;
    }
    // è°ƒç”¨åŸ openMod å‡½æ•°
    if (originalOpenMod) originalOpenMod.call(this, id);
};

// ========== ä¿®æ”¹è·¯ç”± to å‡½æ•°ï¼Œè¿›å…¥è®ºå›æ—¶æ¸²æŸ“ ==========
const originalTo = to;
to = function(id) {
    if (originalTo) originalTo.call(this, id);
    if (id === 'p-forum') {
        // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­åˆ†åŒºï¼Œé»˜è®¤é€‰ç¬¬ä¸€ä¸ªå¯ç”¨åˆ†åŒº
        if (!currentSectionId || currentSectionId === '') {
            const firstAvail = forumSections.find(s => !s.requireAuth && !s.requireContribution);
            currentSectionId = firstAvail ? firstAvail.id : 'tools';
        }
        renderForumSections();
        const sectionName = forumSections.find(s => s.id === currentSectionId)?.name || 'å·¥å…·è¡¥ç»™ç«™';
        document.getElementById('forum-section-header').innerText = sectionName;
        renderPosts(currentSectionId);
    }
};
</script>
</body>
</html>
