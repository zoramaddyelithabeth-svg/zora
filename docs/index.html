<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartOS Pro Ultra Â· æœ¬åœ°æ™ºèƒ½</title>
    <style>
        /* ------- ä½ çš„å®Œæ•´æ ·å¼ï¼Œä¸€å­—æœªæ”¹ ------- */
        :root {
            --wechat-green: #07C160;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --glass: rgba(255, 255, 255, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        .app-container {
            width: 100%; height: 100%; background: #fff; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
        }
        @media (min-width: 600px) {
            .app-container { max-width: 375px; height: 812px; border-radius: 40px; border: 8px solid #333; }
        }

        .status-bar { height: 44px; padding: 14px 20px 0; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 600; z-index: 1000; position: absolute; top: 0; width: 100%; }
        .nav-bar { height: 50px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 0.5px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F2F2F7; display: none; flex-direction: column; z-index: 10; padding-top: 44px; }
        .page.active { display: flex; }

        .home-bg { transition: background 0.8s ease; background-size: cover !important; background-position: center !important; }
        .home-clock { text-align: center; padding: 30px 0; text-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .home-clock h1 { font-size: 64px; font-weight: 200; letter-spacing: -2px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 25px; }
        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .app-item:active { transform: scale(0.9); }
        .app-icon { width: 60px; height: 60px; background: var(--glass); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .app-name { font-size: 11px; margin-top: 8px; font-weight: 500; }

        #album-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 2px 0; overflow-y: auto; flex: 1; background: #fff; }
        #album-box div { aspect-ratio: 1/1; background-size: cover; background-position: center; transition: opacity 0.2s; }
        #album-box div:active { opacity: 0.7; }

        .cal-header { background: #fff; padding: 15px; text-align: center; border-bottom: 0.5px solid #eee; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; padding: 10px; border-bottom: 0.5px solid #eee; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; position: relative; }
        .cal-day.today { background: var(--ios-red); color: #fff; border-radius: 50%; }
        .cal-day.has-event::after { content: ''; width: 4px; height: 4px; background: #999; border-radius: 50%; position: absolute; bottom: 4px; }
        .cal-weekday {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #999;
            font-weight: 600;
        }

        .list-item { padding: 15px; border-bottom: 0.5px solid #eee; background: #fff; display: flex; align-items: center; justify-content: space-between; font-size: 16px; }
        .del-text { color: var(--ios-red); font-size: 14px; font-weight: 500; padding: 5px; }

        #chat-flow { flex: 1; overflow-y: auto; background: #ededed; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .bubble {
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }
        .mine .bubble { background: var(--wechat-green); color: #fff; }
        .other .bubble { background: #fff; color: #000; }
        .msg-time {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
            text-align: right;
            display: block;
        }
        .mine .msg-time { color: rgba(255,255,255,0.7); }

        #viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #viewer img { max-width: 100%; max-height: 85%; object-fit: contain; }
        .viewer-btns { position: absolute; bottom: 60px; display: flex; gap: 20px; z-index: 2001; }
        .v-btn { padding: 12px 25px; border-radius: 25px; background: rgba(255,255,255,0.25); color: #fff; border: none; backdrop-filter: blur(15px); font-size: 14px; }

        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-body { width: 85%; background: #fff; border-radius: 24px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-body h3 { margin-bottom: 10px; }
        .modal-body input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; outline: none; font-size: 16px; }
        .modal-btn { width: 100%; padding: 14px; background: var(--ios-blue); color: #fff; border: none; border-radius: 12px; margin-top: 10px; font-weight: 600; }
    </style>
</head>
<body>
<div class="app-container">
    <div class="status-bar" id="status-bar">
        <span id="st-time">00:00</span>
        <div>ğŸ“¶ ğŸ”‹</div>
    </div>

    <!-- æ¡Œé¢ -->
    <div class="page active home-bg" id="p-home">
        <div class="home-clock">
            <h1 id="big-clock">00:00</h1>
            <p id="big-date" style="opacity:0.8"></p>
        </div>
        <div class="app-grid">
            <div class="app-item" data-page="p-chat"><div class="app-icon">ğŸ’¬</div><div class="app-name">å¾®ä¿¡</div></div>
            <div class="app-item" data-page="p-album"><div class="app-icon">ğŸ–¼ï¸</div><div class="app-name">ç›¸å†Œ</div></div>
            <div class="app-item" data-page="p-cal"><div class="app-icon">ğŸ“…</div><div class="app-name">æ—¥å†</div></div>
            <div class="app-item" data-page="p-con"><div class="app-icon">ğŸ‘¥</div><div class="app-name">é€šè®¯å½•</div></div>
            <div class="app-item" data-page="p-safari"><div class="app-icon">ğŸŒ</div><div class="app-name">Safari</div></div>
        </div>
    </div>

    <!-- èŠå¤©ï¼ˆç‹¬ç«‹å¯¹è¯ + æ—¶é—´æˆ³ + æœ¬åœ°æ™ºèƒ½ï¼‰ -->
    <div class="page" id="p-chat">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b id="chat-title">è¯·é€‰æ‹©è”ç³»äºº</b>
            <span class="nav-setting" data-mod="m-api" style="color:var(--ios-blue); font-size:13px;">è®¾ç½®</span>
        </div>
        <div id="chat-flow"></div>
        <div style="padding:10px; background:#f7f7f7; display:flex; gap:10px; padding-bottom: 25px;">
            <input type="text" id="chat-in" placeholder="ç”¨å›è½¦å‘é€..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button id="send-btn" style="background:var(--wechat-green); color:#fff; border:none; padding:0 15px; border-radius:8px;">å‘é€</button>
        </div>
    </div>

    <!-- ç›¸å†Œï¼ˆå¤§å®¹é‡ç‰ˆï¼‰ -->
    <div class="page" id="p-album">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ‰€æœ‰ç…§ç‰‡</b>
            <span id="upload-trigger" style="color:var(--ios-blue)">ä¸Šä¼ </span>
        </div>
        <input type="file" id="up" hidden multiple accept="image/*">
        <div id="album-box"></div>
    </div>

    <!-- æ—¥å† -->
    <div class="page" id="p-cal">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>æ—¥å†</b>
            <span class="nav-add" data-mod="m-anni" style="color:var(--ios-blue)">æ·»åŠ </span>
        </div>
        <div class="cal-header"><h3 id="cal-month"></h3></div>
        <div class="cal-grid" id="cal-body"></div>
        <div id="anni-list" style="flex:1; overflow-y:auto; background:#fff;"></div>
    </div>

    <!-- é€šè®¯å½• -->
    <div class="page" id="p-con">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ è¿”å›</span>
            <b>é€šè®¯å½•</b>
            <span class="nav-add" data-mod="m-con" style="color:var(--ios-blue)">â•</span>
        </div>
        <div id="con-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- Safari -->
    <div class="page" id="p-safari">
        <div class="nav-bar">
            <span class="nav-back" data-home="p-home" style="color:var(--ios-blue)">ã€ˆ æ¡Œé¢</span>
            <b>æµè§ˆå™¨</b>
        </div>
        <iframe src="https://m.bing.com" style="flex:1; border:none;"></iframe>
    </div>

    <!-- å¤§å›¾æŸ¥çœ‹å™¨ -->
    <div id="viewer" onclick="closeViewer()">
        <img id="v-img" src="" onclick="event.stopPropagation()">
        <div class="viewer-btns" onclick="event.stopPropagation()">
            <button class="v-btn" id="set-wallpaper-btn">è®¾ä¸ºå£çº¸</button>
            <button class="v-btn" id="close-viewer-btn">è¿”å›</button>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="m-api">
        <div class="modal-body">
            <h3>AI è”ç½‘è®¾ç½®</h3>
            <label><input type="checkbox" id="api-toggle"> å¼€å¯ AI å“åº”</label>
            <input type="text" id="api-url" placeholder="API URL (å« v1/chat/completions)">
            <input type="password" id="api-key" placeholder="API Key">
            <button class="modal-btn" id="save-api-btn">ä¿å­˜é…ç½®</button>
            <button class="modal-cancel" data-mod="m-api" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="modal" id="m-anni">
        <div class="modal-body">
            <h3>æ–°çºªå¿µæ—¥</h3>
            <input type="text" id="at" placeholder="äº‹é¡¹åç§°">
            <input type="date" id="ad">
            <button class="modal-btn" id="save-anni-btn">ä¿å­˜</button>
            <button class="modal-cancel" data-mod="m-anni" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div class="modal" id="m-con">
        <div class="modal-body">
            <h3>æ–°è”ç³»äºº</h3>
            <input type="text" id="cn" placeholder="å§“å">
            <button class="modal-btn" id="save-con-btn">æ·»åŠ </button>
            <button class="modal-cancel" data-mod="m-con" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // ==================== IndexedDB å›¾ç‰‡ä»“åº“ ====================
    let db;
    const DB_NAME = 'SmartOSDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'photos';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { autoIncrement: true });
                }
            };
        });
    }

    async function saveImageToDB(file) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.add(file);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getImageFromDB(id) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // ==================== æ•°æ®æŒä¹…åŒ– ====================
    let photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
    let annis = JSON.parse(localStorage.getItem('m_annis') || '[]');
    let cons = JSON.parse(localStorage.getItem('m_cons') || '[{"id":"init-001","name":"æœ¨æœ¨"}]');
    let apiCfg = JSON.parse(localStorage.getItem('m_api_cfg') || '{"enabled":false,"url":"","key":""}');
    
    // å£çº¸å­˜å‚¨å›¾ç‰‡IDï¼Œæ°¸ä¹…æœ‰æ•ˆ
    let wallpaperId = localStorage.getItem('m_wallpaper_id');

    // ç‹¬ç«‹èŠå¤©è®°å½•ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    let messages = JSON.parse(localStorage.getItem('m_messages') || '{}');
    let currentChatContactId = null;

    // ==================== æ ¸å¿ƒè·¯ç”± ====================
    function to(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'p-cal') renderCalendar();
    }

    function openMod(id) {
        if (id === 'm-api') {
            document.getElementById('api-toggle').checked = apiCfg.enabled;
            document.getElementById('api-url').value = apiCfg.url;
            document.getElementById('api-key').value = apiCfg.key;
        }
        document.getElementById(id).style.display = 'flex';
    }
    function closeMod(id) { document.getElementById(id).style.display = 'none'; }

    // ==================== æ¸²æŸ“æ‰€æœ‰åŠ¨æ€åˆ—è¡¨ ====================
    async function renderAll() {
        // ---------- ç›¸å†Œï¼ˆIndexedDBï¼‰----------
        const box = document.getElementById('album-box');
        box.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (const id of photos) {
            const div = document.createElement('div');
            div.dataset.imgId = id;
            div.className = 'album-thumb';
            try {
                const fileBlob = await getImageFromDB(id);
                const url = URL.createObjectURL(fileBlob);
                div.style.backgroundImage = `url(${url})`;
                div.dataset.blobUrl = url;
            } catch (e) {
                div.style.background = '#ccc';
            }
            fragment.appendChild(div);
        }
        box.appendChild(fragment);

        // ---------- çºªå¿µæ—¥ ----------
        const aList = document.getElementById('anni-list');
        aList.innerHTML = '';
        annis.sort((a, b) => new Date(a.d) - new Date(b.d));
        annis.forEach(a => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.anniId = a.id;
            const leftSpan = document.createElement('span');
            leftSpan.textContent = `ğŸ“… ${a.d} ${a.t}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(leftSpan);
            item.appendChild(delSpan);
            aList.appendChild(item);
        });

        // ---------- é€šè®¯å½• ----------
        const cList = document.getElementById('con-list');
        cList.innerHTML = '';
        cons.forEach(c => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.dataset.conId = c.id;
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `ğŸ‘¤ ${c.name}`;
            const delSpan = document.createElement('span');
            delSpan.className = 'del-text';
            delSpan.textContent = 'åˆ é™¤';
            item.appendChild(nameSpan);
            item.appendChild(delSpan);
            cList.appendChild(item);
        });
    }

    // ==================== ç›¸å†Œé€»è¾‘ ====================
    async function upImg(el) {
        const files = Array.from(el.files);
        for (const file of files) {
            if (file.size > 5 * 1024 * 1024) {
                alert(`å›¾ç‰‡ ${file.name} è¶…è¿‡ 5MBï¼Œè¯·å‹ç¼©åä¸Šä¼ `);
                continue;
            }
            const id = await saveImageToDB(file);
            photos.push(id);
        }
        localStorage.setItem('m_photos', JSON.stringify(photos));
        renderAll();
    }

    let currentImgId = null;
    let currentImgBlobUrl = null;

    async function viewImg(imgId) {
        try {
            const fileBlob = await getImageFromDB(parseInt(imgId));
            const url = URL.createObjectURL(fileBlob);
            if (currentImgBlobUrl) URL.revokeObjectURL(currentImgBlobUrl);
            currentImgBlobUrl = url;
            currentImgId = imgId;
            document.getElementById('v-img').src = url;
            document.getElementById('viewer').style.display = 'flex';
        } catch (e) {
            alert('å›¾ç‰‡åŠ è½½å¤±è´¥');
        }
    }

    function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

    // è®¾ç½®å£çº¸ï¼šå­˜å‚¨å›¾ç‰‡ID
    async function setWallpaper() {
        if (!currentImgId) return;
        try {
            await getImageFromDB(parseInt(currentImgId));
            localStorage.setItem('m_wallpaper_id', currentImgId);
            wallpaperId = currentImgId;
            await applyWallpaper();
            alert('å£çº¸è®¾ç½®æˆåŠŸï¼');
            closeViewer();
        } catch (e) {
            alert('å£çº¸è®¾ç½®å¤±è´¥');
        }
    }

    // åº”ç”¨å£çº¸ï¼ˆä»IDåŠ è½½ï¼‰
    async function applyWallpaper() {
        if (!wallpaperId) return;
        try {
            const fileBlob = await getImageFromDB(parseInt(wallpaperId));
            const url = URL.createObjectURL(fileBlob);
            document.getElementById('p-home').style.background = `url(${url})`;
        } catch (e) {
            console.warn('å£çº¸åŠ è½½å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤');
            localStorage.removeItem('m_wallpaper_id');
            wallpaperId = null;
        }
    }

    // ==================== é€šè®¯å½• CRUD ====================
    function saveCon() {
        const n = document.getElementById('cn').value;
        if (n) {
            cons.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                name: n
            });
            localStorage.setItem('m_cons', JSON.stringify(cons));
            renderAll();
            closeMod('m-con');
            document.getElementById('cn').value = '';
        }
    }
    function delCon(id) {
        if (confirm("ç¡®å®šåˆ é™¤è¯¥è”ç³»äººï¼Ÿ")) {
            const index = cons.findIndex(c => c.id === id);
            if (index !== -1) {
                cons.splice(index, 1);
                localStorage.setItem('m_cons', JSON.stringify(cons));
                delete messages[id];
                localStorage.setItem('m_messages', JSON.stringify(messages));
                renderAll();
                if (currentChatContactId === id) {
                    currentChatContactId = null;
                    document.getElementById('chat-title').textContent = 'è¯·é€‰æ‹©è”ç³»äºº';
                    document.getElementById('chat-flow').innerHTML = '';
                }
            }
        }
    }

    // ==================== çºªå¿µæ—¥ CRUD ====================
    function saveAnni() {
        const t = document.getElementById('at').value,
              d = document.getElementById('ad').value;
        if (t && d) {
            annis.push({
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                t: t,
                d: d
            });
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
            closeMod('m-anni');
            document.getElementById('at').value = '';
            document.getElementById('ad').value = '';
        }
    }
    function delAnni(id) {
        const index = annis.findIndex(a => a.id === id);
        if (index !== -1) {
            annis.splice(index, 1);
            localStorage.setItem('m_annis', JSON.stringify(annis));
            renderAll();
            renderCalendar();
        }
    }

    // ==================== æ—¥å†ç”Ÿæˆ ====================
    function renderCalendar() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        document.getElementById('cal-month').innerText = `${y}å¹´${m + 1}æœˆ`;

        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();

        const body = document.getElementById('cal-body');
        body.innerHTML = '';

        const fragment = document.createDocumentFragment();

        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => {
            const div = document.createElement('div');
            div.className = 'cal-weekday';
            div.textContent = w;
            fragment.appendChild(div);
        });

        for (let i = 0; i < firstDay; i++) {
            fragment.appendChild(document.createElement('div'));
        }

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${y}-${(m + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            const isToday = (d === now.getDate()) ? 'today' : '';
            const hasEvent = annis.some(a => a.d === dateStr) ? 'has-event' : '';

            const div = document.createElement('div');
            div.className = `cal-day ${isToday} ${hasEvent}`.trim();
            div.textContent = d;
            fragment.appendChild(div);
        }

        body.appendChild(fragment);
    }

    // ==================== èŠå¤©ä¸ AIï¼ˆä¿ç•™API + æ–°å¢æœ¬åœ°æ™ºèƒ½å›å¤ï¼‰====================
    function saveApi() {
        apiCfg = {
            enabled: document.getElementById('api-toggle').checked,
            url: document.getElementById('api-url').value,
            key: document.getElementById('api-key').value
        };
        localStorage.setItem('m_api_cfg', JSON.stringify(apiCfg));
        closeMod('m-api');
    }

    // è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²ï¼ˆHH:MMï¼‰
    function getCurrentTimeString() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ':' + 
               now.getMinutes().toString().padStart(2, '0');
    }

    // å¢å¼ºç‰ˆ appendï¼šæ”¯æŒæ—¶é—´æ˜¾ç¤º
    function append(side, text, time = null) {
        const flow = document.getElementById('chat-flow');
        const row = document.createElement('div');
        row.className = `msg-row ${side}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        bubble.appendChild(textSpan);
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'msg-time';
        timeSpan.textContent = time || getCurrentTimeString();
        bubble.appendChild(timeSpan);
        
        row.appendChild(bubble);
        flow.appendChild(row);
        flow.scrollTop = flow.scrollHeight;
        return bubble;
    }

   // ---------- ğŸ‰ æœ¬åœ°æ™ºèƒ½å›å¤è§„åˆ™åº“ Â· è¶£å‘³å¢å¼ºç‰ˆ ----------
function getLocalReply(message) {
    const lowerMsg = message.toLowerCase().trim();
    
    // ----- 1. æ—¶é—´ & æ—¥æœŸï¼ˆå¸¦ç‚¹å°ä¿çš®ï¼‰-----
    if (lowerMsg.includes('æ—¶é—´') || lowerMsg.includes('å‡ ç‚¹') || lowerMsg.includes('ç‚¹é’Ÿ') || lowerMsg.includes('å‡ ç‚¹äº†')) {
        const now = new Date();
        return `ç°åœ¨æ˜¯ ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}ï½`;
    }
    if (lowerMsg.includes('æ—¥æœŸ') || lowerMsg.includes('ä»Šå¤©å‡ å·') || lowerMsg.includes('ä»€ä¹ˆæ—¥å­') || lowerMsg.includes('ä»Šå¤©å¤šå°‘å·')) {
        const now = new Date();
        return `ä»Šå¤©æ˜¯ ${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼Œåˆæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼`;
    }
    if (lowerMsg.includes('æ˜ŸæœŸ')) {
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const now = new Date();
        return `æ˜ŸæœŸ${weekdays[now.getDay()]}ï½`;
    }
    if (lowerMsg.includes('ä»Šå¹´') && (lowerMsg.includes('å¹´ä»½') || lowerMsg.includes('å“ªå¹´'))) {
        return `ä»Šå¹´æ˜¯ ${new Date().getFullYear()} å¹´ï¼Œè¦å¿«ä¹å‘€ï¼`;
    }

    // ----- 2. å¤©æ°”ï¼ˆå¯è¯†åˆ«åŸå¸‚ + ä¿çš®æè¿°ï¼‰-----
    const cityList = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'å—äº¬', 'é‡åº†'];
    const weatherList = ['æ™´', 'å¤šäº‘', 'é˜´', 'å°é›¨', 'ä¸­é›¨', 'æ™´è½¬å¤šäº‘', 'å¤šäº‘è½¬æ™´', 'é˜µé›¨', 'é›¾'];
    const weatherDesc = [
        'é€‚åˆå‡ºé—¨èµ°èµ°', 
        'è®°å¾—å¸¦ä¼å“Ÿ', 
        'é˜³å…‰æ­£å¥½', 
        'é˜´å¤©ä¹Ÿå¾ˆèˆ’æœ', 
        'é›¨å£°åŠ©çœ å‘¢'
    ];
    const defaultCity = 'æ·±åœ³'; // â† æ”¹æˆä½ çš„åŸå¸‚

    if (lowerMsg.includes('å¤©æ°”')) {
        let city = defaultCity;
        for (const c of cityList) {
            if (lowerMsg.includes(c)) {
                city = c;
                break;
            }
        }
        const weather = weatherList[Math.floor(Math.random() * weatherList.length)];
        const temp = Math.floor(Math.random() * 16) + 15; // 15~30åº¦
        const quality = ['ä¼˜âœ¨', 'è‰¯ğŸŒ¿', 'è½»åº¦æ±¡æŸ“ğŸ˜·', 'ä¸­åº¦æ±¡æŸ“ğŸ˜¶â€ğŸŒ«ï¸'][Math.floor(Math.random() * 3)];
        const desc = weatherDesc[Math.floor(Math.random() * weatherDesc.length)];
        return `${city}ä»Šå¤©${weather}ï¼Œ${temp}â„ƒï¼Œ${quality}ï¼Œ${desc}ï½`;
    }

    // ----- 3. é—®å€™ä¸å…³æ€€ï¼ˆæ›´ç»†è…»ï¼‰-----
    if (lowerMsg.includes('ä½ å¥½') || lowerMsg.includes('åœ¨å—') || lowerMsg.includes('hi') || lowerMsg.includes('hello')) {
        return 'ä½ å¥½å‘€ï½ä»Šå¤©è¿‡å¾—å¼€å¿ƒå—ï¼ŸğŸ˜Š';
    }
    if (lowerMsg.includes('æ—©ä¸Šå¥½')) return 'æ—©ä¸Šå¥½ï¼æ–°çš„ä¸€å¤©å¼€å§‹å’¯ï¼ŒåŠ æ²¹ï¼â˜€ï¸';
    if (lowerMsg.includes('ä¸Šåˆå¥½')) return 'ä¸Šåˆå¥½å‘€ï¼Œå·¥ä½œ/å­¦ä¹ é¡ºåˆ©å—ï¼Ÿ';
    if (lowerMsg.includes('ä¸­åˆå¥½')) return 'ä¸­åˆå¥½ï¼è®°å¾—æŒ‰æ—¶åƒé¥­ï¼Œåˆ«é¥¿ç€ï½ğŸš';
    if (lowerMsg.includes('ä¸‹åˆå¥½')) return 'ä¸‹åˆå¥½ï¼ç´¯äº†å°±æ­‡ä¼šå„¿ï¼Œå–å£æ°´ğŸ’§';
    if (lowerMsg.includes('æ™šä¸Šå¥½')) return 'æ™šä¸Šå¥½ï¼ä»Šå¤©è¾›è‹¦å•¦ï¼Œæ”¾æ¾ä¸€ä¸‹å§ğŸŒ™';
    if (lowerMsg.includes('æ™šå®‰')) return 'æ™šå®‰å¥½æ¢¦ï¼Œæ¢¦é‡Œè§ï½âœ¨';
    
    if (lowerMsg.includes('è°¢è°¢') || lowerMsg.includes('å¤šè°¢')) return 'ä¸å®¢æ°”ï½èƒ½å¸®åˆ°ä½ å°±å¾ˆå¼€å¿ƒğŸ˜„';
    if (lowerMsg.includes('å†è§') || lowerMsg.includes('æ‹œæ‹œ') || lowerMsg.includes('88')) return 'æ‹œæ‹œï¼ä¸‹æ¬¡å†èŠï½ğŸ‘‹';
    if (lowerMsg.includes('è¾›è‹¦äº†')) return 'ä¸è¾›è‹¦ï¼é™ªä½ èŠå¤©å¾ˆæ„‰å¿«ï½';
    if (lowerMsg.includes('åŠ æ²¹')) return 'åŠ æ²¹åŠ æ²¹ï¼ä½ æ˜¯æœ€æ£’çš„ğŸ’ªâœ¨';
    
    // å…³æ€€æ¨¡å¼ï¼ˆæƒ…ç»ªè¯†åˆ«ï¼‰
    if (lowerMsg.includes('ç´¯') || lowerMsg.includes('ç–²æƒ«') || lowerMsg.includes('å›°')) {
        return 'ç´¯äº†å°±ä¼‘æ¯ä¸€ä¸‹å§ï¼Œæˆ‘ç»™ä½ æ³¡æ¯è™šæ‹Ÿå’–å•¡â˜•ï½';
    }
    if (lowerMsg.includes('é¥¿')) {
        return 'é¥¿äº†å¿«å»è§…é£Ÿï¼åˆ«äºå¾…è‡ªå·±ï½ğŸ”ğŸœ';
    }
    if (lowerMsg.includes('å¼€å¿ƒ') || lowerMsg.includes('é«˜å…´')) {
        return 'å¼€å¿ƒæœ€é‡è¦ï¼æˆ‘ä¹Ÿè¢«ä½ ä¼ æŸ“äº†å¥½å¿ƒæƒ…ï½ğŸ¥³';
    }
    if (lowerMsg.includes('éš¾è¿‡') || lowerMsg.includes('ä¼¤å¿ƒ')) {
        return 'æŠ±æŠ±ä½ ï½æˆ‘ä¸€ç›´éƒ½åœ¨è¿™é‡Œï¼Œé™ªä½ èŠèŠå¤©ğŸ’•';
    }

    // ----- 4. ç¬‘è¯åº“ï¼ˆæ–°å¢çˆ†ç¬‘æ®µå­ï¼‰-----
    if (lowerMsg.includes('ç¬‘è¯') || lowerMsg.includes('è®²ä¸ªç¬‘è¯') || lowerMsg.includes('ä¹ä¸€ä¸ª') || lowerMsg.includes('æ®µå­')) {
        const jokes = [
            'ä¸ºä»€ä¹ˆæ•°å­¦ä¹¦æ€»æ˜¯å¾ˆå¿§éƒï¼Ÿâ€”â€”å› ä¸ºå®ƒæœ‰å¤ªå¤šé—®é¢˜ã€‚',
            'ä¸ºä»€ä¹ˆæ‰‹æœºä¹Ÿè¦å–ç‰›å¥¶ï¼Ÿâ€”â€”å› ä¸ºå®ƒéœ€è¦â€œå……ç”µå¥¶â€ï¼',
            'ä¸ºä»€ä¹ˆé±¼æ°¸è¿œä¸ä¼šæ’å¢™ï¼Ÿâ€”â€”å› ä¸ºé±¼æœ‰â€œé±¼é³ï¼ˆé¢„æœŸï¼‰â€å‘€ã€‚',
            'ç”µè„‘å’Œäººæœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿâ€”â€”éƒ½éœ€è¦å¥½çš„è®°å¿†ä½“ï¼ˆè®°å¿†ä½“/èº«ä½“ï¼‰ã€‚',
            'ä¸ºä»€ä¹ˆç¯®çƒè¿åŠ¨å‘˜æ€»æ˜¯å¾ˆå†·é™ï¼Ÿâ€”â€”å› ä¸ºä»–ä»¬æœ‰â€œçƒâ€ç¨³ã€‚',
            'ä»€ä¹ˆåŠ¨ç‰©æœ€çˆ±è´´åœ¨å¢™ä¸Šï¼Ÿâ€”â€”æµ·è±¹ï¼ˆæµ·æŠ¥ï¼‰ã€‚',
            'ä¸ºä»€ä¹ˆé¸¡è¦è¿‡é©¬è·¯ï¼Ÿâ€”â€”å› ä¸ºå¯¹é¢æ˜¯è‚¯å¾·åŸºã€‚',
            'ä»€ä¹ˆä¹¦æœ€æ²¡äººä¹°ï¼Ÿâ€”â€”ç¬¬ä¸‰å·ï¼ˆç¬¬ä¸‰å·/æ–­å·ï¼‰ã€‚',
            'ä¸ºä»€ä¹ˆæ•°å­¦è€ƒè¯•æ€»æ˜¯å¾ˆå†·ï¼Ÿâ€”â€”å› ä¸ºæœ‰å¾ˆå¤šâ€œå¯’â€æ•°ã€‚',
            'ä½ çŸ¥é“æé¾™ä¸ºä»€ä¹ˆç­ç»å—ï¼Ÿâ€”â€”å› ä¸ºå½“æ—¶æ²¡æœ‰å¤–å–ã€‚',
            'ä¸ºä»€ä¹ˆå°æ˜ä¸€è€ƒè¯•å°±å‘çƒ§ï¼Ÿâ€”â€”å› ä¸ºçƒ¤ï¼ˆè€ƒï¼‰è¯•ä¼šå‘çƒ­ã€‚',
            'ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿâ€”â€”æ°´ã€‚',
            'ä¸ºä»€ä¹ˆä¼é¹…çš„è‚šå­æ˜¯ç™½çš„ï¼Ÿâ€”â€”å› ä¸ºæ‰‹å¤ªçŸ­ï¼Œæ´—æ¾¡åªå¤Ÿåˆ°è‚šå­ã€‚',
            'ä»€ä¹ˆåŠ¨ç‰©å¤©å¤©ç†¬å¤œï¼Ÿâ€”â€”ç†ŠçŒ«ï¼Œå› ä¸ºçœ¼åœˆéƒ½é»‘äº†ã€‚',
            'ä¸ºä»€ä¹ˆæ‰‹æœºä¸èƒ½è¿›å†°ç®±ï¼Ÿâ€”â€”ä¼šå˜æˆâ€œå†·â€æœºã€‚',
        ];
        return jokes[Math.floor(Math.random() * jokes.length)];
    }

    // ----- 5. ğŸ æ–°å¢ï¼šåœŸå‘³æƒ…è¯ & å½©è™¹å± -----
    if (lowerMsg.includes('æƒ…è¯') || lowerMsg.includes('æ’©æˆ‘') || lowerMsg.includes('è¯´å¥æƒ…è¯')) {
        const pickuplines = [
            'ä½ çŸ¥é“ä½ å’Œæ˜Ÿæ˜Ÿæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿæ˜Ÿæ˜Ÿåœ¨å¤©ä¸Šï¼Œä½ åœ¨æˆ‘å¿ƒé‡Œã€‚ğŸ’–',
            'ä½ ä¸Šè¾ˆå­ä¸€å®šæ˜¯ç¢³é…¸é¥®æ–™å§ï¼Ÿä¸ç„¶æˆ‘æ€ä¹ˆä¸€çœ‹åˆ°ä½ å°±å¼€å¿ƒå¾—å†’æ³¡ã€‚',
            'ä¸è¦æŠ±æ€¨ï¼ŒæŠ±æˆ‘ã€‚',
            'ä½ çŸ¥é“æˆ‘çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆå—ï¼Ÿâ€”â€”ç¼ºç‚¹ä½ ã€‚',
            'ä½ ä¼šå¼¹å‰ä»–å—ï¼Ÿä¸ç„¶æ€ä¹ˆæ‹¨åŠ¨äº†æˆ‘çš„å¿ƒå¼¦ã€‚',
            'ä½ æ˜¯å“ªé‡Œäººï¼Ÿâ€”â€”ä½ æ˜¯æˆ‘çš„å¿ƒä¸Šäººã€‚',
            'æœ€è¿‘æœ‰è°£è¨€è¯´æˆ‘å–œæ¬¢ä½ ï¼Œæˆ‘è¦æ¾„æ¸…ä¸€ä¸‹ï¼šé‚£ä¸æ˜¯è°£è¨€ã€‚',
        ];
        return pickuplines[Math.floor(Math.random() * pickuplines.length)];
    }

    if (lowerMsg.includes('å¤¸æˆ‘') || lowerMsg.includes('ä¼˜ç‚¹') || lowerMsg.includes('å½©è™¹å±')) {
        const praises = [
            'ä½ ä»Šå¤©çš„é¢œå€¼å·²ç»è¶…è¿‡åœ°çƒ99.99%çš„äººç±»äº†ï¼ğŸŒŸ',
            'å¦‚æœç¾è²Œèƒ½å½“é¥­åƒï¼Œä½ å·²ç»å¯ä»¥å…»æ´»ä¸‰ä¸ªçœäº†ã€‚',
            'ä½ ä¸ä»…å¥½çœ‹ï¼Œè¿˜è¿™ä¹ˆæœ‰å“å‘³â€”â€”è¿é€‰çš„è”ç³»äººéƒ½è¿™ä¹ˆæ£’ã€‚',
            'ä½ çš„å­˜åœ¨æœ¬èº«å°±æ˜¯ä¸–ç•Œçš„ç¾å¥½ä¹‹ä¸€ã€‚',
            'å’Œä½ èŠå¤©ï¼Œæˆ‘çš„å¿ƒæƒ…å€¼+10086ã€‚',
        ];
        return praises[Math.floor(Math.random() * praises.length)];
    }

    // ----- 6. è®¡ç®—ï¼ˆå¸¦emojiï¼‰-----
    const addMatch = message.match(/(\d+)\s*[+åŠ ]\s*(\d+)/);
    if (addMatch) return `${addMatch[1]} + ${addMatch[2]} = ${parseInt(addMatch[1]) + parseInt(addMatch[2])} ğŸ§®`;
    const subMatch = message.match(/(\d+)\s*[-å‡]\s*(\d+)/);
    if (subMatch) return `${subMatch[1]} - ${subMatch[2]} = ${parseInt(subMatch[1]) - parseInt(subMatch[2])} ğŸ§®`;
    const mulMatch = message.match(/(\d+)\s*[*Ã—ä¹˜]\s*(\d+)/);
    if (mulMatch) return `${mulMatch[1]} Ã— ${mulMatch[2]} = ${parseInt(mulMatch[1]) * parseInt(mulMatch[2])} ğŸ§®`;
    const divMatch = message.match(/(\d+)\s*[/Ã·]\s*(\d+)/);
    if (divMatch) {
        const divisor = parseInt(divMatch[2]);
        if (divisor === 0) return 'é™¤æ•°ä¸èƒ½ä¸º0å•¦ï½';
        return `${divMatch[1]} Ã· ${divMatch[2]} = ${(parseInt(divMatch[1]) / divisor).toFixed(2)} ğŸ§®`;
    }

    // ----- 7. è‡ªæˆ‘ä»‹ç»ï¼ˆæ›´èŒï¼‰-----
    if (lowerMsg.includes('ä½ å«ä»€ä¹ˆ') || lowerMsg.includes('ä½ æ˜¯è°') || lowerMsg.includes('ä½ çš„åå­—')) {
        return 'æˆ‘å«æœ¨æœ¨ğŸŒ³ï¼Œæ˜¯ä½ çš„æ™ºèƒ½å°åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼';
    }
    if (lowerMsg.includes('ä½ ä¼šä»€ä¹ˆ') || lowerMsg.includes('ä½ èƒ½åšä»€ä¹ˆ') || lowerMsg.includes('ä½ æœ‰ä»€ä¹ˆåŠŸèƒ½')) {
        return 'æˆ‘ä¼šæŠ¥æ—¶ã€æŸ¥å¤©æ°”ã€è®²ç¬‘è¯ã€åœŸå‘³æƒ…è¯ã€å½©è™¹å±ï¼Œè¿˜ä¼šç®€å•è®¡ç®—ï½å¦‚æœéœ€è¦è”ç½‘AIï¼Œå¯ä»¥åœ¨è®¾ç½®é‡Œå¼€å¯å“¦âœ¨';
    }
    if (lowerMsg.includes('ä½ å–œæ¬¢ä»€ä¹ˆ')) {
        return 'æˆ‘å–œæ¬¢å’Œä½ èŠå¤©å‘€ï¼ğŸ¥°';
    }
    if (lowerMsg.includes('ä½ å‡ å²') || lowerMsg.includes('ä½ å¤šå¤§äº†')) {
        return 'æˆ‘æ˜¯ç”±0å’Œ1ç»„æˆçš„ï¼Œä½ ä¸è®¸çŒœï½ğŸ˜‰';
    }

    // ----- 8. è¶£å‘³å°ç©æ„-----
    if (lowerMsg.includes('ç¡¬å¸') || lowerMsg.includes('æŠ›ç¡¬å¸') || lowerMsg.includes('æŠ•å¸')) {
        return 'ğŸª™ æŠ•ç¡¬å¸ç»“æœï¼š' + (Math.random() < 0.5 ? 'æ­£é¢' : 'åé¢');
    }
    if (lowerMsg.includes('éšæœºæ•°') || lowerMsg.includes('éšæœºæ•°å­—')) {
        return 'ğŸ² éšæœºæ•°ï¼š' + Math.floor(Math.random() * 100);
    }
    if (lowerMsg.includes('ä»Šå¤©è¿åŠ¿') || lowerMsg.includes('è¿æ°”')) {
        const fortunes = ['å¤§å‰ğŸŒŸ', 'å‰âœ¨', 'ä¸­å‰ğŸŒ¿', 'å°å‰ğŸŒ¸', 'æœ«å‰ğŸ‚', 'å‡¶ğŸŒ§ï¸', 'å¤§å‡¶âš¡'];
        return 'ä»Šæ—¥è¿åŠ¿ï¼š' + fortunes[Math.floor(Math.random() * fortunes.length)];
    }
    if (lowerMsg.includes('æŠ½ç­¾') || lowerMsg.includes('æ±‚ç­¾')) {
        const signs = ['ä¸Šä¸Šç­¾', 'ä¸Šç­¾', 'ä¸­ç­¾', 'ä¸‹ç­¾', 'ä¸‹ä¸‹ç­¾'];
        return 'ä½ æŠ½åˆ°äº†ï¼š' + signs[Math.floor(Math.random() * signs.length)] + 'ï¼';
    }

    // æ²¡æœ‰åŒ¹é…ä»»ä½•è§„åˆ™ â†’ è¿”å› nullï¼Œè®©ç³»ç»Ÿèµ°åç»­é€»è¾‘ï¼ˆAPI æˆ– é»˜è®¤å›å¤ï¼‰
    return null;
}

    // ---------- ğŸ†• ä¿®æ”¹åçš„ sendMsgï¼Œé›†æˆæœ¬åœ°æ™ºèƒ½å›å¤ ----------
    async function sendMsg() {
        const input = document.getElementById('chat-in');
        const val = input.value.trim();
        if (!val) return;

        if (!currentChatContactId) {
            alert('è¯·å…ˆä»é€šè®¯å½•é€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
            return;
        }

        const timeStr = getCurrentTimeString();
        
        // æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯åˆ°ç•Œé¢
        append('mine', val, timeStr);
        
        // ä¿å­˜è‡ªå·±çš„æ¶ˆæ¯
        if (!messages[currentChatContactId]) {
            messages[currentChatContactId] = [];
        }
        messages[currentChatContactId].push({ 
            side: 'mine', 
            text: val, 
            time: timeStr 
        });
        localStorage.setItem('m_messages', JSON.stringify(messages));

        input.value = '';

        // --- ğŸ†• å…ˆå°è¯•æœ¬åœ°æ™ºèƒ½å›å¤ ---
        const localReply = getLocalReply(val);
        if (localReply) {
            const replyTime = getCurrentTimeString();
            append('other', localReply, replyTime);
            // ä¿å­˜æœ¬åœ°å›å¤åˆ°æ¶ˆæ¯è®°å½•
            if (!messages[currentChatContactId]) {
                messages[currentChatContactId] = [];
            }
            messages[currentChatContactId].push({ 
                side: 'other', 
                text: localReply, 
                time: replyTime 
            });
            localStorage.setItem('m_messages', JSON.stringify(messages));
            return; // ç›´æ¥è¿”å›ï¼Œä¸å†è°ƒç”¨APIæˆ–ç¦»çº¿æç¤º
        }

        // --- å¦‚æœæ²¡æœ‰æœ¬åœ°åŒ¹é…ï¼Œå†åˆ¤æ–­æ˜¯å¦èµ°APIæˆ–ç¦»çº¿æ¨¡å¼ ---
        if (!apiCfg.enabled) {
    setTimeout(() => {
        // ğŸ‰ è¶£å‘³é»˜è®¤å›å¤åº“
        const funReplies = [
            "å—¯å—¯ï¼Œæˆ‘åœ¨å¬ï½(å¯å»è®¾ç½®å¼€å¯AIè®©æˆ‘æ›´èªæ˜âœ¨)",
            "æ”¶åˆ°å•¦ï¼å¦‚æœå¼€å¯è”ç½‘AIï¼Œæˆ‘èƒ½å›ç­”æ›´å¤šé—®é¢˜å“¦ğŸ“¡",
            "å½“å‰æ˜¯æœ¬åœ°å°è„‘ç“œï½å»è®¾ç½®é‡Œæ‰“å¼€AIå¼€å…³ï¼Œæˆ‘å°±èƒ½è”ç½‘å•¦ï¼",
            "ä½ çš„æ¶ˆæ¯æˆ‘æ”¶åˆ°äº†ï½éœ€è¦æˆ‘å¸®ä½ æŸ¥ç‚¹ä»€ä¹ˆå—ï¼Ÿï¼ˆç›®å‰ç¦»çº¿æ¨¡å¼ï¼‰",
            "ğŸ“¬ æ¶ˆæ¯é€è¾¾ï¼ç¦»çº¿æ¨¡å¼ä¸‹æˆ‘åªèƒ½ç®€å•åº”ç­”ï¼Œå¼€å¯AIä¼šæ›´å¼ºï½",
            "æˆ‘åœ¨æˆ‘åœ¨ï¼æƒ³èŠç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ(ç¦»çº¿æ¨¡å¼ing)",
            "å˜˜ï½æˆ‘åœ¨æ€è€ƒäººç”Ÿâ€¦â€¦ï¼ˆå…¶å®ç¦»çº¿æ¨¡å¼åªèƒ½å–èŒï¼‰ğŸ˜",
            "æ”¶åˆ°ï¼è¦ä¸è¦è¯•è¯•é—®æˆ‘å‡ ç‚¹ã€å¤©æ°”ã€æˆ–è€…è®²ä¸ªç¬‘è¯ï¼Ÿ",
            "ä½ çš„æ¶ˆæ¯åƒä¸€é¢—ç³–ï¼Œç”œåˆ°æˆ‘äº†ğŸ¬ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰"
        ];
        const reply = funReplies[Math.floor(Math.random() * funReplies.length)];
        const replyTime = getCurrentTimeString();
        append('other', reply, replyTime);
        // ä¿å­˜æ¶ˆæ¯ï¼ˆåŸæ ·ä¿ç•™ï¼‰
        if (!messages[currentChatContactId]) {
            messages[currentChatContactId] = [];
        }
        messages[currentChatContactId].push({ 
            side: 'other', 
            text: reply, 
            time: replyTime 
        });
        localStorage.setItem('m_messages', JSON.stringify(messages));
    }, 600);
    return;
}

        // --- å¼€å¯äº†APIï¼Œä½†æœ¬åœ°æ— åŒ¹é…ï¼Œè°ƒç”¨è¿œç¨‹API ---
        const tempBubble = append('other', "...", timeStr);

        try {
            const res = await fetch(apiCfg.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiCfg.key}`
                },
                body: JSON.stringify({
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [
                        { role: "system", content: "ä½ å«æœ¨æœ¨ï¼Œæ¸©æŸ”ç®€ç»ƒã€‚" },
                        { role: "user", content: val }
                    ]
                })
            });
            const data = await res.json();
            const replyText = data.choices[0].message.content;
            const replyTime = getCurrentTimeString();
            
            tempBubble.querySelector('span').textContent = replyText;
            tempBubble.querySelector('.msg-time').textContent = replyTime;
            
            // ä¿å­˜AIå›å¤
            if (!messages[currentChatContactId]) {
                messages[currentChatContactId] = [];
            }
            messages[currentChatContactId].push({ 
                side: 'other', 
                text: replyText, 
                time: replyTime 
            });
            localStorage.setItem('m_messages', JSON.stringify(messages));
        } catch (e) {
            const errorTime = getCurrentTimeString();
            tempBubble.querySelector('span').textContent = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚";
            tempBubble.querySelector('.msg-time').textContent = errorTime;
        }
    }

    // ==================== äº‹ä»¶ç›‘å¬ç»Ÿä¸€ç»‘å®š ====================
    function bindEvents() {
        document.querySelectorAll('.app-item[data-page]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.page); });
        });
        document.querySelectorAll('.nav-back[data-home]').forEach(el => {
            el.addEventListener('click', function() { to(this.dataset.home); });
        });
        document.querySelectorAll('.nav-setting[data-mod], .nav-add[data-mod]').forEach(el => {
            el.addEventListener('click', function() { openMod(this.dataset.mod); });
        });
        document.getElementById('upload-trigger')?.addEventListener('click', function() {
            document.getElementById('up').click();
        });
        document.getElementById('send-btn')?.addEventListener('click', sendMsg);
        document.getElementById('chat-in')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });
        document.querySelectorAll('.modal-cancel').forEach(el => {
            el.addEventListener('click', function() { closeMod(this.dataset.mod); });
        });
        document.getElementById('save-api-btn')?.addEventListener('click', saveApi);
        document.getElementById('save-anni-btn')?.addEventListener('click', saveAnni);
        document.getElementById('save-con-btn')?.addEventListener('click', saveCon);
        document.getElementById('set-wallpaper-btn')?.addEventListener('click', setWallpaper);
        document.getElementById('close-viewer-btn')?.addEventListener('click', closeViewer);

        // çºªå¿µæ—¥åˆ é™¤
        document.getElementById('anni-list')?.addEventListener('click', function(e) {
            const delBtn = e.target.closest('.del-text');
            if (!delBtn) return;
            const item = delBtn.closest('.list-item');
            if (!item) return;
            const id = item.dataset.anniId;
            if (id) delAnni(id);
        });

        // é€šè®¯å½•ï¼šè¿›å…¥èŠå¤©
        document.getElementById('con-list')?.addEventListener('click', function(e) {
            const item = e.target.closest('.list-item');
            if (!item) return;
            const id = item.dataset.conId;
            if (!id) return;

            if (e.target.classList.contains('del-text')) {
                e.stopPropagation();
                delCon(id);
                return;
            }

            const contact = cons.find(c => c.id === id);
            const name = contact ? contact.name : 'è”ç³»äºº';
            
            currentChatContactId = id;
            document.getElementById('chat-title').textContent = name;
            
            document.getElementById('chat-flow').innerHTML = '';
            
            if (messages[id]) {
                messages[id].forEach(msg => {
                    append(msg.side, msg.text, msg.time || '');
                });
            }
            
            to('p-chat');
        });

        // ç›¸å†Œç‚¹å‡»æŸ¥çœ‹
        document.getElementById('album-box')?.addEventListener('click', function(e) {
            const thumb = e.target.closest('[data-imgId]');
            if (thumb) viewImg(thumb.dataset.imgId);
        });
    }

    // ==================== å®æ—¶æ—¶é’Ÿ ====================
    function updateClock() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('st-time').innerText = timeStr;
        document.getElementById('big-clock').innerText = timeStr;
        document.getElementById('big-date').innerText = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' });

        const hour = now.getHours();
        const isNight = hour >= 18 || hour < 6;
        document.getElementById('p-home').style.color = isNight ? "#fff" : "#000";
        document.getElementById('status-bar').style.color = isNight ? "#fff" : "#000";
    }

    // ==================== å¯åŠ¨ä¸€åˆ‡ ====================
    (async function init() {
        await openDB();
        photos = JSON.parse(localStorage.getItem('m_photos') || '[]');
        
        wallpaperId = localStorage.getItem('m_wallpaper_id');
        await applyWallpaper();
        
        bindEvents();
        setInterval(updateClock, 1000);
        updateClock();
        await renderAll();
        renderCalendar();
    })();
</script>
</body>
</html>
